---
title: "Tracegram pilot"
author: "Stefano Coretta"
date: "22 December 2017"
output: 
  html_document: 
    highlight: tango
    number_sections: yes
    theme: readable
  pdf_document: 
    fig_caption: yes
    latex_engine: xelatex
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_knit$set(root.dir = normalizePath("../../"))
library(tidyverse)
theme_set(theme_bw())
library(lmerTest)
library(effects)
```

# Data import

```{r data}
degg_tracing <- read_csv("./tracegram-pilot/results/results.csv") %>%
    separate(file, c("speaker", "phonation")) %>%
    mutate_if(is.character, as.factor) %>%
    mutate(phonation = factor(phonation, levels = c("modal", "breathy"))) %>%
    gather(peak, value, degg_maximum:degg_minimum) %>%
    group_by(speaker) %>%
    mutate(value_norm = scale(value)) %>%
    ungroup()
    
mean_degg_tracing <- read_csv("./tracegram-pilot/results/results.csv") %>%
    separate(file, c("speaker", "phonation")) %>%
    mutate_if(is.character, as.factor) %>%
    mutate(
        phonation = factor(phonation, levels = c("modal", "breathy")),
        mean_degg = (degg_maximum + degg_minimum) / 2
    ) %>%
    group_by(speaker) %>%
    mutate(mean_degg_norm = scale(mean_degg)) %>%
    ungroup()

quotient <- read_csv("./tracegram-pilot/results/results.csv") %>%
    separate(file, c("speaker", "phonation")) %>%
    mutate_if(is.character, as.factor) %>%
    mutate(phonation = factor(phonation, levels = c("modal", "breathy")),
           closed_quotient = degg_minimum - degg_maximum
           )

quotient_mean <- quotient %>%
    group_by(speaker, phonation, token) %>%
    summarise(mean_quotient = mean(closed_quotient))

mean_degg_tracing_mean <- mean_degg_tracing %>%
    group_by(speaker, phonation, token) %>%
    summarise(mean_degg_mean = mean(mean_degg))
```

# dEGG maxima and minima

```{r degg-boxplot}
ggplot(degg_tracing, aes(peak, value, colour = phonation)) +
    geom_boxplot() +
    facet_wrap(~ speaker) +
    ylim(0, 1)
```

03 does not show much difference, although the two phonations sound different.

```{r degg-violin}
ggplot(degg_tracing, aes(peak, value, colour = phonation)) +
    geom_violin() +
    facet_wrap(~ speaker) +
    ylim(0, 1)
```

# Tracegram plot

```{r speaker-tracegram-plot}
ggplot(degg_tracing, aes(time, value, colour = peak)) +
    geom_point(size = 0.5, alpha = 0.1) +
    geom_smooth(size = 0.5, method = "lm") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    facet_grid(speaker ~ phonation) +
    ylim(0, 1)
```

Here 03 shows a shift upwards, although it seems that the CQ is more or less the same.

```{r tracegram-plot}
ggplot(degg_tracing, aes(time, value, colour = peak)) +
    geom_point(size = 0.5, alpha = 0.1) +
    geom_smooth(size = 0.5, method = "loess") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    facet_grid(. ~ phonation)
```

On average, breathy voice has higher maximum and minimum, and they are close to each other (lower CQ = higher OQ = breathiness).

```{r norm-tracegram-plot}
ggplot(degg_tracing, aes(time, value_norm, colour = peak)) +
    geom_point(size = 0.5, alpha = 0.1) +
    geom_smooth(size = 0.5, method = "lm") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    facet_grid(. ~ phonation)
```

Same as before, but the dEGG values have been normalised within speaker.

# Mean dEGG

```{r speaker-mean-tracegram-plot}
ggplot(mean_degg_tracing, aes(time, mean_degg, colour = phonation)) +
    geom_point(size = 0.5, alpha = 0.1) +
    geom_smooth(size = 0.5, method = "lm") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    facet_wrap(~ speaker) +
    ylim(0, 1)
```

Mean dEGG cannot accout for concomitant symmettric increase and decrise of minimum and maximum: the mean stays the same.

```{r mean-tracegram-plot}
ggplot(mean_degg_tracing, aes(time, mean_degg, colour = phonation)) +
    geom_point(size = 0.5, alpha = 0.1) +
    geom_smooth(size = 0.5, method = "lm") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    ylim(0, 1)
```

```{r norm-mean-tracegram-plot}
ggplot(mean_degg_tracing, aes(time, mean_degg_norm, colour = phonation)) +
    geom_point(size = 0.5, alpha = 0.1) +
    geom_smooth(size = 0.5, method = "lm") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    ylim(0, 1)
```

```{r boxplot-mean-degg}
mean_degg_tracing %>%
    ggplot(aes(phonation, mean_degg)) +
    geom_boxplot()
```

# Closed quotient

```{r cq-density}
ggplot(quotient, aes(closed_quotient, colour = phonation)) +
    geom_density() +
    facet_wrap(~ speaker)
```

The CQ does not perform well.

```{r speaker-cq-boxplot}
ggplot(quotient, aes(phonation, closed_quotient)) +
    geom_boxplot() +
    facet_wrap(~ speaker)
```

In 03, the median is higher for breathy voice (should be lower).

```{r cq-boxplot}
ggplot(quotient, aes(phonation, closed_quotient)) +
    geom_boxplot()
```

```{r cq-plot}
ggplot(quotient, aes(time, closed_quotient, colour = speaker)) +
    geom_point(alpha = 0.2) +
    facet_grid(phonation ~ .)
```

```{r cq-plot-2}
filter(quotient, token == 1) %>%
ggplot(aes(time, closed_quotient, colour = phonation)) +
    geom_point(alpha = 0.2) +
    geom_smooth(method = "lm") +
    facet_grid(. ~ speaker)
```

# Comparison

```{r quotient-lmer}
quotient_lmer <- lmer(
    closed_quotient ~
        phonation +
        (1 + phonation|speaker),
    data = quotient
)

summary(quotient_lmer)
```

```{r quotient-likelyhood}
quotient_lmer_null <- lmer(
    closed_quotient ~
        (1 + phonation|speaker),
    data = quotient
)

anova(quotient_lmer_null, quotient_lmer)
```

The CQ does not perform well in the lmer.

```{r quotient-lmer-effects}
plot(allEffects(quotient_lmer))
```

```{r quotient-lmer-random-coefficients}
coefficients(quotient_lmer)$speaker
```

```{r mean-quotient-lmer}
mean_quotient_lmer <- lmer(
    mean_quotient ~
        phonation +
        (1 + phonation|speaker),
    data = quotient_mean
)

summary(mean_quotient_lmer)
```

```{r mean-degg-lmer}
mean_degg_lmer <- lmer(
    mean_degg ~
        phonation +
        (1 + phonation|speaker),
    data = mean_degg_tracing
)

summary(mean_degg_lmer)

mean_degg_lmer_null <- lmer(
    mean_degg ~
        (1 + phonation|speaker),
    data = mean_degg_tracing
)

anova(mean_degg_lmer_null, mean_degg_lmer)
```

The mean dEGG performs well here.
