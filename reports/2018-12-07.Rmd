---
title: "17 December 2018"
author: "Stefano Coretta"
date: "12/12/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = normalizePath("../"))
library(tidyverse)
theme_set(theme_minimal())
library(mgcv)
library(itsadug)
library(tidymv)
library(akima)
library(TTR)
library(coretta2018itaegg)
library(lme4)
library(lmerTest)
library(sjPlot)
```

# 3D tongue surface of [s] and [z]

```{r tongue-data, message=FALSE}
read_tongue <- function(file) {
  tibble <- read_csv(file, col_names = c("X", "Y", "Z")) %>%
    mutate(file = substr(file, 26, 43))
  
  tibble <- mutate(tibble, index = seq(1, nrow(tibble)))
  
  return(tibble)
}

stimuli <- read_csv("./italian-sz/data/stimuli.csv")

tongue <- list.files(
  path = "italian-sz/data/datasets",
  pattern = "*.csv",
  full.names = TRUE
) %>%
  map_df(~read_tongue(.)) %>%
  left_join(y = stimuli) %>%
  mutate(phone = ordered(phone, levels = c("s", "z"))) %>%
  mutate_if(is.character, as.factor) %>%
  create_event_start("file")

contrasts(tongue$phone) <- "contr.treatment"
```

```{r tongue-gam, cache=TRUE}
tongue_gam_3 <- bam(
  Z ~
    phone +
    s(X, Y) +
    s(X, Y, by = phone),
  data = tongue
)

rho <- start_value_rho(tongue_gam_3)

gam_ar <- bam(
  Z ~
    phone +
    s(X, Y) +
    s(X, Y, by = phone),
  data = tongue,
  AR.start = tongue$start.event,
  rho = rho
)
```

I recorded myself in Bloomington with the 3D ultrasound machine while uttering five tokens of sustained [s] and five tokens of sustained [z].
A single 3D frame has been extracted from each token.
The following plots show the output of a 3D GAM fitted to the tongue surfaces of [s] and [z].

```{r gam-ar-plot-1, warning=FALSE}
vis.gam(gam_ar, view = c("X", "Y"), theta = 0, phi = 50, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", too.far = .05)
```

```{r gam-ar-plot-2, warning=FALSE}
vis.gam(gam_ar, view = c("X", "Y"), theta = 0, phi = 50, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", too.far = .05)
```

There is a shallower grove in [z] compared to [s], and some lowering/advancing of the tongue root.
Note that the tongue data have not been rotated.

## Volume increase

```{r volume, cache=TRUE}
x_min <- min(tongue$X)
x_max <- max(tongue$X)
y_min <- min(tongue$Y)
y_max <- max(tongue$Y)

# File is needed in the grid for midsagittal data (it groups by file)
grid <- expand.grid(X = seq(x_min, x_max, length = 100), Y = seq(y_min, y_max, length = 100), file = levels(tongue$file))
grid <- cbind(grid, phone = rep(rep(c("s", "z"), each = 10000), 5))

predicted <- predict(gam_ar, newdata = grid)
predicted_df <- cbind(grid, predicted) %>%
  dplyr::select(-file) %>%
  unique() %>%
  spread(phone, predicted) %>%
  mutate(
    difference = s - z
  )

sum_diff <- sum(predicted_df$difference)
volume_diff <- sum_diff * (x_max - x_min)/100 * (y_max - y_min)/100

interp_data <- interp(tongue$X, tongue$Y, tongue$Z, xo = seq(x_min, x_max, length = 100), yo = seq(y_min, y_max, length = 100), duplicate = "mean")

interp_m <- interp_data$z
interp_m <- ifelse(!is.na(interp_m), 1, 0)

predicted_df_2 <- predicted_df
predicted_df_2$mask <- as.vector(t(interp_m))

predicted_df_2 <- predicted_df_2 %>%
  mutate(diff_2 = difference * mask)

sum_diff_2 <- sum(predicted_df_2$diff_2)
volume_diff_2 <- sum_diff_2 * (x_max - x_min)/100 * (y_max - y_min)/100
```

The volume increase of [z] relative to [s] is `r round(volume_diff_2, 2)` cm^3.
This estimate is based on the predicted GAM data on a surface which corresponds to the actual imaged surface.
If I remember correctly, Steven Lulich estimated that a volume increase of 20 cm^3 is ideal for maintainance of voicing in a voiced fricative.

# Italian EGG: vowel and voicing duration

```{r egg-data, message=FALSE}
data("ita_egg")
ita_egg <- ita_egg %>%
  mutate(
    vowel = factor(vowel, levels = c("a", "o", "e", "i", "u")),
    height = factor(height, levels = c("low", "mid-low", "mid-high", "high")),
    c1_place = factor(c1_place, levels = c("labial", "coronal", "velar")),
    c2_place = factor(c2_place, levels = c("labial", "coronal", "velar")),
    von_von = (v1_ons - voice_ons) * 1000
  ) %>%
  mutate_if(is.character, as.factor)
```

