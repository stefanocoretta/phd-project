---
title: "Voicing Effect project procedure"
author: "Stefano Coretta"
date: "19/12/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
knitr::opts_knit$set(root.dir = normalizePath("../../"))
library(tidyverse)
library(speakr)
library(beepr)
```

## Tangle code

```{r tangle}
lmt("./voicing-effect/code/process.praat.md")
```

## Ultrasound data

1. **Export** `.wav` and `.txt` from `AAA` to `data/ultrasound/derived/[ID]/recordings/` folder ([ID] = participant ID) as [ID]-nnn.wav
1. **Force alignment and search area**
    1. Run `alignment-input.praat`: the output is a concatenated `.wav` file and a `.txt` file listing the stimuli, written in `data/ultrasound/derived/[ID]/concatenated/`
    1. Make sure the `.txt` contains "Mowie" (unicode safe because of AAA)
    1. **WARNING OVERWRITE** Run SPPAS on concatenated `.wav` and `.txt`
    1. Check alignment and save it to `data/ultrasound/raw/corrected-palign/`
    1. Run `search-area.praat`: the output is TextGrid files for each `AAA` `.wav` file, saved in `data/ultrasound/derived/[ID]/recordings/`, and a merged TextGrid, saved in `data/ultrasound/derived/[ID]/concatenated/`
        1. **NOTE**: Needed for EGG processing!
    1. Run `closure-annotation.praat`: it reads the search area chunks and adds a tier for the time of closure onset
    1. Import TextGrids back in `AAA`

```{r search-area}
speakers <- c(
  "it01", "it02", "it03", "it07", "it09", "it11", "it12", "it13", "it14",
  "pl02", "pl03", "pl04", "pl05", "pl06", "pl07"
)
languages <- c(
  "it", "it", "it", "it", "it", "it", "it", "it","it",
  "pl", "pl", "pl", "pl", "pl", "pl"
)

for (i in 1:length(speakers)) {
  praat_run(
    "./voicing-effect/code/search-area.praat",
    "voicing-effect",
    speakers[i],
    languages[i]
  )
}

for (i in 1:length(speakers)) {
  praat_run(
    "./voicing-effect/code/closure-annotation.praat",
    "voicing-effect",
    speakers[i],
    languages[i]
  )
}
```

1. **Tongue tracking**
    1. Create a spline template for the speaker and save it (`.fst`)
    1. Batch process splines with template
    1. Check splines
    1. (Batch process snap-to-fit)
1. **Calculate kinematics**
    1. Check relevant fan lines for Tongue Dorsum, Tongue Tip, and Tongue Root
    1. Load `AnaVal-[ID].avl` from `Edit values` and change fan lines numbers (Save it for the future)
    1. Calculate Maths for entire session
1. **Find consonantal gestures**
    1. Select TD stimuli
    1. `Find...` > `Load` and `execute` `td_function.srh`
    1. `Find...` > `Load` and `execute` `find_gons_td.srh`
    1. Select TT stimuli
    1. `Find...` > `Load` and `execute` `tt_function.srh`
    1. `Find...` > `Load` and `execute` `find_gons_tt.srh`
1. **Export data** in `datasets/ultrasound/` folder
    1. `Export-tongue-cart.xsu`: export cartesian coordinates, tongue tip/dorsum/root smoothed displacement, velocity and absolute velocity at peaks, nucleus onset and offset, gesture onset, closure onset, and maximum (Annotation: "_"), `[ID]-tongue-cart.tsv`
    1. `Export-vowel-series.xsu`: export cartesian coordinates, tongue tip/dorsum/root smoothed displacement, velocity and absolute velocity for every frame within the vowel (Annotation: "\^[aoOu]$"), `[ID]-vowel-series.tsv`
1. **Export kinematics annotations** (from `Export > Files...`) in `data/derived/ultrasound/[ID]/kinematics` folder as `[ID].TextGrid`
1. **Burst detection**
    1. Run `burst-detection.praat`: the output is a `.TextGrid` file, written in `data/ultrasound/derived/[ID]/concatenated/`
    1. Check bursts `[ID]-burst.TextGrid` + `[ID].wav`
1. **C1 release detection**
    1. Run `release-detection-c1.praat`: the output is a `.TextGrid` file, written in `data/ultrasound/derived/[ID]/concatenated/`
    1. Check bursts `[ID]-realease-c1.TextGrid` + `[ID].wav`

```{r release-c1}
speakers <- c(
  "it01", "it02", "it03", "it04", "it05", "it07", "it09", "it11", "it12", "it13", "it14",
  "pl02", "pl03", "pl04", "pl05", "pl06", "pl07"
)
languages <- c(
  "it", "it", "it", "it", "it", "it", "it", "it", "it", "it","it",
  "pl", "pl", "pl", "pl", "pl", "pl"
)

for (i in 1:length(speakers)) {
    praat_run(
        "./voicing-effect/code/release-detection-c1.praat",
        speakers[i],
        languages[i]
    )
}
```

1. **Get durations and formants**
    1. Run `get-durations.praat`: the output is written in the `results` folder
   
```{r get-durations}
speakers <- c(
  "it01", "it02", "it03", "it04", "it05", "it07", "it09", "it11", "it12", "it13", "it14",
  "pl02", "pl03", "pl04", "pl05", "pl06", "pl07"
)
languages <- c(
  "it", "it", "it", "it", "it", "it", "it", "it","it", "it", "it",
  "pl", "pl", "pl", "pl", "pl", "pl"
)

for (i in 1:length(speakers)) {
    praat_run(
        "./voicing-effect/code/get-durations.praat",
        "voicing-effect",
        speakers[i],
        languages[i]
    )
}
```

```{r get-formants}
sex <- c(
  "m", "m", "f", "f", "f", "m", "f", "m", "m", "f", "m",
  "f", "m", "f", "m", "m", "f"
)

for (i in 1:length(speakers)) {
    praat_run(
        "./voicing-effect/code/get-formants.praat",
        speakers[i],
        sex[i]
    )
}
```


## EGG data

1. **Synchronise** EGG with `sync-egg.praat`: the output is written in `data/egg/derived/[ID]/`
1. **Extract vuv** (Voiced/UnVoiced) with `extract-vuv.praat`: the output is written in the same folder as above
1. **Calculate dEGG tracegrams** with `degg-tracing.praat`: the results are written in `data/datasets/egg/`
1. **Extract wavegram data** with `wavegram.praat`.

```{r sync-vuv-degg-wavegram}
speakers <- c(
  "it01", "it02", "it03", "it07", "it09", "it11", "it12", "it13", "it14",
  "pl02", "pl03", "pl04", "pl05", "pl06", "pl07"
)

for (i in 1:length(speakers)) {
    praat_run(
        "./voicing-effect/code/sync-egg.praat",
        "voicing-effect",
        speakers[i],
        0
    )
}

for (i in 1:length(speakers)) {
    praat_run(
        "./voicing-effect/code/extract-vuv.praat",
        "voicing-effect",
        speakers[i],
        40,
        10000,
        11,
        0
    )
}

for (i in 1:length(speakers)) {
    praat_run(
        "./voicing-effect/code/degg-tracing.praat",
        "voicing-effect",
        speakers[i],
        40,
        10000,
        11
    )
}

for (i in 1:length(speakers)) {
    praat_run(
        "./voicing-effect/code/wavegram.praat",
        speakers[i]
    )
}

beep()
```

1. **Calculate measurements** from ultrasound and EGG annotations with `get-measurements.praat`: the resulting TextGrids are written in `/data/derived/merged/[ID]` and the measurements in `results` to the file `[ID]-measurements.csv`

```{r get-measurements}
praat_run(
    "./voicing-effect/code/get-measurements.praat",
    speaker
)
```

```{r voicing-duration}
speakers <- c(
  "it01", "it02", "it03", "it07", "it09", "it11", "it12", "it13", "it14",
  "pl02", "pl03", "pl04", "pl05", "pl06", "pl07"
)

for (i in 1:length(speakers)) {
  praat_run("./voicing-effect/code/voicing-duration.praat", speakers[i])
}
```


## `AAA` files extensions
* `.esu`: tabs in the main window
* `.fst`: fans template
* `.avl`: analysis values chart
* `.srh`: search analysis value
* `.xsu`: export settings
