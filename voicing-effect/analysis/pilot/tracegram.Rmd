---
title: "Tracegram analysis"
author: "Stefano Coretta"
date: "\\today"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 3.5
    fig_width: 5
    latex_engine: xelatex
    number_sections: yes
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir=normalizePath("../../"))
library(purrr)
library(readr)
library(tidyr)
library(tidyverse)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(gss)
library(stringr)
library(gamm4)
library(mgcv)
library(itsadug)
```

# Data import

First, we import all `degg-tracing` files contained in the `results` folder into the `degg` data frame, and we merge with `languages` and `words` (the first data frame list the languages of each participant, the latter the variables for each word). Two separate data frames for Italian and Polish are then created.

```{r import}
degg <- list.files(path = "./voicing-effect/results",
                   pattern = "*-degg-tracing.csv",
                   full.names = TRUE) %>%
    map_df(~read_csv(.))

languages <- read_csv("./voicing-effect/stimuli/languages.csv")
words <- read_csv("./voicing-effect/stimuli/nonce.csv")

degg <- degg %>%
    left_join(y = languages) %>%
    left_join(y = words) %>%
    filter(c1phonation == "voiceless") %>%
    mutate_if(is.character, as.factor)

degg.it <- filter(degg, language == "italian")
degg.pl <- filter(degg, language == "polish")
```

# Plotting

We can now plot smoothers for DEGG maxima and minima for both languages. The *x*-axis shows the normalised time as a proportion of the vowel duration, while values on the *y*-axix indicates the proportion of the glottal period at *x* time. The lines in the lower half of the graphs are the DEGG maxima, while the lines in the upper half are the minima. The second half of the vowel proportion contains information important for the effects of the phonation of the consonant following the vowel.

```{r tracegram}
ggplot(degg, aes(x = proportion, colour = c2phonation)) +
    facet_grid(. ~ language + speaker) +
    geom_smooth(aes(y = maximum), size = 0.5, alpha = 0.2) +
    geom_smooth(aes(y = minimum), size = 0.5, alpha = 0.2) +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    xlim(0.1, 0.9)
```

```{r tracegram-c2place}
ggplot(degg, aes(x = proportion, colour = c2phonation)) +
    facet_grid(speaker ~  c2place) +
    geom_smooth(aes(y = maximum), size = 0.5, alpha = 0.2) +
    geom_smooth(aes(y = minimum), size = 0.5, alpha = 0.2) +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    xlim(0, 1)
```

```{r maximum-boxplot-it}
ggplot(degg.it, aes(c2phonation, maximum)) +
    geom_boxplot() +
    facet_grid(. ~ speaker)
```

```{r maximum-boxplot-pl}
ggplot(degg.pl, aes(c2phonation, maximum)) +
    geom_boxplot() +
    facet_grid(. ~ speaker)
```

As it can be seen from the graph, both Italian and Polish show a raising profile of the DEGG maxima in the voiceless condition in the second half of the vowel (Polish data are a bit more messy, but can still be interpreted this way).

# SSANOVA

## Italian

We can now calculate the SSANOVA model for dEGG maxima and minima.

```{r ssanova-it}
maximum.model <- ssanova(maximum ~ c2phonation + proportion + c2phonation:proportion,
data = degg.it)

minimum.model <- ssanova(minimum ~ c2phonation + proportion + c2phonation:proportion,
data = degg.it)
```

And calculate the predicted splines based on the SSANOVA models.

```{r predict-it}
predicted.degg <- expand.grid(proportion = seq(min(degg.it$proportion), max(degg.it$proportion),
                                         length = 100),
                    c2phonation = c("voiced", "voiceless"))

predicted.degg$maximum.fit <- predict(maximum.model, predicted.degg, se = TRUE)$fit
predicted.degg$maximum.SE <- predict(maximum.model, predicted.degg, se = TRUE)$se.fit
predicted.degg$minimum.fit <- predict(minimum.model, predicted.degg, se = TRUE)$fit
predicted.degg$minimum.SE <- predict(minimum.model, predicted.degg, se = TRUE)$se.fit
```

Finally, we can plot the predicted splines for Italian with 95% confidence levels for significance evaluation.

```{r ssanova-it-plot}
ggplot(predicted.degg, aes(x = proportion, colour = c2phonation, group = c2phonation)) +
    geom_line(aes(y = maximum.fit), alpha = 1, colour = "grey20") +
    geom_ribbon(aes(ymin = maximum.fit-(1.96*maximum.SE),
                ymax = maximum.fit+(1.96*maximum.SE),
                fill = c2phonation ),alpha = 0.5,colour = "NA") +
    geom_line(aes(y = minimum.fit), alpha = 1, colour = "grey20") +
    geom_ribbon(aes(ymin = minimum.fit-(1.96*minimum.SE),
                    ymax = minimum.fit+(1.96*minimum.SE),
                    fill = c2phonation ),alpha = 0.5,colour = "NA") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    xlim(0, 1)
```

## Polish

```{r ssanova-pl}
maximum.model <- ssanova(maximum ~ c2phonation + proportion + c2phonation:proportion,
data = degg.pl)

minimum.model <- ssanova(minimum ~ c2phonation + proportion + c2phonation:proportion,
data = degg.pl)
```

And calculate the predicted splines based on the SSANOVA models.

```{r predict-pl}
predicted.degg <- expand.grid(proportion = seq(min(degg.pl$proportion), max(degg.pl$proportion),
                                         length = 100),
                    c2phonation = c("voiced", "voiceless"))

predicted.degg$maximum.fit <- predict(maximum.model, predicted.degg, se = TRUE)$fit
predicted.degg$maximum.SE <- predict(maximum.model, predicted.degg, se = TRUE)$se.fit
predicted.degg$minimum.fit <- predict(minimum.model, predicted.degg, se = TRUE)$fit
predicted.degg$minimum.SE <- predict(minimum.model, predicted.degg, se = TRUE)$se.fit
```

Finally, we can plot the predicted splines for Polish with 95% confidence levels for significance evaluation.

```{r ssanova-pl-plot}
ggplot(predicted.degg, aes(x = proportion, colour = c2phonation, group = c2phonation)) +
    geom_line(aes(y = maximum.fit), alpha = 1, colour = "grey20") +
    geom_ribbon(aes(ymin = maximum.fit-(1.96*maximum.SE),
                ymax = maximum.fit+(1.96*maximum.SE),
                fill = c2phonation ),alpha = 0.5,colour = "NA") +
    geom_line(aes(y = minimum.fit), alpha = 1, colour = "grey20") +
    geom_ribbon(aes(ymin = minimum.fit-(1.96*minimum.SE),
                    ymax = minimum.fit+(1.96*minimum.SE),
                    fill = c2phonation ),alpha = 0.5,colour = "NA") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period") +
    xlim(0, 1)
```

# GAMM

## Italian

### Maximum

```{r maximum-gam-it}
degg.ord <- degg %>%
    filter(language == "italian") %>%
    mutate(c2phonation.ord = as.ordered(c2phonation))
contrasts(degg.ord$c2phonation.ord) <- "contr.treatment"

maximum.gam <- bam(
    maximum ~
        c2phonation.ord +
        s(proportion, bs = "cr") +
        s(proportion, by = c2phonation.ord, bs = "cr"),
    data = degg.ord,
    method = "ML"
)

summary(maximum.gam)
```

```{r compare-maximum-it}
maximum.gam.null <- bam(
    maximum ~
        s(proportion, bs = "cr"),
    data = degg.ord,
    method = "ML"
)

summary(maximum.gam.null)

compareML(maximum.gam, maximum.gam.null)
```


```{r maximum-plot-smooth-it}
plot_smooth(maximum.gam, view = "proportion", plot_all = "c2phonation.ord", rug = FALSE)
```

```{r maximum-plot-difference-it}
plot_diff(maximum.gam, view="proportion", comp = list(c2phonation.ord = c("voiceless","voiced")))
```

### Minimum

```{r minimum-gam-it}
minimum.gam <- bam(
    minimum ~
        c2phonation.ord +
        s(proportion, bs = "cr") +
        s(proportion, by = c2phonation.ord, bs = "cr"),
    data = degg.ord
)

summary(minimum.gam)
```

```{r minimum-plot-smooth-it}
plot_smooth(minimum.gam, view = "proportion", plot_all = "c2phonation.ord", rug = FALSE)
```

```{r minimum-plot-difference-it}
plot_diff(minimum.gam, view="proportion", comp = list(c2phonation.ord = c("voiceless","voiced")))
```

# GAMM

## Polish

### Maximum

```{r maximum-gam-pl}
degg.ord <- degg %>%
    filter(language == "polish") %>%
    mutate(c2phonation.ord = as.ordered(c2phonation))
contrasts(degg.ord$c2phonation.ord) <- "contr.treatment"

maximum.gam <- bam(
    maximum ~
        c2phonation.ord +
        s(proportion, bs = "cr") +
        s(proportion, by = c2phonation.ord, bs = "cr"),
    data = degg.ord,
    method = "ML"
)

summary(maximum.gam)
```

```{r compare-maximum-pl}
maximum.gam.null <- bam(
    maximum ~
        s(proportion, bs = "cr"),
    data = degg.ord,
    method = "ML"
)

summary(maximum.gam.null)

compareML(maximum.gam, maximum.gam.null)
```


```{r maximum-plot-smooth-pl}
plot_smooth(maximum.gam, view = "proportion", plot_all = "c2phonation.ord", rug = FALSE)
```

```{r maximum-plot-difference-pl}
plot_diff(maximum.gam, view="proportion", comp = list(c2phonation.ord = c("voiceless","voiced")))
```

### Minimum

```{r minimum-gam-pl}
minimum.gam <- bam(
    minimum ~
        c2phonation.ord +
        s(proportion, bs = "cr") +
        s(proportion, by = c2phonation.ord, bs = "cr"),
    data = degg.ord
)

summary(minimum.gam)
```

```{r minimum-plot-smooth-pl}
plot_smooth(minimum.gam, view = "proportion", plot_all = "c2phonation.ord", rug = FALSE)
```

```{r minimum-plot-difference-pl}
plot_diff(minimum.gam, view="proportion", comp = list(c2phonation.ord = c("voiceless","voiced")))
```
