---
title: "Durations"
author: "Stefano Coretta"
date: "09/03/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../../"))
library(tidyverse)
theme_set(theme_minimal())
library(lme4)
library(effects)
```

# Data import

```{r read-data}
speakers <- read_csv("./voicing-effect/data/datasets/speakers.csv")
stimuli <- read_csv("./voicing-effect/data/datasets/stimuli.csv")

voicing <- voicing <- list.files(
  path = "voicing-effect/data/datasets/egg/",
  pattern = "*-voicing.csv",
  full.names = TRUE
) %>%
  map_df(~read_csv(., na = "--undefined--"))

duration <- list.files(
  path = "voicing-effect/data/datasets/acoustics/",
  pattern = "*-durations.csv",
  full.names = TRUE
) %>%
  map_df(~read_csv(., na = "--undefined--")) %>%
  left_join(y = voicing) %>%
  left_join(y = speakers) %>%
  left_join(y = stimuli) %>%
  filter(c1_phonation == "voiceless") %>%
  mutate(
    c2_phonation = factor(c2_phonation, levels = c("voiceless", "voiced")),
    c1_vot = (voicing_start - c1_rel) * 1000
  ) %>%
  mutate_if(is.character, as.factor)
```

# Plotting data

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(vowel_duration = scale(vowel_duration)) %>%
  ggplot(aes(vowel, vowel_duration)) +
  geom_boxplot() +
  facet_grid(~ language)
```

```{r}
duration %>%
  ggplot(aes(vowel, vowel_duration, fill = c2_phonation)) +
  geom_boxplot() +
  facet_wrap(~ speaker)
```

```{r}
duration %>%
  filter(vowel == "a") %>%
  ggplot(aes(speaker, vowel_duration, fill = c2_phonation)) +
  geom_boxplot()
```

```{r}
duration %>%
  filter(speaker == "pl05") %>%
  ggplot(aes(vowel, vowel_duration, fill = c2_phonation)) +
  geom_boxplot() +
  facet_grid(~ c2_place)
```

```{r}
duration %>%
  filter(speaker == "pl05") %>%
  ggplot(aes(vowel_duration, fill = c2_phonation)) +
  geom_density(alpha = 0.5, linetype = 0) +
  facet_grid(~ c2_place)
```

```{r}
duration %>%
  ggplot(aes(vowel_duration, colour = c2_phonation, fill = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(vowel ~ c2_place)
```

```{r}
duration %>%
  ggplot(aes(vowel, c1_rvot, fill = c2_phonation)) +
  geom_boxplot()
```

```{r}
duration %>%
  ggplot(aes(vowel, c1_closure, fill = c2_phonation)) +
  geom_boxplot()
```

## Closure duration

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(closure_duration = scale(closure_duration)) %>%
  ggplot(aes(vowel, closure_duration)) +
  geom_boxplot()
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(closure_duration = scale(closure_duration)) %>%
  ggplot(aes(vowel, closure_duration)) +
  geom_boxplot() +
  facet_grid(~ language)
```

```{r}
duration %>%
  ggplot(aes(c2_phonation, closure_duration)) +
  geom_boxplot() +
  facet_grid(~ language)
```

## Release to release

```{r rr-density}
duration %>%
  group_by(speaker) %>%
  mutate(rel_rel = scale(rel_rel)) %>%
  ggplot(aes(rel_rel, fill = c2_phonation, colour = c2_phonation)) +
  geom_density(alpha = 0.5)
```

```{r rr-density-vowel}
duration %>%
  group_by(speaker) %>%
  mutate(rel_rel = scale(rel_rel)) %>%
  ggplot(aes(rel_rel, fill = vowel, colour = vowel)) +
  geom_density(alpha = 0.5) +
  facet_grid(~ language)
```

```{r rr-box-vowel}
duration %>%
  group_by(speaker) %>%
  mutate(rel_rel = scale(rel_rel)) %>%
  ggplot(aes(vowel, rel_rel, fill = vowel)) +
  geom_boxplot() +
  facet_grid(~ language)
```

```{r rr-density-lang}
duration %>%
  group_by(speaker) %>%
  mutate(rel_rel = scale(rel_rel)) %>%
  ggplot(aes(rel_rel, fill = c2_phonation, colour = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(~ language)
```

```{r rr-density-vow-c2_place}
duration %>%
  group_by(speaker) %>%
  mutate(rel_rel = scale(rel_rel)) %>%
  ggplot(aes(rel_rel, fill = c2_phonation, colour = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(c2_place ~ vowel)
```

```{r rr-box}
duration %>%
  group_by(speaker) %>%
  mutate(rel_rel = scale(rel_rel)) %>%
  ggplot(aes(vowel, rel_rel, fill = c2_phonation)) +
  geom_boxplot()
```

```{r rr-vow-box-lang}
duration %>%
  group_by(speaker) %>%
  mutate(rel_rel = scale(rel_rel)) %>%
  ggplot(aes(vowel, rel_rel, fill = c2_phonation)) +
  geom_boxplot() +
  facet_grid(~ language)
```

```{r rr-box-lang}
duration %>%
  group_by(speaker) %>%
  mutate(rel_rel = scale(rel_rel)) %>%
  ggplot(aes(c2_phonation, rel_rel, fill = c2_phonation)) +
  geom_boxplot() +
  facet_grid(~ language)
```

The Release-Release interval duration does not seem to be affected by the voicing of C2.

## RVOT of C1

```{r c1-rvot-density-vowel}
duration %>%
  group_by(speaker) %>%
  mutate(c1_rvot = scale(c1_rvot)) %>%
  ggplot(aes(c1_rvot, fill = vowel, colour = vowel)) +
  geom_density(alpha = 0.5) +
  facet_grid(~ language)
```

## RVoffT of C1

```{r c1-rvofft-density-vowel}
duration %>%
  group_by(speaker) %>%
  mutate(c1_rvofft = scale(c1_rvofft)) %>%
  ggplot(aes(c1_rvofft, fill = vowel, colour = vowel)) +
  geom_density(alpha = 0.5) +
  facet_grid(~ language)
```

```{r c1-rvofft-box-vowel}
duration %>%
  group_by(speaker) %>%
  mutate(c1_rvofft = scale(c1_rvofft)) %>%
  ggplot(aes(vowel, c1_rvofft, fill = vowel)) +
  geom_boxplot() +
  facet_grid(~ language)
```

## Word durations

```{r word-dur-density}
duration %>%
  ggplot(aes(word_duration, fill = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(~ language)
```

```{r word-dur-density}
duration %>%
  group_by(speaker) %>%
  mutate(word_duration_z = scale(word_duration)) %>%
  ggplot(aes(word_duration_z, fill = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(~ language)
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(word_duration_z = scale(word_duration)) %>%
  ggplot(aes(c2_phonation, word_duration_z, fill = c2_phonation)) +
  geom_boxplot() +
  facet_wrap(~ speaker)
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(word_duration_z = scale(word_duration)) %>%
  ggplot(aes(c2_phonation, word_duration_z, fill = c2_phonation)) +
  geom_boxplot() +
  facet_wrap(~ language)
```

## VOT

```{r}
duration %>%
  ggplot(aes(c1_vot)) +
  geom_density()
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(c1_vot = scale(c1_vot)) %>%
  ggplot(aes(c1_vot)) +
  geom_density()
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(c1_vot = scale(c1_vot)) %>%
  ggplot(aes(c1_vot, fill = vowel)) +
  geom_density(alpha = 0.5)
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(c1_vot = scale(c1_vot)) %>%
  ggplot(aes(vowel, c1_vot, fill = vowel)) +
  geom_boxplot()
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(c1_vot = scale(c1_vot)) %>%
  filter(c1_vot < 3, c1_vot > -3) %>%
  ggplot(aes(vowel, c1_vot, fill = vowel)) +
  geom_boxplot()
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(c1_vot = scale(c1_vot)) %>%
  filter(c1_vot < 3, c1_vot > -3) %>%
  ggplot(aes(vowel, c1_vot, fill = vowel)) +
  geom_boxplot() +
  facet_grid(~ language)
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(c1_vot_z = scale(c1_vot)) %>%
  filter(c1_vot_z < 3, c1_vot_z > -3) %>%
  ggplot(aes(vowel, c1_vot, fill = vowel)) +
  geom_boxplot() +
  facet_grid(~ language)
```

```{r}
duration %>%
  group_by(speaker) %>%
  mutate(c1_vot_z = scale(c1_vot)) %>%
  filter(c1_vot_z < 3, c1_vot_z > -3, c1_vot > -50) %>%
  ggplot(aes(vowel, c1_vot, fill = vowel)) +
  geom_boxplot() +
  facet_grid(~ language)
```

## Stability measure of closure timing

Test with clousre duration and coefficient of variation (CV)

```{r}
closure_cv <- duration %>%
  group_by(language, speaker, c2_place, c2_phonation) %>%
  summarise(
    sd = sd(closure_duration, na.rm = TRUE),
    mean = mean(closure_duration, na.rm = TRUE),
    cv = 100 * sd(closure_duration, na.rm = TRUE) / mean(closure_duration, na.rm = TRUE)
  )
```

```{r}
closure_cv %>%
  ggplot(aes(c2_phonation, cv)) +
  geom_boxplot() +
  facet_grid(language ~ c2_place)
```

```{r}
closure_cv %>%
  ggplot(aes(c2_phonation, cv)) +
  geom_boxplot()
```

```{r}
closure_cv %>%
  ggplot(aes(c2_phonation, cv)) +
  geom_boxplot() +
  facet_grid(~ language)
```

It looks like the CV for voiced consonants is higher (meaning there is more variation in those than in voiceless).

# Analysis

## Vowel duration

```{r vowdur-lm}
vowdur_lm <- lmer(
  vowel_duration ~
    c2_phonation +
#    language +
    c2_place +
    vowel +
    c2_phonation:vowel +
#    language:vowel +
    sentence_duration +
    (1+c2_phonation|speaker) +
    (1|item),
  REML = FALSE,
  data = duration
)
summary(vowdur_lm)
```

Language and language:voicing interaction do not improve fit.

```{r vowdur-lm-plot}
plot(allEffects(vowdur_lm))
```

```{r vowdur-ranef}
round(ranef(vowdur_lm)$speaker)
```

```{r vowdur-lm-ranef-condmodes}
as_tibble(ranef(vowdur_lm)$speaker[2], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, c2_phonationvoiced, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker conditional means for phonation", y = "Vowel duration (msec)")
```

```{r vowdur-lm-ranef-intercept}
as_tibble(ranef(vowdur_lm)$speaker[1], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, `(Intercept)`, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker conditional means for vowel duration (intercept)", y = "Vowel duration (msec)")
```

```{r corr-ranef}
as_tibble(ranef(vowdur_lm)$speaker, rownames = "speaker") %>%
  filter(c2_phonationvoiced < 10) %>%
  ggplot(aes(`(Intercept)`, c2_phonationvoiced)) +
  geom_point() +
  geom_smooth(method = "lm")
```

No correlation between vowel duration and phonation conditional means.

```{r vowdur-lm-coeff-phonation}
as_tibble(coef(vowdur_lm)$speaker[2], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, c2_phonationvoiced, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker coefficients for phonation", y = "msec")
```

```{r vowdur-lm-coeff-intercept}
as_tibble(coef(vowdur_lm)$speaker[1], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, `(Intercept)`, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker coefficients for vowel duration", y = "Vowel duration (msec)")
```

### Italian

```{r vowdur-it}
vowdur_it <- lmer(
  vowel_duration ~
    c2_phonation +
    c2_place +
    vowel +
    c2_phonation:vowel +
    c2_place:vowel +
    sentence_duration +
    (1+c2_phonation|speaker) +
    (1|item),
  REML = FALSE,
  data = filter(duration, language == "italian")
)
summary(vowdur_it)
```

### Polish

```{r vowdur-pl}
vowdur_pl <- lmer(
  vowel_duration ~
    c2_phonation +
    c2_place +
    vowel +
    c2_phonation:vowel +
    c2_place:vowel +
    sentence_duration +
    (1+c2_phonation|speaker) +
    (1|item),
  REML = FALSE,
  data = filter(duration, language == "polish")
)
summary(vowdur_pl)
```

## Closure duration

```{r closdur-lm}
closdur_lm <- lmer(
  closure_duration ~
    c2_phonation +
#    language +
    c2_place +
    vowel +
    c2_phonation:vowel +
#    language:vowel +
    sentence_duration +
    (1+c2_phonation|speaker) +
    (1|item),
  REML = FALSE,
  data = duration
)
summary(closdur_lm)
```

```{r closdur-lm-ranef-condmodes}
as_tibble(ranef(closdur_lm)$speaker[2], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, c2_phonationvoiced, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker conditional means for phonation", y = "Closure duration (msec)")
```

```{r}
vowdur_cond <- as_tibble(ranef(vowdur_lm)$speaker[2], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6)))

closdur_cond <- as_tibble(ranef(closdur_lm)$speaker[2], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6)))

vow_clos <- inner_join(vowdur_cond, closdur_cond, by = c("speaker", "language"))

vow_clos %>%
  ggplot(aes(c2_phonationvoiced.x, c2_phonationvoiced.y)) +
  geom_point(aes(colour = language)) +
  geom_smooth(method = "lm") +
  labs(
    title = "Correlation between conditional means of vowel and closure duration by speker",
    x = "Vowel duration (conditional means)",
    y = "Closure duration (conditional means)"
  )
```

```{r}
cor.test(vow_clos$c2_phonationvoiced.x, vow_clos$c2_phonationvoiced.y)
```

There is a strong negative correlation (Pearson's r = -0.8) between the conditional means for vowel duration and those for closure duration.

## Vowel and closure duration

```{r vow-clos-lm}
vow_clos_lm <- lmer(
  vowel_duration ~
    closure_duration +
    sentence_duration +
    vowel +
    c2_place +
    (1|speaker) +
    (1|item),
  data = duration,
  REML = FALSE
)
summary(vow_clos_lm)
```

```{r}
plot(allEffects(vow_clos_lm))
```

Vowel duration is inversely correlated with closure duration.
Language and voicing of C2 don't improve the model fit, nor an interaction with closure duration.

```{r}
as_tibble(effect("closure_duration", vow_clos_lm)) %>%
  ggplot(aes(closure_duration, fit)) +
  geom_ribbon(aes(ymax = upper, ymin = lower), alpha = 0.2) +
  geom_line()
```


## VOT

```{r vot-lm}
vot_clean <- duration %>%
  group_by(speaker) %>%
  mutate(c1_vot_z = scale(c1_vot)) %>%
  filter(c1_vot_z > -2.5, c1_vot_z < 2.5) %>%
  ungroup()

vot_lm <- lmer(
  c1_vot ~
    vowel *
    language +
#    sentence_duration +
    (1|speaker) +
    (1|item),
  data = vot_clean,
  REML = FALSE
)

summary(vot_lm)
```

```{r vot-lm-plot}
plot(allEffects(vot_lm))
```

## RVOT

```{r rvot-lm}
rvot_lm <- lmer(
  c1_rvot ~
    vowel *
    language +
    sentence_duration +
    (1|speaker) +
    (1|item),
  data = duration,
  REML = FALSE
)

summary(rvot_lm)
```

```{r}
plot(allEffects(rvot_lm))
```

## Release to release

```{r rr-lm}
rr_lm <- lmer(
  rel_rel ~
    c2_phonation +
    vowel +
    c2_place +
    sentence_duration +
    (1 + c2_phonation|speaker) +
    (1|item),
  data = duration,
  REML = FALSE
)
summary(rr_lm)

rr_lm_null <- lmer(
  rel_rel ~
    vowel +
    c2_place +
    sentence_duration +
    (1 + c2_phonation|speaker) +
    (1|item),
  data = duration,
  REML = FALSE
)

anova(rr_lm_null, rr_lm)
```

```{r rr-lm-plot}
plot(allEffects(rr_lm))
```

Including c2_phonation in the model does not improve the fit.
The Release to Release interval duration is not affected by voicing of C.
