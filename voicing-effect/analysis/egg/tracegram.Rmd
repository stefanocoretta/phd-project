---
title: "Tracegram"
author: "Stefano Coretta"
date: "20/12/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_knit$set(root.dir = normalizePath("../../../"))
library(tidyverse)
theme_set(theme_bw())
library(lmerTest)
library(effects)
```

# Data import

```{r import}
languages <- read_csv("./voicing-effect/data/datasets/speakers.csv")
words <- read_csv("./voicing-effect/data/datasets/stimuli.csv")

degg <- list.files(path = "./voicing-effect/data/datasets/egg",
                   pattern = "*-degg-tracing.csv",
                   full.names = TRUE) %>%
    map_df(~read_csv(.)) %>%
    left_join(y = languages) %>%
    left_join(y = words) %>%
    filter(c1phonation == "voiceless") %>%
    mutate(c2phonation = factor(c2phonation, levels = c("voiceless", "voiced"))) %>%
    mutate_if(is.character, as.factor) %>%
    mutate(
        c2phonation_o = ordered(
            c2phonation,
            levels = c("voiceless", "voiced")
        ),
        closed_quotient = minimum - maximum,
        quotient_centre = (minimum + maximum) / 2,
        weighted_quotient_centre = ((minimum + maximum) / 2 ) * (minimum),
        peaks_ratio = maximum / minimum
    ) %>%
    filter(minimum > 0, minimum < 1) %>%
  group_by(speaker) %>%
  mutate(
    peaks_ratio_norm = scale(peaks_ratio)
  )

min_activity <- degg %>%
  group_by(language, c2phonation_o, date) %>%
  summarise(
    peaks_ratio = min(peaks_ratio)
  ) %>%
  left_join(y = degg)

min_activity_norm <- degg %>%
  group_by(language, c2phonation_o, date) %>%
  summarise(
    peak_ratio_norm = min(peaks_ratio_norm)
  ) %>%
  left_join(y = degg)
```

# Data exploration

## Tracegrams

Let's save some `ggplot` layers to speed up plotting.

```{r tracegram-layers}
tracegram_layers <- list(
    xlab("proportion of vowel duration"),
    ylab("proportion of glottal period"),
    xlim(0, 1),
    ylim(0, 1),
    scale_color_discrete(name = "C2 voicing"),
    scale_linetype_discrete(name = "C2 voicing")
)
```


```{r tracegram-point-speakers}
degg %>%
    ggplot(aes(x = proportion, colour = c2phonation_o)) +
        facet_wrap(~ speaker, nrow = 2) +
        geom_point(aes(y = maximum), alpha = 0.5) +
        geom_point(aes(y = minimum), alpha = 0.5) +
        tracegram_layers
```

```{r tracegram-smooth-speakers}
degg %>%
    ggplot(aes(x = proportion, colour = c2phonation_o, linetype = c2phonation_o)) +
        facet_wrap(~ speaker, nrow = 2) +
        geom_smooth(aes(y = maximum), size = 0.5, alpha = 0.2) +
        geom_smooth(aes(y = minimum), size = 0.5, alpha = 0.2) +
        tracegram_layers
```

```{r tracegram-smooth-languages}
degg %>%
    ggplot(aes(x = proportion, colour = c2phonation_o, linetype = c2phonation_o)) +
        facet_wrap(~ language) +
        geom_smooth(aes(y = maximum), size = 0.5, alpha = 0.2) +
        geom_smooth(aes(y = minimum), size = 0.5, alpha = 0.2) +
        tracegram_layers +
    labs(title = "Vocal fold activity through vowel duration", subtitle = "The lines in the lower half of the graphs are traces of the dEGG maximum,\nwhile the lines in the upper half are traces of the dEGG minimum.")
```

As a first impression, it seems that both in Italian and Polish vocal folds start abducting in the voiceless condition before closure is achieved.
It looks like the abduction gesture starts earlier in Italian (60% of vowel duration) than in Polish (75% of vowel duration).

```{r tracegram-smooth-languages-vowels}
degg %>%
    ggplot(aes(x = proportion, colour = c2phonation_o, linetype = c2phonation_o)) +
        geom_smooth(aes(y = maximum), size = 0.5, alpha = 0.2) +
        geom_smooth(aes(y = minimum), size = 0.5, alpha = 0.2) +
        tracegram_layers +
        facet_grid(language ~ vowel)
```


## Closed qotient

```{r cq-layers}
cq_layers <- list(
    xlim(0, 1),
    xlab("vowel duration"),
    ylab("proportion of glottal period"),
    scale_color_discrete(name = "C2 voicing"),
    scale_linetype_discrete(name = "C2 voicing")
)
```


```{r cq-points}
degg %>%
    ggplot(aes(x = proportion, colour = c2phonation_o)) +
        facet_wrap(~ speaker, nrow = 2) +
        geom_point(aes(y = closed_quotient), alpha = 0.5) +
        cq_layers
```

```{r cq-smooth-speakers}
degg %>%
    ggplot(aes(proportion, closed_quotient, colour = c2phonation_o, linetype = c2phonation_o)) +
        facet_wrap(~ speaker, nrow = 2) +
        geom_point(size = 0.2, alpha = 0.1) +
        geom_smooth(size = 0.5, alpha = 0.5) +
        cq_layers
```

```{r cq-smooth-language}
degg %>%
    ggplot(aes(proportion, closed_quotient, colour = c2phonation_o, linetype = c2phonation_o)) +
        facet_wrap(~ language) +
        geom_point(size = 0.2, alpha = 0.1) +
        geom_smooth(alpha = 0.5) +
        cq_layers
```

```{r cq-smooth-language-vowel}
degg %>%
    ggplot(aes(proportion, closed_quotient, colour = c2phonation_o, linetype = c2phonation_o)) +
        facet_grid(language ~ vowel) +
        geom_point(size = 0.2, alpha = 0.1) +
        geom_smooth(alpha = 0.5) +
        cq_layers
```

```{r cq-language-voiceless}
degg %>%
  filter(c2phonation_o == "voiceless") %>%
    ggplot(aes(proportion, closed_quotient, colour = language, linetype = language)) +
        geom_point(size = 0.2, alpha = 0.1) +
        geom_smooth(alpha = 0.5) +
        cq_layers
```

```{r cq-language-voiced}
degg %>%
  filter(c2phonation_o == "voiced") %>%
    ggplot(aes(proportion, closed_quotient, colour = language, linetype = language)) +
        geom_point(size = 0.2, alpha = 0.1) +
        geom_smooth(alpha = 0.5) +
        cq_layers
```

## Closed Quotient Centre

```{r cq-centre-speaker}
degg %>%
    ggplot(aes(proportion, quotient_centre, colour = c2phonation_o, linetype = c2phonation_o)) +
    geom_smooth() +
    facet_wrap(~ speaker, nrow = 2)
```

```{r cq-centre-language}
degg %>%
    ggplot(aes(proportion, quotient_centre, colour = c2phonation_o, linetype = c2phonation_o)) +
    geom_smooth() +
    facet_grid(~ language) +
    ylim(0, 1)
```

```{r weighted-cq-centre-speaker}
degg %>%
    ggplot(aes(proportion, weighted_quotient_centre, colour = c2phonation_o, linetype = c2phonation_o)) +
    geom_smooth() +
    facet_wrap(~ speaker, nrow = 2)
```

```{r weighted-cq-centre-language}
degg %>%
    ggplot(aes(proportion, weighted_quotient_centre, colour = c2phonation_o, linetype = c2phonation_o)) +
    geom_smooth() +
    facet_grid(~ language) +
    ylim(0, 1)
```

## Peaks ratio

The peaks ratio is `dEGG_max / dEGG_min`.

```{r peaks-ratio-speaker}
degg %>%
    ggplot(aes(proportion, peaks_ratio, colour = c2phonation_o, linetype = c2phonation_o)) +
  geom_smooth() +
  facet_wrap(~ speaker, nrow = 2) +
  xlim(0.1, 0.9)
```

Yes, this clearly works.

```{r peaks-ratio-language}
degg %>%
    ggplot(aes(proportion, peaks_ratio, colour = c2phonation_o, linetype = c2phonation_o)) +
    geom_smooth() +
    facet_wrap(~ language) +
  xlim(0.1, 0.9)
```

```{r peaks-ratio-language-voiceless}
degg %>%
  filter(c2phonation_o == "voiceless") %>%
    ggplot(aes(proportion, peaks_ratio, colour = language, linetype = language)) +
    geom_smooth() +
  xlim(0.1, 0.9)
```

```{r peaks-ratio-language-voiced}
degg %>%
  filter(c2phonation_o == "voiced") %>%
  ggplot(aes(proportion, peaks_ratio, colour = language, linetype = language)) +
#  geom_point(alpha = 0.1) +
  geom_smooth() +
  xlim(0.1, 0.9)
```

```{r min-activity}
min_activity %>%
  ggplot(aes(c2phonation_o, proportion, colour = language)) +
  geom_boxplot()
```

```{r min-activity-lm}
min_activity_lm <- lmer(
  proportion ~
    language *
    c2phonation_o +
    (1|speaker),
  data = min_activity
)
summary(min_activity_lm)
```

```{r min-activity-effects}
plot(allEffects(min_activity_lm))
```

```{r min-activity-speaker}
min_activity %>%
  ggplot(aes(c2phonation_o, proportion, colour = speaker)) +
  geom_boxplot() +
  facet_grid(. ~ language)
```

The average peaks ratio does not tell much it seems, but compare with lmer.

```{r average-peaks-ratio}
degg %>%
  ggplot(aes(language, peaks_ratio)) +
  geom_boxplot() +
  facet_grid(~ c2phonation_o)
```

Lower peaks ratio in Polish between 45-55% of the vowel duration, but not significant.

```{r average-peaks-ratio-centre}
degg %>%
  filter(proportion > 0.45, proportion < 0.55) %>%
  ggplot(aes(language, peaks_ratio)) +
  geom_boxplot() +
  facet_grid(~ c2phonation_o)
```

```{r average-peaks-ratio-lm}
peaks_ratio_lm <- lmer(
  peaks_ratio ~
    language *
    c2phonation +
    (1|speaker) +
    (1|word),
  data = degg
)

summary(peaks_ratio_lm)
```

```{r average-peaks-ratio-effects}
plot(allEffects(peaks_ratio_lm))
```


### Normalised peaks ratio

```{r peaks-ratio-language-norm}
degg %>%
    ggplot(aes(proportion, peaks_ratio_norm, colour = c2phonation_o, linetype = c2phonation_o)) +
    geom_smooth() +
    facet_wrap(~ language) +
  xlim(0.1, 0.9)
```


```{r peaks-ratio-language-voiceless-norm}
degg %>%
  filter(c2phonation_o == "voiceless") %>%
    ggplot(aes(proportion, peaks_ratio_norm, colour = language, linetype = language)) +
    geom_smooth() +
  xlim(0.1, 0.9)
```

```{r peaks-ratio-language-voiced-norm}
degg %>%
  filter(c2phonation_o == "voiced") %>%
    ggplot(aes(proportion, peaks_ratio_norm, colour = language, linetype = language)) +
    geom_smooth() +
  xlim(0.1, 0.9)
```

```{r average-peaks-ratio-centre-norm}
degg %>%
  filter(proportion > 0.45, proportion < 0.55) %>%
  ggplot(aes(language, peaks_ratio_norm)) +
  geom_boxplot() +
  facet_grid(~ c2phonation_o)
```

```{r average-peaks-ratio-centre-norm-interaction}
degg %>%
  filter(proportion > 0.45, proportion < 0.55) %>%
  ggplot(aes(c2phonation_o, peaks_ratio_norm, colour = language)) +
  geom_boxplot() +
  facet_grid(vowel ~ c2place)
```

```{r density-peaks-ratio-second-half-norm}
degg %>%
  filter(proportion > 0.5) %>%
  ggplot(aes(peaks_ratio_norm, colour = c2phonation_o)) +
  geom_density() +
  facet_grid(~ language)
```

```{r average-peaks-ratio-second-half-norm}
degg %>%
  filter(proportion > 0.5) %>%
  ggplot(aes(language, peaks_ratio_norm)) +
  geom_boxplot() +
  facet_grid(~ c2phonation_o)
```

```{r speaker-average-peaks-ratio-second-half-norm}
degg %>%
  filter(proportion > 0.5) %>%
  ggplot(aes(speaker, peaks_ratio_norm, colour = c2phonation_o)) +
  geom_boxplot()
```

```{r average-peaks-ratio-norm-lm}
degg_50 <- filter(degg, proportion > 0.5)

peaks_ratio_norm_lm <- lmer(
  peaks_ratio_norm ~
    c2phonation *
    language +
    (1|word),
  data = degg_50
)

summary(peaks_ratio_norm_lm)
```

```{r average-peaks-ratio-norm-effects}
plot(allEffects(peaks_ratio_norm_lm))
```

```{r min-activity-norm}
min_activity %>%
  ggplot(aes(c2phonation_o, proportion, colour = language)) +
  geom_boxplot()
```

```{r peaks-ratio-it01}
degg %>%
  filter(speaker == "it01") %>%
    ggplot(aes(proportion, peaks_ratio, colour = c2phonation_o, linetype = c2phonation_o)) +
  geom_path(alpha = 0.5, aes(group = date)) +
  geom_smooth() +
  facet_grid(~ c2phonation_o) +
  xlim(0.1, 0.9)
```

```{r peaks-ratio-pl04}
degg %>%
  filter(speaker == "pl04") %>%
    ggplot(aes(proportion, peaks_ratio, colour = c2phonation_o, linetype = c2phonation_o)) +
  geom_path(alpha = 0.5, aes(group = date)) +
  geom_smooth() +
  facet_grid(~ c2phonation_o) +
  xlim(0.1, 0.9)
```
