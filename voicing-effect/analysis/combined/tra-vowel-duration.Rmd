---
title: "TRA and vowel duration"
author: "Stefano Coretta"
date: "20/12/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../../"))
library(tidyverse)
theme_set(theme_minimal())
library(lme4)
library(effects)
library(rticulate)
```

# Read data

```{r read-data}
columns <- c(
  "speaker",
  "seconds",
  "rec_date",
  "prompt",
  "label",
  "TT_displacement_sm",
  "TT_velocity",
  "TT_velocity_abs",
  "TD_displacement_sm",
  "TD_velocity",
  "TD_velocity_abs",
  "TR_displacement_sm",
  "TR_velocity",
  "TR_velocity_abs"
)

speakers <- read_csv("./voicing-effect/data/datasets/speakers.csv")
stimuli <- read_csv("./voicing-effect/data/datasets/stimuli.csv")

vowels <- list.files(
  path = "./voicing-effect/data/datasets/acoustics",
  pattern = "*-durations.csv",
  full.names = TRUE
) %>%
  map_df(~read_csv(., na = "--undefined--"))

tongue_root <- list.files(
  path = "./voicing-effect/data/datasets/ultrasound/",
  pattern = "*-tongue-cart.tsv",
  full.names = TRUE
) %>%
  map_df(~read_aaa(., column_names = columns, format = "wide")) %>%
  select(-(X_1:Y_42)) %>%
  filter(label == "closure_") %>%
  mutate(word = word(prompt, 2)) %>%
  left_join(y = speakers) %>%
  left_join(y = stimuli) %>%
  left_join(y = vowels) %>%
  mutate(c2_phonation = factor(c2_phonation, levels = c("voiceless", "voiced"))) %>%
  mutate_if(is.character, as.factor) %>%
  # filter clear outlier
  filter(TR_displacement_sm > 40, c1_phonation == "voiceless") %>%
  group_by(speaker) %>%
  mutate(
    vowel_duration_z = scale(vowel_duration),
    tra = -TR_displacement_sm,
    tra_z = scale(tra)
  ) %>%
  ungroup() %>%
  mutate(item = factor(item))


tongue <- list.files(
  path = "./voicing-effect/data/datasets/ultrasound/",
  pattern = "*tongue-cart.tsv",
  full.names = TRUE
) %>%
  map_df(~read_aaa(., column_names = columns)) %>%
  filter(label %in% c("max_TT", "max_TD")) %>%
  mutate(word = word(prompt, 2)) %>%
  left_join(y = speakers) %>%
  left_join(y = stimuli) %>%
  left_join(y = vowels) %>%
  mutate_if(is.character, as.factor) %>%
  filter(c1_phonation == "voiceless") %>%
  group_by(speaker) %>%
  do(transform_coord(., fan_lines = c(15, 25))) %>%
  ungroup() %>%
  na.omit()
```

Vowel duration and tongue root displacement are normalised within each speaker using z-scores.

# Tongue root and vowel duration

```{r tr-vowel-duration}
tongue_root %>%
    ggplot(aes(tra_z, vowel_duration_z)) +
    geom_point() +
    geom_smooth(method = "lm")
```

```{r tr-vowel-duration-vowel}
tongue_root %>%
    ggplot(aes(tra_z, vowel_duration_z, colour = c2_phonation)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_grid(. ~ vowel)
```

```{r tr-vowel-duration-place}
tongue_root %>%
    ggplot(aes(tra_z, vowel_duration_z, colour = c2_phonation)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_grid( ~ c2_place)
```

```{r tr-vowel-duration-vowel-place}
tongue_root %>%
    ggplot(aes(tra_z, vowel_duration_z, colour = c2_phonation)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_grid(c2_place ~ vowel)
```

It does not seem to be a correlation. Maybe I should check TRA not at maximum TT/TD displacement?

/a/ and /o/ show more advancement in the voiced condition (lower TR_displacement).

```{r tra-lm-it}
tra_lm_it <- lmer(
  vowel_duration_z ~
    tra_z +
    c2_place +
    vowel *
    c2_phonation +
    vowel:c2_place +
    tra_z:vowel +
    (1+tra_z|speaker) +
    (1|word),
  data = filter(tongue_root, language == "italian"),
  REML = FALSE
)

summary(tra_lm_it)

tra_lm_it_null <- lmer(
  vowel_duration_z ~
    tra_z +
    c2_place +
    vowel *
    c2_phonation +
    vowel:c2_place +
#    tra_z:vowel +
    (1+tra_z|speaker) +
    (1|word),
  data = filter(tongue_root, language == "italian"),
  REML = FALSE
)

summary(tra_lm_it_null)

anova(tra_lm_it_null, tra_lm_it)
```

```{r}
plot(allEffects(tra_lm_it_null))
```

```{r}
ranef(tra_lm_it)$speaker
```

The lmer detects a correlation, but I need to be cautious.

```{r}
mean_tra_lm <- lmer(
    tra_z ~
        c2_phonation +
        vowel +
        c2_place +
        (1|speaker) +
        (1|word),
    data = tongue_root
)
summary(mean_tra_lm)
```

```{r}
plot(allEffects(mean_tra_lm))
```

```{r tra-lm-pl}
tra_lm_pl <- lmer(
    vowel_duration_z ~
        tra_z +
        c2_place +
        vowel *
        c2_phonation +
        (1|speaker) +
        (1|word),
    data = filter(tongue_root, language == "polish")
)

summary(tra_lm_pl)

tra_lm_pl_null <- lmer(
    vowel_duration_z ~
#        tra_z *
        c2_phonation +
        vowel +
        c2_place +
        (1|speaker) +
        (1|word),
    data = filter(tongue_root, language == "polish")
)

anova(tra_lm_pl_null, tra_lm_pl)
```

```{r}
plot(allEffects(tra_lm_pl))
```

### Lmer with all data

```{r tongue-root-clean}
tongue_root_clean <- filter(tongue_root, tra_z < 3)
```

```{r tra-lm}
tra_lm <- lmer(
  scale(vowel_duration) ~
    tra +
    c2_phonation +
    vowel +
    scale(sentence_duration) +
    (1+tra|speaker) +
    (1+tra|item),
data = tongue_root_clean,
REML = FALSE
)

summary(tra_lm)

tra_lm_null <- lmer(
  vowel_duration ~
    tra +
#    c2_phonation +
    vowel +
    sentence_duration +
    (1+tra|speaker) +
    (1|item),
data = tongue_root_clean,
REML = FALSE
)

anova(tra_lm_null, tra_lm)
```

```{r tra-lm-effects}
plot(allEffects(tra_lm))
```

```{r tra-lm-2}
tra_lm_2 <- lmer(
  tra ~
    vowel_duration +
    vowel +
    sentence_duration +
    (1+vowel_duration|speaker) +
    (1|item),
data = tongue_root_clean,
REML = FALSE
)

summary(tra_lm_2)

tra_lm_2_null <- lmer(
  tra ~
#    vowel_duration +
    vowel +
    sentence_duration +
    (1+vowel_duration|speaker) +
    (1|item),
data = tongue_root_clean,
REML = FALSE
)

anova(tra_lm_2_null, tra_lm_2)
```

```{r tra-lm-effects}
plot(allEffects(tra_lm_2))
```

Including random slopes for vowel duration improves the model, vowel duration is still significant term.

## More plotting

```{r tr-vowel-dur-faceted}
tongue_root %>%
  filter(tra_z < 3) %>%
  ggplot(aes(tra_z, vowel_duration_z)) +
  geom_point(alpha = 0.3, stroke = 0) +
  geom_smooth(method = "lm", aes(colour = vowel)) +
  facet_grid(c2_place ~ vowel, scales = "free") +
  labs(
    title = "Correlation between tongue root advancement and vowel duration",
    x = "Tongue root advacement (z-scores)",
    y = "Vowel duration (z-scores)"
  )
```

```{r it-tr-vowel-dur}
tongue_root %>%
  filter(language == "italian", tra_z > -2.7) %>%
  ggplot(aes(tra_z, vowel_duration_z)) +
  geom_point(alpha = 0.3, stroke = 0) +
  geom_smooth(method = "lm", aes(colour = vowel)) +
  facet_grid(c2_place ~ vowel, scales = "free") +
  labs(
    title = "Correlation between tongue root advancement and vowel duration in Italian",
    x = "Tongue root advacement (z-scores)",
    y = "Vowel duration (z-scores)"
  )
```

```{r pl-tr-vowel-dur}
tongue_root %>%
  filter(language == "polish", tra_z > -3, tra_z < 3) %>%
  ggplot(aes(tra_z, vowel_duration_z)) +
  geom_point(alpha = 0.3, stroke = 0) +
  geom_smooth(method = "lm", aes(colour = vowel)) +
  facet_grid(c2_place ~ vowel, scales = "free") +
  labs(
    x = "tongue root advacement (z-scores)",
    y = "vowel duration (z-scores)"
  )
```


```{r baap-plot}
tongue_root %>%
  filter(speaker %in% c("it01", "it02", "it03", "it04", "pl02", "pl03", "pl04", "pl05"), tra_z < 2.5, tra_z > -2) %>%
  ggplot(aes(tra_z, vowel_duration_z)) +
  geom_point(alpha = 0.3, stroke = 0) +
  geom_smooth(method = "lm", aes(colour = vowel)) +
  facet_grid(c2_place ~ vowel, scales = "free") +
  labs(
    title = "Correlation between tongue root advancement and vowel duration",
    x = "Tongue root advacement (z-scores)",
    y = "Vowel duration (z-scores)"
  )
```

```{r vowel-dur-tr-faceted}
tongue_root %>%
  filter(tra_z < 3) %>%
  ggplot(aes(vowel_duration_z, tra_z)) +
  geom_point(alpha = 0.3, stroke = 0) +
  geom_smooth(method = "lm", aes(colour = vowel)) +
  facet_grid(c2_place ~ vowel, scales = "free") +
  labs(
    title = "Correlation between tongue root advancement and vowel duration",
    y = "Tongue root advacement (z-scores)",
    x = "Vowel duration (z-scores)"
  )
```
