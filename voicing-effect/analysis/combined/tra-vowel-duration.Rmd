---
title: "TRA and vowel duration"
author: "Stefano Coretta"
date: "20/12/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../../"))
library(tidyverse)
theme_set(theme_minimal())
library(lmerTest)
library(effects)
library(rticulate)
```

# Read data

```{r read-data}
columns <- c(
    "speaker",
    "seconds",
    "rec.date",
    "prompt",
    "label",
    "TT.displacement.sm",
    "TT.velocity",
    "TT.velocity.abs",
    "TD.displacement.sm",
    "TD.velocity",
    "TD.velocity.abs",
    "TR.displacement.sm",
    "TR.velocity",
    "TR.velocity.abs"
)

languages <- read_csv("./voicing-effect/data/datasets/speakers.csv")
words <- read_csv("./voicing-effect/data/datasets/stimuli.csv")

vowels <- list.files(path = "./voicing-effect/data/datasets/acoustics",
                   pattern = "*-durations.csv",
                   full.names = TRUE) %>%
    map_df(~read_csv(., na = "--undefined--"))

tongue_root <- list.files(path = "./voicing-effect/data/datasets/ultrasound/",
                   pattern = "*-tra-cart.tsv",
                   full.names = TRUE) %>%
    map_df(~read_tsv(., col_names = columns)) %>%
    mutate(word = word(prompt, 2)) %>%
    left_join(y = languages) %>%
    left_join(y = words) %>%
    left_join(y = vowels) %>%
    mutate_if(is.character, as.factor) %>%
    # filter clear outlier
    filter(TR.displacement.sm > 40) %>%
    group_by(speaker) %>%
    mutate(
        vowel_duration_z = scale(vowel.duration),
        TR_displacement_z = scale(TR.displacement.sm)
    )

columns <- c(
    "speaker",
    "seconds",
    "rec.date",
    "prompt",
    "label",
    "TT.displacement.sm",
    "TT.velocity",
    "TT.velocity.abs",
    "TD.displacement.sm",
    "TD.velocity",
    "TD.velocity.abs"
)

tongue <- list.files(
  path = "./voicing-effect/data/datasets/ultrasound/",
  pattern = "*tongue-cart.tsv",
  full.names = TRUE
) %>%
  map_df(~read_aaa(., column_names = columns)) %>%
  filter(label %in% c("max_TT", "max_TD")) %>%
  mutate(word = word(prompt, 2)) %>%
  left_join(y = languages) %>%
  left_join(y = words) %>%
  left_join(y = vowels) %>%
  mutate_if(is.character, as.factor) %>%
  group_by(speaker) %>%
  do(transform_coord(., fan_lines = c(15, 25))) %>%
  na.omit()
```

Vowel duration and tongue root displacement are normalised within each speaker using z-scores.

# Using TR fan line

## Tongue root advancement

```{r tr-density}
tongue_root %>%
    ggplot(aes(TR_displacement_z, fill = c2phonation)) +
    geom_density(alpha = 0.2) +
    facet_grid(. ~ language)
```

```{r tr-boxplot}
tongue_root %>%
    ggplot(aes(c2phonation, -TR_displacement_z)) +
    geom_boxplot() +
    facet_grid(. ~ language)
```


```{r tr-boxplot-speakers}
tongue_root %>%
    ggplot(aes(c2phonation, -TR_displacement_z)) +
    geom_boxplot() +
    facet_wrap(~ speaker)
```

```{r tr-italian}
tongue_root %>%
  filter(language == "italian") %>%
    ggplot(aes(c2phonation, -TR_displacement_z)) +
    geom_boxplot() +
    facet_grid(c2place ~ vowel)
```

## Tongue root and vowel duration

```{r tr-vowel-duration}
tongue_root %>%
    ggplot(aes(TR_displacement_z, vowel_duration_z, colour = c2phonation)) +
    geom_point() +
    geom_smooth(method = "lm")
```

```{r tr-vowel-duration-vowel}
tongue_root %>%
    ggplot(aes(TR_displacement_z, vowel_duration_z, colour = c2phonation)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_grid(. ~ vowel)
```

```{r tr-vowel-duration-place}
tongue_root %>%
    ggplot(aes(TR_displacement_z, vowel_duration_z, colour = c2phonation)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_grid( ~ c2place)
```

```{r tr-vowel-duration-vowel-place}
tongue_root %>%
    ggplot(aes(TR_displacement_z, vowel_duration_z, colour = c2phonation)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_grid(c2place ~ vowel)
```

It does not seem to be a correlation. Maybe I should check TRA not at maximum TT/TD displacement?

```{r tr-phonation}
tongue_root %>%
    ggplot(aes(c2phonation, TR_displacement_z)) +
    geom_boxplot() +
    facet_grid(language ~ vowel)
```

/a/ and /o/ show more advancement in the voiced condition (lower TR_displacement).

```{r tra-lm-it}
tra_lm_it <- lmer(
    vowel_duration_z ~
        TR_displacement_z *
        c2place *
        vowel *
        c2phonation +
        (1+TR_displacement_z|speaker) +
        (1|word),
    data = filter(tongue_root, language == "italian"),
    REML = FALSE, 
    control = lmerControl(optimizer = "Nelder_Mead")
)

summary(tra_lm_it)
```

```{r}
plot(allEffects(tra_lm_it))
```

```{r}
coef(tra_lm_it)$speaker
```

The lmer detects a correlation, but I need to be cautious.

```{r}
mean_tra_lm <- lmer(
    TR_displacement_z ~
        c2phonation +
        vowel +
        c2place +
        (1|speaker) +
        (1|word),
    data = tongue_root
)
summary(mean_tra_lm)
```

```{r}
plot(allEffects(mean_tra_lm))
```

```{r tra-lm}
tra_lm <- lmer(
    vowel_duration_z ~
        TR_displacement_z *
        c2phonation *
        language *
        c2place *
        vowel +
        (1+TR_displacement_z|speaker) +
        (1|word),
    data = tongue_root
)

summary(tra_lm)
```

```{r tra-lm-effects}
plot(allEffects(tra_lm))
```

```{r tra-lm-pl}
tra_lm_pl <- lmer(
    vowel_duration_z ~
        TR_displacement_z +
        c2place +
        vowel *
        c2phonation +
        (1|speaker) +
        (1|word),
    data = filter(tongue_root, language == "polish")
)

summary(tra_lm_pl)

tra_lm_pl_null <- lmer(
    vowel_duration_z ~
#        TR_displacement_z *
        c2phonation +
        vowel +
        c2place +
        (1|speaker) +
        (1|word),
    data = filter(tongue_root, language == "polish")
)

anova(tra_lm_pl_null, tra_lm_pl)
```

```{r}
plot(allEffects(tra_lm_pl))
```

## More plotting

```{r it-tr-vowel-dur}
tongue_root %>%
  filter(language == "italian") %>%
    ggplot(aes(TR_displacement_z, vowel_duration_z)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_grid(c2place ~ vowel)
```

```{r pl-tr-vowel-dur}
tongue_root %>%
  filter(language == "polish") %>%
    ggplot(aes(TR_displacement_z, vowel_duration_z)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_grid(c2place ~ vowel)
```


# Using average curve distance

It does not work really.

```{r it01-polar-plot}
tongue %>%
  filter(speaker == "it01") %>%
  ggplot(aes(angle, radius, colour = c2phonation)) +
  geom_point() +
  facet_wrap(~vowel)
```

```{r}
it01 <- tongue %>%
  filter(speaker == "it02")

radius <- it01$radius
fan_line <- it01$fan_line
phonation <- it01$c2phonation
vowel <- it01$vowel
place <- it01$c2place
distance <- NULL

for (i in 1:length(radius)) {
  i_fan_line <- fan_line[i]
  fan_line_idx <- which(fan_line == i_fan_line)
  i_phonation <- phonation[i]
  phonation_index <- which(phonation[fan_line_idx] != i_phonation)
  neighbours <- radius[phonation_index]
  i_distance <- mean(abs(radius[i] - radius[neighbours]))
  
  distance <- c(distance, i_distance)
}

distance <- NULL

for (i in 1:length(radius)) {
  i_fan_line <- fan_line[i]
  fan_line_idx <- which(fan_line == i_fan_line)
  i_phonation <- phonation[i]
  phonation_idx <- which(phonation[fan_line_idx] == "voiceless")
  i_vowel <- vowel[i]
  vowel_idx <- which(vowel[phonation_idx] == i_vowel)
  i_place <- place[i]
  place_idx <- which(place[vowel_idx] == i_place)
  neighbours <- radius[place_idx]
  i_distance <- mean(abs(radius[i] - radius[neighbours]))
  
  distance <- c(distance, i_distance)
}

it01$distance <- distance

it01_dist <- it01 %>%
  na.omit() %>%
  group_by(rec.date) %>%
  summarise(distance = mean(distance)) %>%
  left_join(y = vowels) %>%
  left_join(y = words)
```

```{r}
it01_dist %>%
  ggplot(aes(distance, vowel.duration, colour = vowel)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(~ c2place)
```

```{r}
speakers <- levels(tongue$speaker)

distance <- NULL

for (speaker in 1:length(speakers)) {
  speaker_tbl <- filter(tongue, speaker == speakers[speaker])
  
  radius <- speaker_tbl$radius
  fan_line <- speaker_tbl$fan_line
  phonation <- speaker_tbl$c2phonation
  vowel <- speaker_tbl$vowel
  place <- speaker_tbl$c2place
  
  for (i in 1:length(radius)) {
    i_fan_line <- fan_line[i]
    fan_line_idx <- which(fan_line == i_fan_line)
    i_phonation <- phonation[i]
    phonation_index <- which(phonation[fan_line_idx] == "voiceless")
    i_vowel <- vowel[i_fan_line]
    vowel_index <- which(vowel[phonation_index] == i_vowel)
    i_place <- place[i_fan_line]
    place_index <- which(place[vowel_index] == i_place)
    neighbours <- radius[place_index]
    i_distance <- mean(abs(radius[i] - radius[neighbours]))
    distance <- c(distance, i_distance)
  }
}

get_tongue_distance <- function(data) {
  radius <- data$radius
  fan_line <- data$fan_line
  phonation <- data$c2phonation
  vowel <- data$vowel
  place <- data$c2place
  
  distance <- NULL
  
  for (i in 1:length(radius)) {
    i_fan_line <- fan_line[i]
    fan_line_idx <- which(fan_line == i_fan_line)
#    i_phonation <- phonation[i]
    phonation_idx <- which(phonation[fan_line_idx] == "voiceless")
    i_vowel <- vowel[i]
    vowel_idx <- which(vowel[phonation_idx] == i_vowel)
    i_place <- place[i]
    place_idx <- which(place[vowel_idx] == i_place)
    neighbours <- radius[place_idx]
    i_distance <- mean(abs(radius[i] - radius[neighbours]))
    distance <- c(distance, i_distance)
  }
  
  data$distance <- distance
  return(data)
}

tongue_distance <- tongue %>%
  group_by(speaker) %>%
  do(get_tongue_distance(.)) %>%
  na.omit() %>%
  group_by(rec.date) %>%
  summarise(distance = mean(distance)) %>%
  left_join(y = vowels) %>%
  left_join(y = languages) %>%
  inner_join(y = words) %>%
  mutate_if(is.character, as.factor)

```

```{r}
tongue_distance %>%
  filter(language == "italian") %>%
  ggplot(aes(distance, vowel.duration, colour = vowel)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~speaker + c2place)
```

```{r}
tongue_distance %>%
  filter(language == "polish") %>%
  ggplot(aes(distance, vowel.duration, colour = vowel)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~speaker + c2place)
```

```{r}
distance_lm <- lmer(
  vowel.duration ~
    distance *
    vowel *
    c2place *
    language +
    (1+distance|speaker),
  data = tongue_distance
)

summary(distance_lm)
```

```{r}
plot(allEffects(distance_lm))
```

