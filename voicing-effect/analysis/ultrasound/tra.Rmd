---
title: "Tongue root advancement"
author: "Stefano Coretta"
date: "11/03/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../../"))
library(tidyverse)
theme_set(theme_bw())
library(lme4)
library(effects)
library(mgcv)
library(itsadug)
library(tidymv)
library(rticulate)
library(dendextend)
```

# Read data

```{r read-data, message=FALSE}
columns <- c(
  "speaker",
  "seconds",
  "rec_date",
  "prompt",
  "label",
  "TT_displacement_sm",
  "TT_velocity",
  "TT_velocity_abs",
  "TD_displacement_sm",
  "TD_velocity",
  "TD_velocity_abs",
  "TR_displacement_sm",
  "TR_velocity",
  "TR_velocity_abs"
)

speakers <- read_csv("./voicing-effect/data/datasets/speakers.csv")
stimuli <- read_csv("./voicing-effect/data/datasets/stimuli.csv")

duration <- list.files(
  path = "voicing-effect/data/datasets/acoustics/",
  pattern = "*-durations.csv",
  full.names = TRUE
) %>%
  map_df(~read_csv(., na = "--undefined--")) %>%
  select(-speaker)

tra_series <- list.files(
  path = "./voicing-effect/data/datasets/ultrasound",
  pattern = "*-vowel-series.tsv",
  full.names = TRUE
) %>%
  read_aaa(., columns, format = "wide") %>%
  select(-(X_1:Y_42)) %>%
  left_join(duration) %>%
  mutate(word = word(prompt, 2)) %>%
  left_join(y = speakers) %>%
  left_join(y = stimuli) %>%
  mutate(
    c2_phonation = ordered(c2_phonation, levels = c("voiceless", "voiced")),
    vowel = ordered(vowel, levels = c("a", "o", "u")),
    c2_place = ordered(c2_place, levels = c("coronal", "velar")),
    proportion = (seconds - v_onset) / (v_offset - v_onset),
    tra = -TR_displacement_sm
  ) %>%
  group_by(speaker) %>%
  mutate(tra_z = scale(tra)) %>%
  ungroup() %>%
  mutate_if(is.character, as.factor) %>%
  mutate(
    speaker_phon = interaction(speaker, c2_phonation),
    speaker_contexts = interaction(speaker, c2_phonation, c2_place, vowel),
    place_vowel = interaction(c2_place, vowel),
    place_vowel_phon = interaction(c2_place, vowel, c2_phonation)
  ) %>%
  filter(rec_date != "28/07/2017 15:40:44", c1_phonation == "voiceless") %>%
  arrange(rec_date, seconds) %>%
  create_event_start("rec_date")

contrasts(tra_series$c2_phonation) <- "contr.treatment"
contrasts(tra_series$vowel) <- "contr.treatment"
contrasts(tra_series$c2_place) <- "contr.treatment"
contrasts(tra_series$vowel) <- "contr.treatment"
contrasts(tra_series$place_vowel) <- "contr.treatment"
contrasts(tra_series$place_vowel_phon) <- "contr.treatment"

tra_difference <- list.files(
  path = "./voicing-effect/data/datasets/ultrasound",
  pattern = "*-vowel-series.tsv",
  full.names = TRUE
) %>%
  read_aaa(., columns, format = "wide") %>%
  select(-(X_1:Y_42)) %>%
  left_join(duration) %>%
  mutate(word = word(prompt, 2)) %>%
  left_join(y = speakers) %>%
  left_join(y = stimuli) %>%
  filter(c1_phonation == "voiceless") %>%
  mutate(tra = -TR_displacement_sm) %>%
  arrange(rec_date, seconds) %>%
  create_event_start("rec_date") %>%
  group_by(rec_date) %>%
  filter(row_number() %in% c(1, n())) %>%
  ungroup() %>%
  mutate(
    position = ifelse(start.event == TRUE, "start", "end"),
    c2_phonation = factor(c2_phonation, levels = c("voiceless", "voiced")),
    vowel = factor(vowel, levels = c("a", "o", "u")),
    c2_place = factor(c2_place, levels = c("coronal", "velar"))
  ) %>%
  select(-seconds, -(TT_displacement_sm:TR_velocity_abs), -start.event) %>%
  spread(position, tra) %>%
  mutate(
    tra_difference = end - start
  ) %>%
  mutate_if(is.character, as.factor)
  

tongue_root <- list.files(
  path = "./voicing-effect/data/datasets/ultrasound/",
  pattern = "*-tongue-cart.tsv",
  full.names = TRUE
) %>%
  map_df(~read_aaa(., column_names = columns, format = "wide")) %>%
  select(-(X_1:Y_42)) %>%
  filter(label == "closure_") %>%
  mutate(word = word(prompt, 2)) %>%
  left_join(y = speakers) %>%
  left_join(y = stimuli) %>%
  mutate(
    c2_phonation = factor(c2_phonation, levels = c("voiceless", "voiced")),
    tra = -TR_displacement_sm
  ) %>%
  mutate_if(is.character, as.factor) %>%
  # filter clear outlier
  filter(TR_displacement_sm > 40, c1_phonation == "voiceless") %>%
  group_by(speaker) %>%
  mutate(tra_z = scale(tra)) %>%
  ungroup()

tongue_root_max <- list.files(
  path = "./voicing-effect/data/datasets/ultrasound/",
  pattern = "*-tongue-cart.tsv",
  full.names = TRUE
) %>%
  map_df(~read_aaa(., column_names = columns, format = "wide")) %>%
  select(-(X_1:Y_42)) %>%
  filter(label %in% c("max_TT", "max_TD")) %>%
  mutate(word = word(prompt, 2)) %>%
  left_join(y = speakers) %>%
  left_join(y = stimuli) %>%
  mutate(
    c2_phonation = factor(c2_phonation, levels = c("voiceless", "voiced")),
    tra = -TR_displacement_sm
  ) %>%
  mutate_if(is.character, as.factor) %>%
  # filter clear outlier
  filter(TR_displacement_sm > 40, c1_phonation == "voiceless") %>%
  group_by(speaker) %>%
  mutate(tra_z = scale(tra)) %>%
  ungroup()
```

# Tongue root advancement at closure

Tongue root advancement is calculated as the inverse of tongue root displacement along a selected fan line.

```{r tr-density-phonation}
tongue_root %>%
  ggplot(aes(tra_z, fill = c2_phonation, linetype = c2_phonation, colour = c2_phonation)) +
  geom_density(alpha = 0.2)
```

As a general trend, the root is more advanced in the voiced condition.

```{r tr-strip-voicing}
tongue_root %>%
  ggplot(aes(tra_z, c2_phonation)) +
  geom_jitter(alpha = 0.2)
```

There are two clear outliers with `tra_z > 4`.

```{r tr-density-language}
tongue_root %>%
    ggplot(aes(tra_z, fill = c2_phonation, linetype = c2_phonation, colour = c2_phonation)) +
    geom_density(alpha = 0.2) +
    facet_grid(. ~ language)
```

The pattern is stronger in Italian than in Polish.
This makes sense, given that most Polish speakers do not show differences in root position.

```{r tra-hist}
tongue_root %>%
  ggplot(aes(tra_z)) +
  geom_histogram(bins = 15)
```

```{r tra-density}
tongue_root %>%
  ggplot(aes(tra_z)) +
  geom_density() +
  geom_rug()
```

```{r tra-density-vowel}
tongue_root %>%
  ggplot(aes(tra_z, fill = vowel, linetype = vowel)) +
  geom_density(alpha = 0.5)
```

/u/ is bimodally distributed.
There is no clear pattern in terms of TRA and vowel height.

```{r tra-density-vowel-language}
tongue_root %>%
  ggplot(aes(tra_z, fill = vowel, linetype = vowel)) +
  geom_density(alpha = 0.5) +
  facet_grid(~ language)
```

Italian /u/ has a big peak after the peak of /a/ but there another peak at values that are inferior of those of /o/.

```{r tra-density-a}
tongue_root %>%
  filter(vowel == "a") %>%
  ggplot(aes(tra_z, fill = c2_phonation, linetype = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(language ~ c2_place)
```

```{r tra-density-o}
tongue_root %>%
  filter(vowel == "o") %>%
  ggplot(aes(tra_z, fill = c2_phonation, linetype = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(language ~ c2_place)
```

The two outliers are tokens of /o/.

```{r}
tongue_root %>%
  filter(vowel == "u") %>%
  ggplot(aes(tra_z, fill = c2_phonation, linetype = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(language ~ c2_place)
```

/u/ shows bimodally distributions but I don't know why.

```{r tra-density-speakers}
tongue_root %>%
  filter(vowel == "u") %>%
  ggplot(aes(tra_z, fill = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(speaker ~ c2_place)
```

```{r tra-boxplot}
tongue_root %>%
  ggplot(aes(c2_phonation, tra_z)) +
  geom_violin() +
  geom_boxplot(width = 0.2) +
  facet_grid(. ~ language)
```

```{r tra-boxplot-filtered}
tongue_root %>%
  filter(tra_z < 3) %>%
  ggplot(aes(c2_phonation, tra_z)) +
  geom_violin() +
  geom_boxplot(width = 0.2) +
  facet_grid(. ~ language)
```

```{r tra-boxplot-speakers}
tongue_root %>%
  filter(tra_z < 3) %>%
  ggplot(aes(c2_phonation, tra_z)) +
  geom_boxplot() +
  facet_wrap(~ speaker, ncol = 4)
```

```{r tra-boxplot-speakers-2}
tongue_root %>%
  filter(tra_z < 3) %>%
  ggplot(aes(speaker, tra_z, fill = c2_phonation)) +
  geom_boxplot()
```

```{r tra-italian}
tongue_root %>%
  filter(language == "italian") %>%
    ggplot(aes(c2_phonation, tra_z)) +
    geom_boxplot() +
    facet_grid(c2_place ~ vowel)
```

```{r tra-density-vowels-filtered}
tongue_root %>%
  filter(tra_z < 4) %>%
  ggplot(aes(tra_z, fill = vowel, colour = vowel, linetype = vowel)) +
  geom_density(alpha = 0.5, size = 0.7) +
  scale_linetype_manual(values = c("solid", "dotted", "longdash")) +
  labs(x = "tongue root advancement (z-scores)")
```

```{r tra-density-vowels-place-language}
tongue_root %>%
  filter(tra_z < 4) %>%
  ggplot(aes(tra_z, fill = vowel, colour = vowel, linetype = vowel)) +
  geom_density(alpha = 0.5, size = 0.7) +
  scale_linetype_manual(values = c("solid", "dotted", "longdash")) +
  labs(x = "tongue root advancement (z-scores)") +
  facet_grid(language ~ c2_place)
```

The bimodal distribution of /u/ seems to be related to the velar condition, especially in Italian.

## LMER

```{r tra-lm}
tra_lm <- lmer(
  tra ~
    c2_phonation +
    vowel +
    (1+c2_phonation|speaker) +
    (1|item),
  data = filter(tongue_root, tra_z < 3),
  REML = FALSE
)

summary(tra_lm)

tra_lm_null <- lmer(
  tra ~
#    c2_phonation +
    vowel +
    (1+c2_phonation|speaker) +
    (1|item),
  data = filter(tongue_root, tra_z < 3),
  REML = FALSE
)

anova(tra_lm_null, tra_lm)
```

```{r}
plot(allEffects(tra_lm))
```

```{r tra-z-lm}
tra_z_lm <- lmer(
  tra_z ~
    c2_phonation +
    vowel +
    (1+c2_phonation|speaker) +
    (1|item),
  data = filter(tongue_root, tra_z < 3),
  REML = FALSE
)

summary(tra_z_lm)

tra_z_lm_null <- lmer(
  tra_z ~
#    c2_phonation +
    vowel +
    (1+c2_phonation|speaker) +
    (1|item),
  data = filter(tongue_root, tra_z < 3),
  REML = FALSE
)

anova(tra_z_lm_null, tra_z_lm)
```

```{r}
plot(allEffects(tra_z_lm))
```

```{r}
as_tibble(ranef(tra_z_lm)$speaker[2], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, c2_phonationvoiced, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker random coefficients", y = "TRA (scaled)")
```

```{r}
as_tibble(coef(tra_z_lm)$speaker[2], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, c2_phonationvoiced, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker random coefficients", y = "TRA (scaled)")
```

```{r tra-rand-lm}
tra_rand_lm <- lmer(
  tra ~
    c2_phonation +
    vowel +
    c2_place +
    (1+c2_phonation|speaker) +
    (1|item),
  data = filter(tongue_root, tra_z < 3),
  REML = FALSE
)

summary(tra_rand_lm)

tra_rand_lm_null <- lmer(
  tra ~
 #   c2_phonation +
    vowel +
    c2_place +
    (1+c2_phonation|speaker) +
   (1|item),
  data = filter(tongue_root, tra_z < 3),
  REML = FALSE
)

anova(tra_rand_lm_null, tra_rand_lm)
```

```{r}
plot(allEffects(tra_rand_lm))
```


```{r tra-rand-lm-ranef-coeff}
as_tibble(ranef(tra_rand_lm)$speaker[2], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, c2_phonationvoiced, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker random coefficients", y = "mm")
```

```{r tra-rand-lm-ranef-intercept}
as_tibble(ranef(tra_rand_lm)$speaker[1], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, `(Intercept)`, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker random intercepts", y = "mm")
```

```{r tra-rand-lm-coef}
as_tibble(coef(tra_rand_lm)$speaker[2], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, c2_phonationvoiced, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker coefficients", y = "mm")
```

```{r tra-rand-lm-coef-intercept}
as_tibble(coef(tra_rand_lm)$speaker[1], rownames = "speaker") %>%
  mutate(language = c(rep("Italian", 11), rep("Polish", 6))) %>%
  ggplot(aes(speaker, `(Intercept)`, fill = language)) +
  geom_bar(stat = "identity") +
  labs(title = "By-speaker intercepts", y = "mm")
```

```{r tra-max-lm}
tra_max_lm <- lmer(
  tra ~
    c2_phonation +
    vowel +
    (1+c2_phonation|speaker) +
    (1|word),
  data = filter(tongue_root_max, tra_z < 3)
)

summary(tra_lm)

tra_max_lm_null <- lmer(
  tra ~
#    c2_phonation +
    vowel +
    (1+c2_phonation|speaker) +
    (1|word),
  data = filter(tongue_root_max, tra_z < 3)
)

anova(tra_max_lm_null, tra_max_lm)
```

# TRA trajectories

```{r}
tra_series %>%
  ggplot(aes(proportion, tra_z, colour = c2_phonation, group = rec_date)) +
  geom_line(alpha = 0.2)
```

```{r}
tra_series %>%
  ggplot(aes(proportion, tra_z, colour = c2_phonation)) +
  geom_smooth()
```

```{r}
tra_series %>%
  ggplot(aes(proportion, tra_z, colour = c2_phonation, linetype = c2_phonation)) +
  geom_smooth(method = "auto") +
  facet_wrap(~ speaker, ncol = 4)
```

```{r}
tra_series %>%
  ggplot(aes(proportion, tra_z, colour = c2_phonation)) +
  geom_smooth(se = TRUE) +
  facet_wrap(~ speaker, ncol = 4)
```

```{r}
tra_series %>%
  ggplot(aes(proportion, tra_z, colour = c2_phonation, linetype = c2_phonation)) +
  geom_smooth() +
  facet_grid(c2_place ~ vowel)
```

```{r}
tra_series %>%
  filter(speaker == "it01") %>%
  ggplot(aes(proportion, tra_z, colour = c2_phonation, linetype = c2_phonation)) +
  geom_smooth() +
  facet_grid(c2_place ~ vowel)
```

```{r}
tra_series %>%
  filter(speaker == "it01", c2_place == "coronal", vowel != "u") %>%
  ggplot(aes(proportion, tra_z, colour = c2_phonation, linetype = c2_phonation)) +
  geom_smooth() +
  facet_grid(c2_place ~ vowel)
```

```{r}
tra_series %>%
  filter(speaker == "it02") %>%
  ggplot(aes(proportion, tra_z, colour = c2_phonation, linetype = c2_phonation)) +
  geom_smooth() +
  facet_grid(c2_place ~ vowel)
```

```{r}
tra_series %>%
  filter(speaker == "pl05") %>%
  ggplot(aes(proportion, tra_z, colour = c2_phonation, linetype = c2_phonation)) +
  geom_smooth() +
  facet_grid(c2_place ~ vowel)
```

### Normalised

```{r tra-series-gam}
tra_series_gam <- bam(
  tra_z ~
    c2_phonation +
    vowel +
    c2_place +
    s(proportion, bs = "cr", k = 3) +
    s(proportion, by = c2_phonation, bs = "cr", k = 3) +
    s(proportion, by = vowel, bs = "cr", k = 3) +
    s(proportion, by = c2_place, bs = "cr", k = 3) +
    s(proportion, rec_date, bs = "fs", m = 1, xt = "cr", k = 3) +
    s(proportion, speaker_contexts, bs = "fs", m = 1, xt = "cr", k = 3),
  data = tra_series
)

summary(tra_series_gam)
```

```{r tra-series-gam-acf}
acf_plot(resid(tra_series_gam), split_by = list(tra_series$rec_date))
```

```{r tra-series-gam-smooths}
tra_series_gam_pred <- get_gam_predictions(
  tra_series_gam,
  proportion,
  exclude_random = FALSE,
  exclude_terms = "s(proportion,rec_date)"
) %>%
  separate(speaker_contexts, c("speaker", "c2_phonation_a", "c2_place_b", "vowel_c"))

filter(tra_series_gam_pred, vowel == "a", c2_place == "coronal") %>%
  ggplot(aes(proportion, tra_z)) +
  geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper, fill = c2_phonation), alpha = 0.2) +
  geom_path(aes(colour = c2_phonation)) +
  facet_wrap(~ speaker, ncol = 4)

filter(tra_series_gam_pred, vowel == "o", c2_place == "coronal") %>%
  ggplot(aes(proportion, tra_z)) +
  geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper, fill = c2_phonation), alpha = 0.2) +
  geom_path(aes(colour = c2_phonation)) +
  facet_wrap(~ speaker, ncol = 4)

filter(tra_series_gam_pred, vowel == "u", c2_place == "coronal") %>%
  ggplot(aes(proportion, tra_z)) +
  geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper, fill = c2_phonation), alpha = 0.2) +
  geom_path(aes(colour = c2_phonation)) +
  facet_wrap(~ speaker, ncol = 4)
```

### Non-normalised

```{r tra-series-gam-non-z}
tra_series_gam_2 <- bam(
  tra ~
    c2_phonation +
    vowel +
    c2_place +
    s(proportion, bs = "cr") +
    s(proportion, by = c2_phonation, bs = "cr") +
    s(proportion, by = vowel, bs = "cr") +
    s(proportion, by = c2_place, bs = "cr") +
#    s(proportion, rec_date, bs = "fs", m = 1, xt = "cr") +
    s(proportion, speaker_contexts, bs = "fs", m = 1, xt = "cr"),
  data = tra_series
)

summary(tra_series_gam_2)
```

```{r}
pred_2 <- get_gam_predictions(tra_series_gam, proportion, exclude_random = FALSE) %>%
  separate(speaker_contexts, c("speaker", "a", "b", "c"))

filter(pred_2, vowel == "a", c2_place == "coronal") %>%
  ggplot(aes(proportion, tra_z)) +
  geom_ribbon(aes(ymin = CI_lower,ymax = CI_upper, fill = c2_phonation), alpha = 0.2) +
  geom_path(aes(colour = c2_phonation)) +
  facet_wrap(~ speaker, ncol = 4)
```

```{r tra-series-gam-pl05}
tra_series_gam_pl05 <- bam(
  tra_z ~
    c2_phonation +
    vowel +
    c2_place +
    s(proportion) +
    s(proportion, by = c2_phonation) +
    s(proportion, by = vowel) +
    s(proportion, by = c2_place),
  data = filter(tra_series, speaker == "it13")
)

summary(tra_series_gam_pl05)
```

```{r}
plot_smooths(
  tra_series_gam_pl05,
  proportion,
  c2_phonation,
  facet_terms = c2_place + vowel
)
```

# Using average curve distance

It does not work really.

```{r it01-polar-plot}
tongue %>%
  filter(speaker == "it01") %>%
  ggplot(aes(angle, radius, colour = c2_phonation)) +
  geom_point() +
  facet_wrap(~vowel)
```

```{r}
it01 <- tongue %>%
  filter(speaker == "it02")

radius <- it01$radius
fan_line <- it01$fan_line
phonation <- it01$c2_phonation
vowel <- it01$vowel
place <- it01$c2_place
distance <- NULL

for (i in 1:length(radius)) {
  i_fan_line <- fan_line[i]
  fan_line_idx <- which(fan_line == i_fan_line)
  i_phonation <- phonation[i]
  phonation_index <- which(phonation[fan_line_idx] != i_phonation)
  neighbours <- radius[phonation_index]
  i_distance <- mean(abs(radius[i] - radius[neighbours]))
  
  distance <- c(distance, i_distance)
}

distance <- NULL

for (i in 1:length(radius)) {
  i_fan_line <- fan_line[i]
  fan_line_idx <- which(fan_line == i_fan_line)
  i_phonation <- phonation[i]
  phonation_idx <- which(phonation[fan_line_idx] == "voiceless")
  i_vowel <- vowel[i]
  vowel_idx <- which(vowel[phonation_idx] == i_vowel)
  i_place <- place[i]
  place_idx <- which(place[vowel_idx] == i_place)
  neighbours <- radius[place_idx]
  i_distance <- mean(abs(radius[i] - radius[neighbours]))
  
  distance <- c(distance, i_distance)
}

it01$distance <- distance

it01_dist <- it01 %>%
  na.omit() %>%
  group_by(rec.date) %>%
  summarise(distance = mean(distance)) %>%
  left_join(y = vowels) %>%
  left_join(y = words)
```

```{r}
it01_dist %>%
  ggplot(aes(distance, vowel.duration, colour = vowel)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(~ c2_place)
```

```{r}
speakers <- levels(tongue$speaker)

distance <- NULL

for (speaker in 1:length(speakers)) {
  speaker_tbl <- filter(tongue, speaker == speakers[speaker])
  
  radius <- speaker_tbl$radius
  fan_line <- speaker_tbl$fan_line
  phonation <- speaker_tbl$c2_phonation
  vowel <- speaker_tbl$vowel
  place <- speaker_tbl$c2_place
  
  for (i in 1:length(radius)) {
    i_fan_line <- fan_line[i]
    fan_line_idx <- which(fan_line == i_fan_line)
    i_phonation <- phonation[i]
    phonation_index <- which(phonation[fan_line_idx] == "voiceless")
    i_vowel <- vowel[i_fan_line]
    vowel_index <- which(vowel[phonation_index] == i_vowel)
    i_place <- place[i_fan_line]
    place_index <- which(place[vowel_index] == i_place)
    neighbours <- radius[place_index]
    i_distance <- mean(abs(radius[i] - radius[neighbours]))
    distance <- c(distance, i_distance)
  }
}

get_tongue_distance <- function(data) {
  radius <- data$radius
  fan_line <- data$fan_line
  phonation <- data$c2_phonation
  vowel <- data$vowel
  place <- data$c2_place
  
  distance <- NULL
  
  for (i in 1:length(radius)) {
    i_fan_line <- fan_line[i]
    fan_line_idx <- which(fan_line == i_fan_line)
#    i_phonation <- phonation[i]
    phonation_idx <- which(phonation[fan_line_idx] == "voiceless")
    i_vowel <- vowel[i]
    vowel_idx <- which(vowel[phonation_idx] == i_vowel)
    i_place <- place[i]
    place_idx <- which(place[vowel_idx] == i_place)
    neighbours <- radius[place_idx]
    i_distance <- mean(abs(radius[i] - radius[neighbours]))
    distance <- c(distance, i_distance)
  }
  
  data$distance <- distance
  return(data)
}

tongue_distance <- tongue %>%
  group_by(speaker) %>%
  do(get_tongue_distance(.)) %>%
  na.omit() %>%
  group_by(rec.date) %>%
  summarise(distance = mean(distance)) %>%
  left_join(y = vowels) %>%
  left_join(y = languages) %>%
  inner_join(y = words) %>%
  mutate_if(is.character, as.factor)

```

```{r}
tongue_distance %>%
  filter(language == "italian") %>%
  ggplot(aes(distance, vowel.duration, colour = vowel)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~speaker + c2_place)
```

```{r}
tongue_distance %>%
  filter(language == "polish") %>%
  ggplot(aes(distance, vowel.duration, colour = vowel)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~speaker + c2_place)
```

```{r}
distance_lm <- lmer(
  vowel.duration ~
    distance *
    vowel *
    c2_place *
    language +
    (1+distance|speaker),
  data = tongue_distance
)

summary(distance_lm)
```

```{r}
plot(allEffects(distance_lm))
```

# Clustering TRA

```{r}
tra_summary <- tongue_root %>%
  select(speaker, TT_displacement_sm, TD_displacement_sm, TR_displacement_sm, c2_phonation) %>%
  gather(tongue, value, TT_displacement_sm, TD_displacement_sm, TR_displacement_sm) %>%
  unite("tongue", tongue, c2_phonation) %>%
  group_by(speaker, tongue) %>%
  summarise(
    value = mean(value)
  ) %>%
  spread(tongue, value) %>%
  mutate(
    TT = TT_displacement_sm_voiceless - TT_displacement_sm_voiced,
    TD = TD_displacement_sm_voiceless - TD_displacement_sm_voiced,
    TR = TR_displacement_sm_voiceless - TR_displacement_sm_voiced
  ) %>%
  select(speaker, TT, TD, TR)

row.names(tra_summary) <- tra_summary$speaker

tra_distance <- dist(tra_summary)

tra_clust <- hclust(tra_distance)
```

```{r}
tra_clust %>%
  as.dendrogram %>%
  as.ggdend() %>%
  ggplot(horiz = TRUE)
```

# Tongue root displacement between vowel onsent and offset

```{r tra-difference-density}
tra_difference %>%
  ggplot(aes(tra_difference, fill = c2_phonation)) +
  geom_density(alpha = 0.5)
```

```{r tra-difference-density-vowplace}
tra_difference %>%
  ggplot(aes(tra_difference, fill = c2_phonation)) +
  geom_density(alpha = 0.5) +
  facet_grid(c2_place ~ vowel)
```

```{r tra-diff-dur}
tra_difference %>%
  ggplot(aes(tra_difference, vowel_duration)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r tra-difference-lm}
tra_difference_lm <- lmer(
  tra_difference ~
    vowel_duration +
    c2_phonation +
    vowel +
    (1|speaker) +
    (1|item),
  data = tra_difference,
  REML = FALSE
)
summary(tra_difference_lm)

tra_difference_lm_null <- lmer(
  tra_difference ~
    vowel_duration +
#    c2_phonation +
    vowel +
    (1|speaker) +
    (1|item),
  data = tra_difference,
  REML = FALSE
)

anova(tra_difference_lm_null, tra_difference_lm)
```

```{r tra-difference-lm-plot}
plot(allEffects(tra_difference_lm))
```

The difference in TR displacement between vowel onset and offset increases with increasing vowel duration.
There is a tendency for the difference to be greater in voiced stops, although, considering the inter-speaker variation, it is not surprising that it is not deemed significant.
There is no significant interaction of voicing and vowel duration.
