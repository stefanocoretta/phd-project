---
title: "Pilot study of Lombard voicing"
author: "Stefano Coretta"
date: "20/09/2017"
output: 
  html_document: 
    highlight: tango
    number_sections: yes
    theme: paper
  pdf_document: 
    highlight: tango
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = normalizePath("../../"))
library(tidyverse)
theme_set(theme_minimal())
library(speakr)
library(lme4)
library(lmerTest)
library(effects)
```

# Extract data

```{r speakr, eval = FALSE}
lmt("./lombard/code/get-measurements.praat.md")
praat_run("./lombard/code/get-measurements.praat")
lmt("./lombard/code/egg.praat.md")
praat_run("./lombard/code/get-voicing.praat", 40, 10000, 11, 0)
```

# Import data

```{r read-data}
stimuli <- read_csv("./lombard/task/prompts.csv")

acoustics <- read_csv("./lombard/results/acoustics.csv", na = "--undefined--") %>%
    left_join(y = stimuli)

durations <- read_csv("./lombard/results/durations.csv", na = "--undefined--") %>%
    left_join(y = stimuli) %>%
    mutate_if(is.character, as.factor) %>%
    mutate(
        voicing = factor(voicing, levels = c("voiceless", "voiced")),
        position = factor(position, levels = c("medial", "final")),
        place = factor(place, levels = c("velar", "coronal", "labial"))
    )

voicing <- read_csv("./lombard/results/voicing.csv", na = "--undefined--") %>%
    left_join(y = stimuli) %>%
    mutate(
        voicing = factor(voicing, levels = c("voiceless", "voiced")),
        position = factor(position, levels = c("medial", "final")),
        place = factor(place, levels = c("velar", "coronal", "labial")),
        devoicing = ifelse(voicing_duration > consonant_duration / 2, "voiced", "devoiced"),
        devoicing_3 = ifelse(voicing_duration > consonant_duration / 3, "voiced", "devoiced"),
        devoiced = ifelse(
            voicing_duration < consonant_duration / 5, "1_5",
            ifelse(
                voicing_duration < consonant_duration / 5 * 2, "2_5",
                ifelse(
                    voicing_duration < consonant_duration / 5 * 3, "3_5",
                    ifelse(
                        voicing_duration < consonant_duration / 5 * 4, "4_5",
                        "voiced"
                    )
                )
            )
        )
    ) %>%
    mutate_if(is.character, as.factor)
```

# Vowel duration

```{r vowel-duration-speaker-plot}
durations %>%
    ggplot(aes(voicing, vowel_duration, colour = position)) +
    geom_boxplot() +
    facet_grid(speaker ~ vowel)
```

```{r vowel-duration-plot}
durations %>%
    ggplot(aes(voicing, vowel_duration, colour = position)) +
    geom_boxplot() +
    facet_grid( ~ vowel)
```

```{r duration-plot}
durations %>%
    ggplot(aes(position, vowel_duration, colour = voicing)) +
    geom_boxplot()
```

```{r vowel-duration-plot-speakers}
durations %>%
    ggplot(aes(position, vowel_duration, colour = voicing)) +
    geom_boxplot() +
    facet_grid(. ~ speaker)
```

```{r vowel-duration-lmer}
vowel_dur_lm <- lmer(
    vowel_duration ~
        voicing *
        position +
        manner +
        place +
        (1|speaker) +
        (1|word),
    data = durations
)

summary(vowel_dur_lm)

vowel_dur_lm_null <- lmer(
    vowel_duration ~
        voicing *
#        position +
        manner +
        place +
        (1|speaker) +
        (1|word),
    data = durations
)

anova(vowel_dur_lm_null, vowel_dur_lm)
```

```{r vowel-duration-lmer-effects}
plot(allEffects(vowel_dur_lm))
```

# Consonant duration

```{r consonant-duration-plot}
durations %>%
    ggplot(aes(position, consonant_duration, colour = voicing)) +
    geom_boxplot()
```

```{r consonant-duration-lmer}
c_dur_lm <- lmer(
    consonant_duration ~
        voicing *
        position +
        manner +
        place +
        (1|speaker) +
        (1|word),
    data = durations
)

summary(c_dur_lm)

c_dur_lm_null <- lmer(
    consonant_duration ~
        voicing *
#        position +
        manner +
        place +
        (1|speaker) +
        (1|word),
    data = durations
)

anova(c_dur_lm_null, c_dur_lm)
```

```{r consonant-duration-lmer-effects}
plot(allEffects(c_dur_lm))
```

# Word duration

```{r word-duration-plot}
durations %>%
    ggplot(aes(position, word_duration, colour = voicing)) +
    geom_boxplot() +
    ylab("Word duration (seconds)")
```

# Vowel and consonant duration

```{r vowel-consonant-duration-plot}
durations %>%
    ggplot(aes(consonant_duration, vowel_duration, colour = voicing)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_grid(position ~ .)
```

# Acoustics

```{r f1-plot}
acoustics %>%
    ggplot(aes(point, f1, colour = voicing)) +
    geom_jitter(alpha = 0.5) +
    geom_smooth() +
    facet_wrap(~ vowel)
```

```{r f1-time-norm-plot}
acoustics %>%
    ggplot(aes(time_norm, f1, colour = voicing)) +
    geom_point(alpha = 0.5) +
    geom_smooth() +
    facet_wrap(~ vowel)
```

```{r f2-plot}
acoustics %>%
    ggplot(aes(point, f2, colour = voicing)) +
    geom_jitter(alpha = 0.5) +
    geom_smooth() +
    facet_wrap(~ vowel)
```

```{r pitch, eval = FALSE}
acoustics %>%
    filter(pitch < 400) %>%
    ggplot(aes(point, pitch, colour = voicing)) +
    geom_jitter(alpha = 0.5) +
    geom_smooth() +
    facet_wrap(position ~ speaker)
```

```{r pitch, eval = FALSE}
acoustics %>%
    filter(pitch < 400) %>%
    ggplot(aes(point, pitch, group = time, colour = voicing)) +
    geom_line() +
    facet_wrap(~ speaker)
```

# Proportions

```{r proportions}
proportions <- durations %>%
    group_by(speaker,voicing, position) %>%
    summarise(
        total = 
            mean(vowel_duration, na.rm = TRUE) +
            mean(consonant_duration, na.rm = TRUE),
        vowel = mean(vowel_duration, na.rm = TRUE),
        consonant = mean(consonant_duration, na.rm = TRUE)
    ) %>%
    gather(segment, duration, vowel:consonant) %>%
    mutate(segment = factor(segment,
                            levels = c("consonant", "vowel")
                            )
           )
```

There is sentence final lengthening. The medial V-to-C ratio is not maintained in final position. The magnitude of the voicing effect increases in sentence final position. The plot averages accross speakers.

```{r plot-proportions}
ggplot(proportions, aes(voicing, duration, fill = segment)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    facet_grid(position ~ .) +
    guides(fill = guide_legend(reverse = TRUE))
```

Plot with individual speakers.

```{r plot-proportions-speakers}
ggplot(proportions, aes(voicing, duration, fill = segment)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    facet_grid(position ~ speaker) +
    guides(fill = guide_legend(reverse = TRUE))
```

# Voicing durations

There is some voicing bleed in voiceless consonants in both speakers. Voicing duration in voiced consonants varies. (Boxplots used here, although voicing can be 0). LM02 devoiced more in sentence-final position compared to LM01.

```{r voicing-duration-boxplot}
voicing %>%
    ggplot(aes(voicing, voicing_duration)) +
    geom_boxplot() +
    facet_grid(speaker ~ position)
```

```{r voicing-duration-manner-boxplot}
voicing %>%
    ggplot(aes(voicing, voicing_duration)) +
    geom_boxplot() +
    facet_grid(speaker + manner ~ position)
```

```{r voicing-duration-density}
voicing %>%
    ggplot(aes(voicing_duration,colour = voicing)) +
    geom_density() +
    facet_grid(speaker ~ position)
```

The following plots the number of voiced consonants that are `voiced` (voicing duration > 50% of consonant duration), or `devoiced` (voicing duration < 50% of consonant duration). Two patterns emerge. (1) LM01 more consistently employes voiced consonants in sentence-medial position, while there's a 50:50 chance at sentence-final position (but cf. below). (2) LM02 has about 50:50 chance at sentence medial position, but strongly favours devoicing at sentence=final position.


```{r devoicing-2}
voicing %>%
    filter(voicing == "voiced") %>%
    ggplot(aes(devoicing)) +
    geom_bar() +
    facet_grid(speaker ~ position)
```

Things change a bit if the cut off is at 1/3 of the consonant duration (rather than 1/2). LM01 favours consonants with more than 1/3 voicing in sentence-final.

```{r devoicing-3}
voicing %>%
    filter(voicing == "voiced") %>%
    ggplot(aes(devoicing_3)) +
    geom_bar() +
    facet_grid(speaker ~ position)
```

This is probably the most insightful plot. Here bins are created at each fifth of consonant duration: 1_5 means voicing duration < 1/5 of consonant duration, 2_5 means < 2/5 and > 1/5, and so on... The idiosyncratic patterns of sentence final devoicing is interesting: LM01 doesn't really favours one bin over the other. For LM02 devoiced consonants in sentence final position with less than 1/5 of consonant duration seem to be favoured.

```{r devoiced}
voicing %>%
    filter(voicing == "voiced") %>%
    ggplot(aes(devoiced)) +
    geom_bar() +
    facet_grid(speaker ~ position)
```

```{r devoiced-manner}
voicing %>%
    filter(voicing == "voiced") %>%
    ggplot(aes(devoiced)) +
    geom_bar() +
    facet_grid(speaker ~ position + manner)
```
