---
title: "Vowel duration"
author: "Stefano Coretta"
date: \today
output: 
  pdf_document: 
    fig_caption: yes
    latex_engine: xelatex
    number_sections: yes
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE)
opts_knit$set(root.dir=normalizePath("../../"))
library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(lme4)
library(afex)
library(effects)
library(ggplot2)
theme_set(theme_bw())
```

# Import data

Let's read the files.

```{r read-files}
vowels <- list.files(path = "pilot/results",
                   pattern = "*-vowel-durations.csv",
                   full.names = TRUE) %>%
    map_df(~read_csv(., na = "--undefined--"))

languages <- read_csv("./pilot/stimuli/languages.csv")
words <- read_csv("./pilot/stimuli/nonce.csv")


vowels <- left_join(vowels, languages) %>%
    left_join(y = words) %>%
    mutate_if(is.character, as.factor)
```

# Italian

```{r italian}
vowels.it <- filter(vowels, language == "italian")
```

## Word duration

```{r word-it}
word.it <- lmer(
    word.duration ~
        c2phonation +
        c1phonation +
        vowel +
        sentence.duration +
        (1|speaker) +
        (1|word),
    data = vowels.it
)

summary(word.it)

mixed(
    word.duration ~
        c2phonation +
        c1phonation +
        vowel +
        sentence.duration +
        (1|word),
    data = vowels.it
)
```

In Italian, words with voiceless are longer.

```{r word-plot-it}
ggplot(vowels.it, aes(c2phonation, word.duration, colour = speaker)) +
    geom_boxplot()
plot(allEffects(word.it))
```


## Vowel duration

Fit a mixed effect linear model for Italian.

```{r lmer-it}
model.it <- lmer(vowel.duration ~ c2phonation * vowel + c1phonation + c2place +
                  sentence.duration + (1 | word) + (1|speaker),
              data = vowels.it
              )

summary(model.it)

mixed(vowel.duration ~ c2phonation * vowel + c1phonation + c2place +
                  sentence.duration + (1 | word) + (1|speaker),
              data = vowels.it)
```

```{r italian-effects-plot}
plot(allEffects(model.it))
```

## Vowel duration and consonant closure duration

```{r lmer-closure-it}
model.closure.it <- lmer(vowel.duration ~ closure.duration * vowel + 
                             c1phonation + c2place + c2place:vowel +
                  sentence.duration + (1 | word) + (1|speaker),
              data = vowels.it
              )

summary(model.closure.it)

mixed(vowel.duration ~ closure.duration * vowel + 
                             c1phonation + c2place + c2place:vowel +
                  sentence.duration + (1 | word) + (1|speaker),
              data = vowels.it
      )
```

```{r closure-italian-effects-plot}
plot(allEffects(model.closure.it))
```

## Vowel duration and consonant duration

```{r lmer-consonants-it}
model.consonants.it <- lmer(vowel.duration ~ consonant.duration * vowel + 
                             c1phonation + c2place + c2place:vowel +
                  sentence.duration + (1 | word) + (1|speaker),
              data = vowels.it
              )

summary(model.consonants.it)

mixed(vowel.duration ~ consonant.duration * vowel + 
                             c1phonation + c2place + c2place:vowel +
                  sentence.duration + (1 | word) + (1|speaker),
              data = vowels.it
      )
```

```{r consonant-italian-effects-plot}
plot(allEffects(model.consonants.it))
```

## Consonant closure duration and voicing

```{r lmer-closure-voicing-it}
model.closvoic.it <- lmer(closure.duration ~ c2phonation +  vowel + 
                             c1phonation + c2place +
                  sentence.duration + (1 | word) + (1|speaker),
              data = vowels.it
              )

summary(model.closvoic.it)

mixed(closure.duration ~ c2phonation * vowel + 
                             c1phonation + c2place + c2place:vowel +
                  sentence.duration + (1 | word) + (1|speaker),
              data = vowels.it
      )
```

```{r closure-voicing-italian-effects-plot}
plot(allEffects(model.closvoic.it))
```

# Polish

```{r polish}
vowels.pl <- filter(vowels, language == "polish")
```

## Word duration

```{r word-pl}
word.pl <- lmer(
    word.duration ~
        c2phonation +
        vowel +
        sentence.duration +
        (1|word),
    data = vowels.pl
)

summary(word.pl)

mixed(
    word.duration ~
        c2phonation +
        vowel +
        sentence.duration +
        (1|word),
    data = vowels.pl
)
```

It seems there is no diffirence in duration between words with a voiceless stop and words with a voiced stop in Polish.

```{r word-plot-pl}
ggplot(vowels.pl, aes(c2phonation, word.duration)) +
    geom_violin() +
    geom_boxplot(width = 0.2)
plot(allEffects(word.pl))
```


## Vowel duration

Fit a mixed effect linear model for Polish

```{r pl-vowel-phonation}
model.pl <- lmer(vowel.duration ~ c2phonation * vowel + c2place +
                  sentence.duration + (1 | word),
              data = vowels.pl
              )

summary(model.pl)

mixed(vowel.duration ~ c2phonation * vowel + c2place +
                  sentence.duration + (1 | word),
              data = vowels.pl)
```

```{r polish-effects-plot}
plot(allEffects(model.pl))
```

```{r pl-closure}
closure.pl <- lmer(
    closure.duration ~
        c2phonation +
        vowel +
        sentence.duration +
        (1|word),
    data = vowels.pl
)

summary(closure.pl)
plot(allEffects(closure.pl))

mixed(
    closure.duration ~
        c2phonation +
        vowel +
        sentence.duration +
        (1|word),
    data = vowels.pl
)
```


```{r pl-vowel-closure}
vowels.closure.pl <- lmer(
    vowel.duration ~
        closure.duration +
        vowel +
        c2phonation +
        sentence.duration +
        (1|word),
    data = vowels.pl
)

summary(vowels.closure.pl)
plot(allEffects(vowels.closure.pl))

mixed(
    vowel.duration ~
        closure.duration +
        vowel +
        c2phonation +
        sentence.duration +
        (1|word),
    data = vowels.pl
)
```


# Inter-speaker variation

```{r variation}
dodge <- position_dodge(width = 0.5)

ggplot(filter(vowels.it, c2place == "velar"), aes(c2phonation, vowel.duration, colour = speaker)) +
    facet_grid(. ~ vowel) +
    geom_violin(position = dodge) +
    geom_boxplot(width=0.1, position = dodge)

ggplot(filter(vowels.it, c2place == "coronal"), aes(c2phonation, vowel.duration, colour = speaker)) +
    facet_grid(. ~ vowel) +
    geom_violin(position = dodge) +
    geom_boxplot(width=0.1, position = dodge)

ggplot(vowels.pl, aes(c2phonation, vowel.duration)) +
    facet_grid(. ~ vowel + c2place) +
    geom_violin() +
    geom_boxplot(width=0.2)
```

# Proportions

```{r proportions}
proportions <- vowels %>%
    group_by(c2phonation, language) %>%
    summarise(
        total = mean(vowel.duration, na.rm = TRUE) +
            mean(closure.duration, na.rm = TRUE) +
            mean(rvt, na.rm = TRUE),
        vowel = mean(vowel.duration, na.rm = TRUE) / total,
        closure = mean(closure.duration, na.rm = TRUE) / total,
        rvt = mean(rvt, na.rm = TRUE) / total
    ) %>%
    gather(segment, duration, vowel:rvt) %>%
    mutate(segment = factor(segment, levels = c("rvt", "closure", "vowel")))
```

```{r plot-proportions}
ggplot(proportions, aes(c2phonation, duration, fill = segment)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    facet_grid(language ~ .) +
    guides(fill = guide_legend(reverse = TRUE))
```

```{r word-proportions}
word.proportions <- vowels %>%
    group_by(c1phonation, c2phonation, language) %>%
    summarise(
        total = 
            mean(c1.duration, na.rm = TRUE) +
            mean(vowel.duration, na.rm = TRUE) +
            mean(closure.duration, na.rm = TRUE) +
            mean(rvt, na.rm = TRUE) +
            mean(v2.duration, na.rm = TRUE),
        c1 = mean(c1.duration, na.rm = TRUE),
        vowel = mean(vowel.duration, na.rm = TRUE),
        closure = mean(closure.duration, na.rm = TRUE),
        rvt = mean(rvt, na.rm = TRUE),
        v2 = mean(v2.duration, na.rm = TRUE)
    ) %>%
    gather(segment, duration, c1:v2) %>%
    mutate(segment = factor(segment,
                            levels = c("v2", "rvt", "closure", "vowel", "c1")
                            )
           ) %>%
    unite(phonation, c1phonation, c2phonation)
```

```{r plot-word-proportions}
ggplot(word.proportions, aes(phonation, duration, fill = segment)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    facet_grid(language ~ .) +
    guides(fill = guide_legend(reverse = TRUE))
```
