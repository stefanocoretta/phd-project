---
title: "Spline plotting and SSANOVA"
author: "Stefano Coretta"
date: \today
output:
  html_document: default
  pdf_document:
    fig_caption: yes
    fig_height: 3.5
    fig_width: 5
    latex_engine: xelatex
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir=normalizePath("../../"))
library(readr)
library(purrr)
library(tidyr)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(gss)
library(stringr)
library(lme4)
library(afex)
library(effects)
library(gamm4)
library(mgcv)
library(itsadug)
```

# Data import

Before importing the data, we need to specify the column names for the data set header, since the raw data does not have a header. The number of splines is always 42 (saved as `num.splines`). `first.columns` is a factor containing the names of columns that are not the splines coordinates columns. Finally, we can concatenate `first.columns` with the names of the splines coordinates which is generated by the `paste0` function in the format `X_1, Y_1, X_2, Y_2, X_n, ...` (the underscore `_` will be useful for separating the axis from the fan number).

```{r col-names}
num.splines <- 42
first.columns <- c(
    "speaker",
    "seconds",
    "rec.date",
    "prompt",
    "label",
    "TT.displacement.sm",
    "TT.velocity",
    "TT.velocity.abs",
    "TD.displacement.sm",
    "TD.velocity",
    "TD.velocity.abs"
    )
columns <- c(first.columns,
             paste0(rep(c("X", "Y"), num.splines),
                    "_",
                    rep(1:num.splines, each = 2)
                    )
             )
```

We can now read in the file.

```{r read}
splines.raw <- list.files(path = "./pilot/results",
                   pattern = "*-aaa.csv",
                   full.names = TRUE) %>%
    map_df(~read_tsv(., col_names = columns, na = "*"))

splines.closure.raw <- list.files(path = "./pilot/results",
                   pattern = "*-closure.csv",
                   full.names = TRUE) %>%
    map_df(~read_tsv(., col_names = columns, na = "*"))

splines.phantom.raw <- list.files(path = "./pilot/results",
                   pattern = "*-phantom.csv",
                   full.names = TRUE) %>%
    map_df(~read_tsv(., col_names = columns, na = "*"))

rm(num.splines, first.columns, columns)

languages <- read_csv("./pilot/stimuli/languages.csv")
words <- read_csv("./pilot/stimuli/nonce.csv")
```

The following code applies tidy formatting to the data frame. It uses functions from the `tidyr` library.

```{r tidy}
splines <- splines.raw %>%
    gather(spline, coordinate, matches("[XY]_")) %>%
    separate(spline, c("axis", "fan"), convert = TRUE) %>%
    spread(axis, coordinate) %>%
    mutate(word = word(prompt, 2)) %>%
    left_join(y = languages) %>%
    left_join(y = words) %>%
    mutate_if(is.character, as.factor)

splines.it <- filter(splines, language == "italian")
splines.pl <- filter(splines, language == "polish")
splines.cor <- filter(splines, c2place == "coronal")
splines.vel <- filter(splines, c2place == "velar")

splines.closure <- splines.closure.raw %>%
    gather(spline, coordinate, matches("[XY]_")) %>%
    separate(spline, c("axis", "fan"), convert = TRUE) %>%
    spread(axis, coordinate) %>%
    mutate(word = word(prompt, 2)) %>%
    left_join(y = languages) %>%
    left_join(y = words) %>%
    mutate_if(is.character, as.factor)

splines.phantom <- splines.phantom.raw %>%
    gather(spline, coordinate, matches("[XY]_")) %>%
    separate(spline, c("axis", "fan"), convert = TRUE) %>%
    spread(axis, coordinate) %>%
    mutate(word = word(prompt, 2)) %>%
    left_join(y = languages) %>%
    left_join(y = words) %>%
    mutate_if(is.character, as.factor)
```

Now we can create a separate data frame where the observasional unit is each word and the variables are the consonantal getures (target, maximum closure, release).

```{r gestures}
cons.gestures <- select(splines.raw, speaker:label) %>%
    mutate(word = word(prompt, 2)) %>%
    left_join(y = languages) %>%
    left_join(y = words) %>%
    separate(label, c("gesture", "tongue.area")) %>%
    spread(gesture, seconds) %>%
    mutate(nucleus = (NOFF - NONS) * 1000, deceleration = (NONS - peak1) * 1000, PP = (peak2-peak1) * 1000) %>%
    mutate_if(is.character, as.factor)

gestures.it <- filter(cons.gestures, language == "italian")
gestures.pl <- filter(cons.gestures, language == "polish")
```

# Some plotting

We can finally plot splines.

```{r velar, eval=FALSE}
filter(splines, label == "NONS_TD") %>%
ggplot(aes(x = X, y = Y, colour = c2phonation)) +
    geom_smooth(method = "loess", se = FALSE) +
    coord_fixed(ratio = 1) +
    facet_grid(vowel ~ language)
```

```{r coronal, eval=FALSE}
filter(splines, label == "NONS_TT") %>%
ggplot(aes(x = X, y = Y, colour = c2phonation)) +
    geom_smooth(method = "loess", se = FALSE) +
    coord_fixed(ratio = 1) +
    facet_grid(vowel ~ language)
```


```{r}
filter(splines, c2place == "coronal") %>%
    ggplot(aes(x = X, y = Y, colour = label)) +
        geom_smooth(method = "loess", se = FALSE) +
        coord_fixed(ratio = 1) +
        facet_grid(vowel ~ language + c2phonation)
```

# SSANOVA

```{r ssanovaTongue}
ssanovaTongue <- function(splines) {
    model <- ssanova(Y ~ c2phonation + X + c2phonation:X, data = splines)
    
    predicted <- expand.grid(X = seq(min(splines$X, na.rm = TRUE),
                                     max(splines$X, na.rm = TRUE),
                                     length = 100),
                             Y = seq(min(splines$Y, na.rm = TRUE),
                                     max(splines$Y, na.rm = TRUE),
                                     length = 100),
                             c2phonation = c("voiced", "voiceless")
    )
    
    predicted$splines.fit <- predict(model, predicted, se = T)$fit
    predicted$splines.SE <- predict(model, predicted, se = T)$se.fit
    
    return(predicted)
}
```

```{r ssanova-it}
splines.cor.a <- filter(splines.it, vowel == "a", label == "max_TT")
ssanova.cor.a <- ssanovaTongue(splines.cor.a)

splines.cor.o <- filter(splines.it, vowel == "o", label == "max_TT")
ssanova.cor.o <- ssanovaTongue(splines.cor.a)

splines.cor.u <- filter(splines.it, vowel == "u", label == "max_TT")
ssanova.cor.u <- ssanovaTongue(splines.cor.u)


splines.vel.a <- filter(splines.it, vowel == "a", label == "max_TD")
ssanova.vel.a <- ssanovaTongue(splines.vel.a)

splines.vel.o <- filter(splines.it, vowel == "o", label == "max_TD")
ssanova.vel.o <- ssanovaTongue(splines.vel.a)

splines.vel.u <- filter(splines.it, vowel == "u", label == "max_TD")
ssanova.vel.u <- ssanovaTongue(splines.vel.u)
```


```{r ssanova-cor-plot-it}
ggplot(ssanova.cor.a, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )

ggplot(ssanova.cor.o, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )

ggplot(ssanova.cor.u, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )
```

```{r ssanova-vel-plot-it}
ggplot(ssanova.vel.a, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )

ggplot(ssanova.vel.o, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )

ggplot(ssanova.vel.u, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )
```

```{r ssanova-pl}
splines.cor.a <- filter(splines.pl, vowel == "a", label == "max_TT")
ssanova.cor.a <- ssanovaTongue(splines.cor.a)

splines.cor.o <- filter(splines.pl, vowel == "o", label == "max_TT")
ssanova.cor.o <- ssanovaTongue(splines.cor.a)

splines.cor.u <- filter(splines.pl, vowel == "u", label == "max_TT")
ssanova.cor.u <- ssanovaTongue(splines.cor.u)


splines.vel.a <- filter(splines.pl, vowel == "a", label == "max_TD")
ssanova.vel.a <- ssanovaTongue(splines.vel.a)

splines.vel.o <- filter(splines.pl, vowel == "o", label == "max_TD")
ssanova.vel.o <- ssanovaTongue(splines.vel.a)

splines.vel.u <- filter(splines.pl, vowel == "u", label == "max_TD")
ssanova.vel.u <- ssanovaTongue(splines.vel.u)
```


```{r ssanova-cor-plot-pl}
ggplot(ssanova.cor.a, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )

ggplot(ssanova.cor.o, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )

ggplot(ssanova.cor.u, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )
```

```{r ssanova-vel-plot-pl}
ggplot(ssanova.vel.a, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )

ggplot(ssanova.vel.o, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )

ggplot(ssanova.vel.u, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )
```

# Consonantal gestures: NONS, maximum, NOFS

Let's plot the nucleus duration (NOFF - NONS) as a function of place of articulation, voicing of C2 (our target consonant in C1VC2V words), and language.

```{r nucleus-duration}
filter(cons.gestures, nucleus < 0.05) %>%
ggplot(aes(c2phonation, nucleus)) +
    facet_grid(c2place ~ speaker) +
    geom_violin() +
    geom_boxplot(width=0.1) +
    theme(strip.background = element_rect(fill = "black"),
          strip.text = element_text(color = "white", face = "bold")
          )
```

```{r nucleus-lmer-it}
nucleus.model.it <- lmer(
    nucleus ~
        c2phonation *
        vowel *
        c2place +
        (1|word) +
        (1|speaker),
    data = gestures.it
)

summary(nucleus.model.it)

mixed(
    nucleus ~
        c2phonation *
        vowel *
        c2place +
        (1|word) +
        (1|speaker),
    data = gestures.it
)
```

```{r nucleus-plot-it}
plot(allEffects(nucleus.model.it))
```


```{r nucleus-lmer-pl}
nucleus.model.pl <- lmer(
    nucleus ~
        c2phonation *
        vowel *
        c2place +
        (1|word),
    data = gestures.pl
)

summary(nucleus.model.pl)

mixed(
    nucleus ~
        c2phonation *
        vowel *
        c2place +
        (1|word),
    data = gestures.pl
)
```

```{r nucleus-plot-pl}
plot(allEffects(nucleus.model.pl))
```


```{r deceleration-duration}
ggplot(cons.gestures, aes(c2phonation, deceleration)) +
    facet_grid(.~language + c2place) +
#    geom_violin() +
    geom_boxplot() +
    theme(strip.background = element_rect(fill = "black"),
          strip.text = element_text(color = "white", face = "bold")
          )
```

```{r deceleration-lmer-it}
deceleration.model.it <- lmer(
    deceleration ~
        c2phonation *
        vowel *
        c2place +

        (1|word) +
        (1|speaker),
    data = gestures.it
)

summary(deceleration.model.it)

mixed(
    deceleration ~
        c2phonation *
        vowel *
        c2place +

        (1|word) +
        (1|speaker),
    data = gestures.it
)
```

```{r peak-to-nons-it}
plot(allEffects(deceleration.model.it))
```


# Kinematics performance

I want to check how good the gesture function in AAA is performing. The following gives the number of missing values per speaker.

```{r performance-na}
cons.gestures %>%
    select(speaker, max:peak1) %>%
    group_by(speaker) %>%
    summarise_each(funs(sum(is.na(.)))) %>%
    select(speaker, peak1, NONS, max, NOFF)
```

This chunk instead reports the total number of values per speaker.

```{r performance-total}
cons.gestures %>%
    select(speaker, max:peak1) %>%
    group_by(speaker) %>%
    summarise_each(funs(n())) %>%
    select(speaker, peak1, NONS, max, NOFF)
```

By comparing the two tables, it seems that the function is now performing quite well, but there could still be false detections.


# GAMM

## Coronal

```{r}
splines.cor.max <- splines.cor %>%
    filter(label == "max_TT") %>%
    mutate(c2phonation.ord = as.ordered(c2phonation),
           language.ord = as.ordered(language),
           vowel.ord = as.ordered(vowel))
contrasts(splines.cor.max$c2phonation.ord) <- "contr.treatment"
contrasts(splines.cor.max$language.ord) <- "contr.treatment"
contrasts(splines.cor.max$vowel.ord) <- "contr.treatment"

coronal.gam <- bam(
    Y ~
        c2phonation.ord +
        vowel.ord +
        s(X, bs = "cr") +
        s(X, by = c2phonation.ord, bs = "cr") +
        s(X, by = vowel.ord, bs = "cr") +
        s(rec.date, bs = "re") +
        s(speaker, bs = "re"),
    data = splines.cor.max,
    method = "ML"
)

summary(coronal.gam)

coronal.gam.null <- bam(
    Y ~
        vowel.ord +
        s(X, bs = "cr") +
        s(rec.date, bs = "re") +
        s(speaker, bs = "re"),
    data = splines.cor.max,
    method = "ML"
)

compareML(coronal.gam, coronal.gam.null)
```

```{r}
plot_smooth(coronal.gam, view="X", plot_all="c2phonation.ord", rug=F)
```

```{r}
plot_smooth(coronal.gam, view="X", plot_all="vowel.ord", rug=F)
```


```{r}
plot_diff(coronal.gam, view="X", comp=list(c2phonation.ord=c("voiceless","voiced")))
```

```{r}
plot_diff(coronal.gam, view="X", comp=list(vowel.ord=c("o", "a")))
```

```{r}
acf_plot(resid(coronal.gam), split_by=list(splines.cor.max$rec.date))
```


## Velar

```{r}
splines.vel <- splines.vel %>%
    mutate(c2phonation.ord = as.ordered(c2phonation))
contrasts(splines.vel$c2phonation.ord) <- "contr.treatment"

velar.gam <- bam(
    Y ~
        c2phonation.ord +
        s(X, bs = "cr") +
        s(X, by = c2phonation.ord, bs = "cr"),
    data = splines.vel,
    method = "ML"
)

summary(velar.gam)

velar.gam.null <- bam(
    Y ~
        c2phonation.ord +
        s(X, bs = "cr"),
    data = splines.vel,
    method = "ML"
)

compareML(velar.gam, velar.gam.null)
```

```{r}
plot_smooth(velar.gam, view="X", plot_all="c2phonation.ord", rug=F)
```

```{r}
plot_diff(velar.gam, view="X", comp=list(c2phonation.ord=c("voiceless","voiced")))
```

# Tongue shape at acoustic closure

## Plot

```{r closure-velar, eval=FALSE}
filter(splines.closure, c2place == "velar") %>%
ggplot(aes(x = X, y = Y, colour = c2phonation)) +
    geom_smooth(method = "loess", se = FALSE) +
    coord_fixed(ratio = 1) +
    facet_grid(vowel ~ language + speaker) +
    labs(title = "Tongue shape at acoustic closure of velars")
```

```{r closure-coronal, eval=FALSE}
filter(splines.closure, c2place == "coronal") %>%
ggplot(aes(x = X, y = Y, colour = c2phonation)) +
    geom_line(stat = "smooth", method = "loess", se = FALSE) +
    coord_fixed(ratio = 1) +
    facet_grid(vowel ~ language + speaker) +
    labs(title = "Tongue shape at acoustic closure of coronals")
```

```{r closure-vowel-cor, eval=FALSE}
filter(splines.closure, c2place == "coronal") %>%
    ggplot(aes(x = X, y = Y, colour = vowel)) +
        geom_smooth(method = "loess", se = FALSE) +
        coord_fixed(ratio = 1) +
        facet_grid(c2phonation ~ speaker)
```

```{r closure-vowel-vel, eval=FALSE}
filter(splines.closure, c2place == "velar") %>%
    ggplot(aes(x = X, y = Y, colour = vowel)) +
        geom_smooth(method = "loess", se = FALSE) +
        coord_fixed(ratio = 1) +
        facet_grid(c2phonation ~ speaker)
```

## GAMM

### Coronal

```{r}
splines.cor.max <- filter(splines.closure, c2place == "coronal", speaker == "sc01", vowel == "a") %>%
    mutate(c2phonation.ord = as.ordered(c2phonation),
           language.ord = as.ordered(language),
           vowel.ord = as.ordered(vowel))
contrasts(splines.cor.max$c2phonation.ord) <- "contr.treatment"
#contrasts(splines.cor.max$language.ord) <- "contr.treatment"
#contrasts(splines.cor.max$vowel.ord) <- "contr.treatment"

coronal.gam <- bam(
    Y ~
        c2phonation.ord +
        s(X, bs = "cr") +
        s(X, by = c2phonation.ord, bs = "cr") +
        s(rec.date, bs = "re"),
    data = splines.cor.max,
    method = "ML"
)

summary(coronal.gam)

coronal.gam.null <- bam(
    Y ~
        s(X, bs = "cr") +
        s(rec.date, bs = "re"),
    data = splines.cor.max,
    method = "ML"
)

compareML(coronal.gam, coronal.gam.null)
```

```{r}
plot_smooth(coronal.gam, view="X", plot_all="c2phonation.ord", rug=F)
```

```{r}
plot_diff(coronal.gam, view="X", comp=list(c2phonation.ord=c("voiceless","voiced")))
```

### Velar

```{r}
splines.vel.max <- filter(splines.closure, c2place == "velar", speaker == "sc01") %>%
    mutate(c2phonation.ord = as.ordered(c2phonation),
           language.ord = as.ordered(language),
           vowel.ord = as.ordered(vowel))
contrasts(splines.cor.max$c2phonation.ord) <- "contr.treatment"
#contrasts(splines.cor.max$language.ord) <- "contr.treatment"
#contrasts(splines.cor.max$vowel.ord) <- "contr.treatment"

velar.gam <- bam(
    Y ~
        c2phonation.ord +
        s(X, bs = "cr") +
        s(X, by = c2phonation.ord, bs = "cr") +
        s(rec.date, bs = "re"),
    data = splines.vel.max,
    method = "ML"
)

summary(velar.gam)

velar.gam.null <- bam(
    Y ~
        s(X, bs = "cr") +
        s(rec.date, bs = "re"),
    data = splines.vel.max,
    method = "ML"
)

compareML(velar.gam, velar.gam.null)
```

```{r}
plot_smooth(velar.gam, view="X", plot_all="c2phonation.ord", rug=F)
```

```{r}
plot_diff(velar.gam, view="X", comp=list(c2phonation.ord=c("voiceless","voiced")))
```

# Compare voiceless closure to phantom voiced closure

```{r bind-phantom}
splines.closure.voiceless <- filter(splines.closure, c2phonation == "voiceless", language == "italian")

splines.phantom.closure <- rbind(splines.closure.voiceless, splines.phantom)
```

```{r}
filter(splines.phantom.closure, c2place == "coronal") %>%
    ggplot(aes(X, Y, colour = c2phonation, group = rec.date)) +
    geom_line(stat = "smooth", method = "loess", alpha = 0.5) +
    coord_fixed(ratio = 1) +
    facet_grid(vowel ~ language + speaker) +
    labs(title = "Tongue shape at acoustic closure of coronals")
```

```{r}
filter(splines.phantom.closure, c2place == "velar") %>%
    ggplot(aes(X, Y, colour = c2phonation, group = rec.date)) +
    geom_line(stat = "smooth", method = "loess", alpha = 0.5) +
    coord_fixed(ratio = 1) +
    facet_grid(vowel ~ language + speaker) +
    labs(title = "Tongue shape at acoustic closure of coronals")
```

# Peak to peak duration

```{r peak-to-peak-plot}
filter(cons.gestures, speaker == "sdc02") %>%
    ggplot(aes(c2phonation, PP)) +
    geom_violin() +
    geom_boxplot(width = 0.2) +
    facet_grid(. ~ c2place)
```

```{r pp-lmer-it}
pp.lmer.it <- lmer(
    PP ~
        c2phonation +
        c2place +
        vowel +
        (1|word) +
        (1|speaker),
    data = filter(gestures.it, PP > 0)
)

summary(pp.lmer.it)

mixed(
    PP ~
        c2phonation +
        c2place +
        vowel +
        (1|word) +
        (1|speaker),
    data = filter(gestures.it, PP > 0)
)
```

```{r}
plot(allEffects(pp.lmer.it))
```

```{r pp-lmer-pl}
pp.lmer.pl <- lmer(
    PP ~
        c2phonation +
        c2place +
        vowel +
        (1|word) +
        (1|speaker),
    data = filter(gestures.pl, PP > 0)
)

summary(pp.lmer.pl)

mixed(
    PP ~
        c2phonation +
        c2place +
        vowel +
        (1|word) +
        (1|speaker),
    data = filter(gestures.pl, PP > 0)
)
```

```{r}
plot(allEffects(pp.lmer.pl))
```

# Tongue shapes at Peak 1

```{r}
filter(splines, label == "peak1_TT", language == "italian") %>%
    ggplot(aes(x = X, y = Y, colour = c2phonation)) +
        geom_line(stat = "smooth", method = "loess", se = FALSE) +
        coord_fixed(ratio = 1) +
        facet_grid(vowel ~ speaker)
```

```{r}

```

