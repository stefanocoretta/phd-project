---
title: "Meta-analysis of the voicing effect in English"
author: "Stefano Coretta"
date: "07/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../"))
library(tidyverse)
library(ggrepel)
theme_set(theme_minimal())
library(brms)
library(bayesplot)
library(tidybayes)
library(broom.mixed)
library(coretta2019eng)
data("eng_durations")
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
options(mc.cores = parallel::detectCores())
```

```{r data, message=FALSE}
stressed <- read_csv("./english-ve-meta/stressed.csv") %>%
  mutate(
    voice = factor(voice, levels = c("voiceless", "voiced")),
    n_syl = factor(n_syl, levels = c("mono", "di", "tri")),
    word_pos_2 = ifelse(word_pos == "medial", "medial", "final")
  ) %>%
  mutate_if(is.character, as.factor)

unstressed <- read_csv("./english-ve-meta/unstressed.csv") %>%
  gather("voice_stat", "value", voiced_mean:voiceless_sd) %>%
  separate(voice_stat, c("voice", "stat")) %>%
  spread(stat, value) %>%
  rename(v_duration =  "mean") %>%
  mutate(
    voice = factor(voice, levels = c("voiceless", "voiced")),
    speaker = as.factor(speaker),
    place = factor(place, levels = c("labial", "alveolar", "velar"))
  )

unstressed_red <- filter(unstressed, v_context == "reduced")
unstressed_unr <- filter(unstressed, v_context == "unreduced")

studies <- stressed %>% select(study, n_syl:word_pos_2) %>% unique() %>%
  filter(study != "hussein1994", study != "port1981_tri") %>% # Hussein 1994 is not included in the analysis
  droplevels()

ko18_data <- read_delim("./english-ve-meta/ko2018.txt", delim = "\t")
```

# Obtain estimates from previous studies

```{r heffner1937}
h37 <- filter(stressed, study == "heffner1937")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

h37_bm <- brm(
  v_duration ~
    voice,
  data = h37,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/h37_bm"
)
```

```{r housefairbanks1953}
hf53 <- filter(stressed, study == "housefairbanks1953")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

hf53_bm <- brm(
  v_duration ~
    voice,
  data = hf53,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/hf53_bm"
)
```

```{r zimmerman1958}
z58 <- filter(stressed, study == "zimmerman1958")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

z58_bm <- brm(
  v_duration ~
    voice,
  data = z58,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/z58_bm"
)
```

```{r petersonlehiste1960}
pl60 <- filter(stressed, study == "petersonlehiste1960")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

pl60_bm <- brm(
  v_duration ~
    voice,
  data = pl60,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/pl60_bm"
)
```

```{r sharf1962}
s62_di <- filter(stressed, study == "sharf1962_di")
s62_mono <- filter(stressed, study == "sharf1962_mono")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

s62_di_bm <- brm(
  v_duration ~
    voice,
  data = s62_di,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/s62_di_bm"
)

s62_mono_bm <- brm(
  v_duration ~
    voice,
  data = s62_mono,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/s62_mono_bm"
)
```

```{r chen1970}
c70 <- filter(stressed, study == "chen1970")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

c70_bm <- brm(
  v_duration ~
    voice,
  data = c70,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/c70_bm"
)
```

```{r klatt1973}
k73_di <- filter(stressed, study == "klatt1973_di")
k73_mono <- filter(stressed, study == "klatt1973_mono")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

k73_di_bm <- brm(
  v_duration ~
    voice,
  data = k73_di,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/k73_di_bm",
  control = list(adapt_delta = 0.999)
)

k73_mono_bm <- brm(
  v_duration ~
    voice,
  data = k73_mono,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/k73_mono_bm",
  control = list(adapt_delta = 0.999)
)
```

```{r port1981}
p81_di <- filter(stressed, study == "port1981_di")
p81_mono <- filter(stressed, study == "port1981_mono")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced)
)

p81_di_bm <- brm(
  v_duration | se(sd) ~
    voice,
  data = p81_di,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/p81_di_bm"
)

p81_mono_bm <- brm(
  v_duration | se(sd) ~
    voice,
  data = p81_mono,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/p81_mono_bm"
)
```

```{r mack1982}
m82 <- filter(stressed, study == "mack1982")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

m82_bm <- brm(
  v_duration ~
    voice,
  data = m82,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/m82_bm"
)
```

```{r luce1985}
l85_medial <- filter(stressed, study == "luce1985_medial")
l85_final <- filter(stressed, study == "luce1985_final")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced)
)

l85_medial_bm <- brm(
  v_duration | se(sd) ~
    voice,
  data = l85_medial,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/l85_medial_bm"
)

l85_final_bm <- brm(
  v_duration | se(sd) ~
    voice,
  data = l85_final,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/l85_final_bm"
)
```

```{r davis1989}
d89 <- filter(stressed, study == "davis1989")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced)
)

d89_bm <- brm(
  v_duration | se(sd) ~
    voice,
  data = d89,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/d89_bm"
)
```

```{r laeufer1992}
l92 <- filter(stressed, study == "laeufer1992")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

l92_bm <- brm(
  v_duration ~
    voice,
  data = l92,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/l92_bm"
)
```

```{r ko2018}
k18 <- filter(stressed, study == "ko2018")
k18 <- filter(ko18_data, phoneme %in% c("AE1", "EH1", "IH1")) %>%
  mutate(voice = factor(voice, levels = c("-voice", "+voice")))

priors <- c(
  prior(normal(145, 30), class = Intercept),
  prior(normal(0, 50), class = b, coef = voicePvoice),
  set_prior("normal(0, 25)", class = "sd"),
  set_prior("normal(0, 25)", class = "sigma")
)

k18_bm <- brm(
  duration ~
    voice +
    (1|subj) +
    (1|item),
  data = k18,
  prior = priors,
  seed = 9899,
  control = list(adapt_delta = 0.999, max_treedepth = 20),
  file = "./english-ve-meta/data/cache/k18_bm"
)
```

```{r coretta2019}
eng_durations_di <- filter(eng_durations, num_syl == "di")
eng_durations_mono <- filter(eng_durations, num_syl == "mono")

priors <- c(
  set_prior("normal(145, 30)", class = "Intercept"),
  set_prior("normal(50, 20)", class = "b", coef = "voicingvoiced"),
  set_prior("normal(-25, 10)", class = "b", coef = "speech_rate_c"),
  set_prior("cauchy(0, 25)", class = "sd"),
  set_prior("lkj(2)", class = "cor"),
  set_prior("cauchy(0, 25)", class = "sigma")
)

c19_di_bm <- brm(
  v1_duration ~
    voicing +
    speech_rate_c +
    (1 + voicing | speaker) +
    (1 | word),
  family = gaussian(),
  data = eng_durations_di,
  prior = priors,
  file = "./english-ve-meta/data/cache/c19_di_bm"
)

priors <- c(
  set_prior("normal(200, 40)", class = "Intercept"),
  set_prior("normal(100, 30)", class = "b", coef = "voicingvoiced"),
  set_prior("normal(-25, 10)", class = "b", coef = "speech_rate_c"),
  set_prior("cauchy(0, 25)", class = "sd"),
  set_prior("lkj(2)", class = "cor"),
  set_prior("cauchy(0, 25)", class = "sigma")
)

c19_mono_bm <- brm(
  v1_duration ~
    voicing +
    speech_rate_c +
    (1 + voicing | speaker) +
    (1 | word),
  family = gaussian(),
  data = eng_durations_mono,
  prior = priors,
  file = "./english-ve-meta/data/cache/c19_mono_bm"
)
```

```{r estimated}
estimated <- list()

# These are in allpahbetical order so that joining below does not complain
# about different levels
estimated[["chen1970"]] <- fixef(c70_bm)["voicevoiced",]
estimated[["coretta2019_di"]] <- fixef(c19_di_bm)["voicingvoiced",]
estimated[["coretta2019_mono"]] <- fixef(c19_mono_bm)["voicingvoiced",]
estimated[["davis1989"]] <- fixef(d89_bm)["voicevoiced",]
estimated[["heffner1937"]] <- fixef(h37_bm)["voicevoiced",]
estimated[["housefairbanks1953"]] <- fixef(hf53_bm)["voicevoiced",]
estimated[["klatt1973_di"]] <- fixef(k73_di_bm)["voicevoiced",]
estimated[["klatt1973_mono"]] <- fixef(k73_mono_bm)["voicevoiced",]
estimated[["ko2018"]] <- fixef(k18_bm)["voicePvoice",]
estimated[["laeufer1992"]] <- fixef(l92_bm)["voicevoiced",]
estimated[["luce1985_final"]] <- fixef(l85_final_bm)["voicevoiced",]
estimated[["luce1985_medial"]] <- fixef(l85_medial_bm)["voicevoiced",]
estimated[["mack1982"]] <- fixef(m82_bm)["voicevoiced",]
estimated[["petersonlehiste1960"]] <- fixef(pl60_bm)["voicevoiced",]
estimated[["port1981_di"]] <- fixef(p81_di_bm)["voicevoiced",]
estimated[["port1981_mono"]] <- fixef(p81_mono_bm)["voicevoiced",]
estimated[["sharf1962_di"]] <- fixef(s62_di_bm)["voicevoiced",]
estimated[["sharf1962_mono"]] <- fixef(s62_mono_bm)["voicevoiced",]
estimated[["zimmerman1958"]] <- fixef(z58_bm)["voicevoiced",]

estimated_tbl <- plyr::ldply(estimated, .id = "study") %>%
  mutate(
    source = factor("original", levels = c("original", "meta-analysis")),
    study = factor(study)
  ) %>%
  left_join(y = studies)
```

```{r estimated_v}
estimated_v <- list()

estimated_v[["chen1970"]] <- fixef(c70_bm)["Intercept",]
estimated_v[["coretta2019_di"]] <- fixef(c19_di_bm)["Intercept",]
estimated_v[["coretta2019_mono"]] <- fixef(c19_mono_bm)["Intercept",]
estimated_v[["davis1989"]] <- fixef(d89_bm)["Intercept",]
estimated_v[["heffner1937"]] <- fixef(h37_bm)["Intercept",]
estimated_v[["housefairbanks1953"]] <- fixef(hf53_bm)["Intercept",]
estimated_v[["klatt1973_di"]] <- fixef(k73_di_bm)["Intercept",]
estimated_v[["klatt1973_mono"]] <- fixef(k73_mono_bm)["Intercept",]
estimated_v[["ko2018"]] <- fixef(k18_bm)["Intercept",]
estimated_v[["laeufer1992"]] <- fixef(l92_bm)["Intercept",]
estimated_v[["luce1985_final"]] <- fixef(l85_final_bm)["Intercept",]
estimated_v[["luce1985_medial"]] <- fixef(l85_medial_bm)["Intercept",]
estimated_v[["mack1982"]] <- fixef(m82_bm)["Intercept",]
estimated_v[["petersonlehiste1960"]] <- fixef(pl60_bm)["Intercept",]
estimated_v[["port1981_di"]] <- fixef(p81_di_bm)["Intercept",]
estimated_v[["port1981_mono"]] <- fixef(p81_mono_bm)["Intercept",]
estimated_v[["sharf1962_di"]] <- fixef(s62_di_bm)["Intercept",]
estimated_v[["sharf1962_mono"]] <- fixef(s62_mono_bm)["Intercept",]
estimated_v[["zimmerman1958"]] <- fixef(z58_bm)["Intercept",]

estimated_v_tbl <- plyr::ldply(estimated_v, .id = "study") %>%
  mutate(
    source = factor("original", levels = c("original", "meta-analysis")),
    study = factor(study)
  ) %>%
  left_join(y = studies)
```

# Meta-analysis of stressed vowels

## All studies

```{r meta-bm}
priors <- c(
  prior(normal(0, 100), class = Intercept),
  prior(cauchy(0, 25), class = sd)
)

meta_bm <- brm(
  Estimate | se(`Est.Error`) ~ (1 | study),
  data = estimated_tbl,
  prior = priors,
  control = list(adapt_delta = 0.999),
  seed = 9899,
  file = "./english-ve-meta/data/cache/meta_bm"
)

meta_bm_est <- fixef(meta_bm)["Intercept","Estimate"]
meta_bm_q2.5 <- fixef(meta_bm)["Intercept","Q2.5"]
meta_bm_q97.5 <- fixef(meta_bm)["Intercept","Q97.5"]

summary(meta_bm)
```

```{r studies-shrunk}
# Code adapted from Nicenboim et al. 2018

studies_shrunk <- (c(posterior_samples(meta_bm, pars = "b_Intercept")) +
  posterior_samples(meta_bm, pars = "r_study")) %>%
  summarise_all(funs(list(c(
    mean(.),
    quantile(., probs = c(.025, 0.975)),
    sd(.)
  )))) %>%
  unnest() %>%
  transpose() %>%
  setNames(c("Estimate", "Q2.5", "Q97.5", "Est.Error")) %>%
  map_df(unlist) %>%
  mutate(
    study = estimated_tbl$study,
    source = factor("meta-analysis", levels = c("original", "meta-analysis"))
  ) %>%
  left_join(y = studies)
```

```{r original-plot}
estimated_tbl %>%
  ggplot(aes(Estimate, reorder(study_ref, Estimate), colour = syl_pos, linetype = word_pos_2)) +
  geom_vline(aes(xintercept = 0), colour = "grey") +
  geom_vline(aes(xintercept = meta_bm_q2.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_q97.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_est), colour = "skyblue4") +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = Q2.5, xmax = Q97.5), height = 0) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  labs(
    x = "Difference in vowel duration (ms)",
    y = "Study",
    colour = "Syllable position",
    linetype = "Word position"
  )
```

```{r shrunk-plot}
studies_shrunk %>%
  ggplot(aes(Estimate, reorder(study_ref, Estimate), colour = syl_pos, linetype = word_pos_2)) +
  geom_vline(aes(xintercept = 0), colour = "grey") +
  geom_vline(aes(xintercept = meta_bm_q2.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_q97.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_est), colour = "skyblue4") +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = Q2.5, xmax = Q97.5), height = 0) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  labs(
    x = "Difference in vowel duration (ms)",
    y = "Study",
    colour = "Syllable position",
    linetype = "Word position"
  )
```

```{r origin-shrunk-plot}
bind_rows(estimated_tbl, studies_shrunk) %>%
  mutate(source = factor(source, levels = c("meta-analysis", "original"))) %>%
  ggplot(aes(reorder(study_ref, Estimate), Estimate, colour = source, linetype = syl_pos)) +
  geom_hline(aes(yintercept = 0), colour = "grey") +
  geom_hline(aes(yintercept = meta_bm_q2.5), colour = "skyblue4", linetype = "dashed") +
  geom_hline(aes(yintercept = meta_bm_q97.5), colour = "skyblue4", linetype = "dashed") +
  geom_hline(aes(yintercept = meta_bm_est), colour = "skyblue4") +
  geom_point(size = 2, position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = Q2.5, ymax = Q97.5), width = 0, position = position_dodge(width = 0.8)) +
  scale_color_brewer(type = "qual", palette = "Dark2", breaks = c("original", "meta-analysis")) +
  scale_y_continuous(breaks = c(-100, -50, 0, 50, 100, 150, 200)) +
  labs(
    title = "Estimated voicing effect from the original source\nand from the meta-analysis",
    y = "Difference in vowel duration (ms)",
    x = "Study",
    linetype = "Syllable position",
    colour = "Source"
  ) +
  coord_flip() +
  theme(panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank())
```

```{r funnel-plot}
estimated_tbl %>%
  mutate(precision = 1/Est.Error) %>%
  ggplot(aes(Estimate, precision, label = study_ref)) +
  geom_vline(aes(xintercept = 0), colour = "grey") +
  geom_vline(aes(xintercept = meta_bm_q2.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_q97.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_est), colour = "skyblue4") +
  geom_point(aes(shape = syl_pos)) +
  geom_text_repel()
```

```{r funnel-plot-2}
studies_shrunk %>%
  mutate(precision = 1/Est.Error) %>%
  ggplot(aes(Estimate, precision, label = study_ref)) +
  geom_vline(aes(xintercept = 0), colour = "grey") +
  geom_vline(aes(xintercept = meta_bm_q2.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_q97.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_est), colour = "skyblue4") +
  geom_point() +
  geom_text_repel()
```

## Syllable position: final

```{r meta-bm-1}
estimated_tbl_final <- filter(estimated_tbl, syl_pos == "final")

priors <- c(
  prior(normal(0, 100), class = Intercept),
  prior(cauchy(0, 25), class = sd)
)

meta_bm_1 <- brm(
  Estimate | se(`Est.Error`) ~ (1 | study),
  data = estimated_tbl_final,
  prior = priors,
  control = list(adapt_delta = 0.999),
  seed = 9899,
  file = "./english-ve-meta/data/cache/meta_bm_1"
)

meta_bm_1_est <- fixef(meta_bm_1)["Intercept","Estimate"]
meta_bm_1_q2.5 <- fixef(meta_bm_1)["Intercept","Q2.5"]
meta_bm_1_q97.5 <- fixef(meta_bm_1)["Intercept","Q97.5"]

summary(meta_bm_1)
```

```{r post-final-plot, warning=FALSE}
posterior_samples(meta_bm_1, pars = "b_Intercept") %>%
  ggplot(aes(b_Intercept)) +
  geom_vline(aes(xintercept = meta_bm_1_q2.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_1_q97.5), colour = "skyblue4", linetype = "dashed") +
  geom_density(colour = NA, fill = "skyblue4", alpha = 0.5, bw = 2) +
  scale_x_continuous(breaks = seq(40, 120, 10), limits = c(40, 120)) +
  labs(
    title = "Posterior distribution of the meta-analystical estimate of the English voicing effect",
    subtitle = "The dashed vertical lines indicate the 95% credible interval.",
    x = "Difference in vowel duration (ms)",
    y = element_blank()
  ) +
  theme(panel.grid.minor = element_blank()) +
  scale_y_continuous(labels = NULL)
```

```{r studies-shrunk-1}
# Code adapted from Nicenboim et al. 2018

studies_shrunk_1 <- (c(posterior_samples(meta_bm_1, pars = "b_Intercept")) +
  posterior_samples(meta_bm_1, pars = "r_study")) %>%
  summarise_all(funs(list(c(
    mean(.),
    quantile(., probs = c(.025, 0.975)),
    sd(.)
  )))) %>%
  unnest() %>%
  transpose() %>%
  setNames(c("Estimate", "Q2.5", "Q97.5", "Est.Error")) %>%
  map_df(unlist) %>%
  mutate(
    study = estimated_tbl_final$study,
    source = factor("meta-analysis", levels = c("original", "meta-analysis"))
  ) %>%
  left_join(y = studies)
```

```{r origin-shrunk-1-plot}
bind_rows(estimated_tbl_final, studies_shrunk_1) %>%
  mutate(source = factor(source, levels = c("meta-analysis", "original"))) %>%
  ggplot(aes(reorder(study_ref_2, Estimate), Estimate, colour = source)) +
  geom_hline(aes(yintercept = 0), colour = "grey") +
  geom_hline(aes(yintercept = meta_bm_1_q2.5), colour = "skyblue4", linetype = "dashed") +
  geom_hline(aes(yintercept = meta_bm_1_q97.5), colour = "skyblue4", linetype = "dashed") +
  geom_hline(aes(yintercept = meta_bm_1_est), colour = "skyblue4") +
  geom_point(size = 2, position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = Q2.5, ymax = Q97.5), width = 0, position = position_dodge(width = 0.8)) +
  scale_color_brewer(type = "qual", palette = "Dark2", breaks = c("original", "meta-analysis")) +
  scale_y_continuous(breaks = c(-100, -50, 0, 50, 100, 150, 200)) +
  labs(
    title = "Estimated voicing effect from the original source\nand from the meta-analysis",
    y = "Difference in vowel duration (ms)",
    x = "Study",
    colour = "Source"
  ) +
  coord_flip() +
  theme(panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank())
```

```{r funnel-plot}
estimated_tbl_final %>%
  mutate(precision = 1/Est.Error) %>%
  ggplot(aes(Estimate, precision, label = study_ref_2)) +
  geom_vline(aes(xintercept = 0), colour = "grey") +
  geom_vline(aes(xintercept = meta_bm_q2.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_q97.5), colour = "skyblue4", linetype = "dashed") +
  geom_vline(aes(xintercept = meta_bm_est), colour = "skyblue4") +
  geom_point() +
  geom_text_repel()
```

## Syllable position: non-final

```{r meta-bm-medial}
estimated_tbl_medial <- filter(estimated_tbl, syl_pos == "non-final")

priors <- c(
  prior(normal(0, 100), class = Intercept),
  prior(cauchy(0, 25), class = sd)
)

meta_bm_medial <- brm(
  Estimate | se(`Est.Error`) ~ (1 | study),
  data = estimated_tbl_medial,
  prior = priors,
  control = list(adapt_delta = 0.999),
  seed = 9899,
  file = "./english-ve-meta/data/cache/meta_bm_medial"
)

meta_bm_medial_est <- fixef(meta_bm)["Intercept","Estimate"]
meta_bm_medial_q2.5 <- fixef(meta_bm)["Intercept","Q2.5"]
meta_bm_medial_q97.5 <- fixef(meta_bm)["Intercept","Q97.5"]

summary(meta_bm_medial)
```

```{r post-medial-plot}
posterior_samples(meta_bm_medial, pars = "b_Intercept") %>%
  ggplot(aes(b_Intercept)) +
  geom_vline(aes(xintercept = 0)) +
  geom_density(colour = NA, fill = "skyblue4", alpha = 0.5, bw = 2) +
  scale_x_continuous(breaks = seq(-30, 80, 10), limits = c(-30, 80))
```

## All studies, syllable position

```{r meta-bm-4}
priors <- c(
  prior(normal(0, 100), class = Intercept),
  prior(normal(0, 50), class = b, coef = syl_posnonMfinal),
  prior(cauchy(0, 25), class = sd)
)

meta_bm_4 <- brm(
  Estimate | se(`Est.Error`) ~ syl_pos + (1 | study),
  data = estimated_tbl,
  prior = priors,
  control = list(adapt_delta = 0.999),
  seed = 9899,
  file = "./english-ve-meta/data/cache/meta_bm_4"
)

summary(meta_bm_4)

meta_bm_est <- fixef(meta_bm_4)["Intercept","Estimate"]
meta_bm_q2.5 <- fixef(meta_bm_4)["Intercept","Q2.5"]
meta_bm_q97.5 <- fixef(meta_bm_4)["Intercept","Q97.5"]

post_nonfi <- (c(posterior_samples(meta_bm_4, pars = "b_Intercept")) +
  posterior_samples(meta_bm_4, pars = "b_syl_posnonMfinal"))

meta_bm_syl_q2.5 <- quantile(post_nonfi$b_syl_posnonMfinal, c(0.025))
meta_bm_syl_q97.5 <- quantile(post_nonfi$b_syl_posnonMfinal, c(0.975))
meta_bm_syl_q50 <- (meta_bm_syl_q2.5 + meta_bm_syl_q97.5) / 2
```

```{r pp-check}
pp_check(meta_bm_4, nsamples = 100)
```

```{r pairs}
pairs(meta_bm_4)
```

```{r intervals-plot, include=TRUE, fig.cap = "Credible intervals of the meta-analytical posterior distributions."}
meta_draws <- meta_bm_4 %>%
  gather_draws(b_syl_posnonMfinal, b_Intercept)

meta_draws %>%
  ungroup() %>%
  mutate(.variable = factor(.variable, levels = c("b_syl_posnonMfinal", "b_Intercept"))) %>%
  ggplot(aes(.value, .variable)) +
  geom_vline(xintercept = 0) +
  stat_intervalh() +
  stat_pointintervalh(position = position_nudge(y = -0.1), .width = c(0.66, 0.98)) +
  scale_x_continuous(breaks = seq(-100, 100, 25)) +
  scale_y_discrete(labels = c("Final vs. penultimate", "Final")) +
  scale_color_brewer() +
  labs(
    x = "Meta-analytical estimate (ms)",
    y = element_blank()
  ) +
  theme(panel.grid.minor = element_blank())
```

```{r post-syl}
post_syl <- (c(posterior_samples(meta_bm_4, pars = "b_Intercept")) +
  posterior_samples(meta_bm_4, pars = "b_syl_posnonMfinal")) %>%
  bind_cols(posterior_samples(meta_bm_4, pars = "b_Intercept")) %>%
  gather("coef", "posterior")
```

```{r syl-plot}
post_syl %>%
  ggplot(aes(posterior, fill = coef)) +
  geom_vline(aes(xintercept = 0)) +
  geom_density(colour = NA, alpha = 0.8) +
  scale_fill_brewer(
    type = "qual", palette = "Paired",
    labels = c("final", "non-final")
  ) +
  scale_x_continuous(breaks = seq(-60, 100, 20)) +
  labs(
    title = "Meta-analytical posterior distributions of the voicing effect",
    x = "Difference in vowel duration (ms)",
    fill = "Syllable position",
    y = element_blank()
  ) +
  theme(legend.position = "top")
```

```{r studies-shrunk}
# Code adapted from Nicenboim et al. 2018

# We need this since the model includes `num_syl`
post_nonf <- posterior_samples(meta_bm_4, pars = "b_syl_posnonMfinal")

studies_shrunk <- (c(posterior_samples(meta_bm_4, pars = "b_Intercept")) +
  posterior_samples(meta_bm_4, pars = "r_study")) %>%
  bind_cols(post_nonf) %>%
  # The following mutate sums the random coefficients of the studies with
  # `num_syl` == "non-final" to the posterior samples of the non_syl term
  mutate(
    `r_study[davis1989,Intercept]` = `r_study[davis1989,Intercept]` + b_syl_posnonMfinal,
    `r_study[sharf1962_di,Intercept]` = `r_study[sharf1962_di,Intercept]` + b_syl_posnonMfinal,
    `r_study[klatt1973_di,Intercept]` = `r_study[klatt1973_di,Intercept]` + b_syl_posnonMfinal,
    `r_study[coretta2019_di,Intercept]` = `r_study[coretta2019_di,Intercept]` + b_syl_posnonMfinal,
    `r_study[port1981_di,Intercept]` = `r_study[port1981_di,Intercept]` + b_syl_posnonMfinal,
  ) %>%
  select(-b_syl_posnonMfinal) %>%
  summarise_all(list(~list(c(
    mean(.),
    quantile(., probs = c(.025, 0.975)),
    sd(.)
  )))) %>%
  unnest() %>%
  transpose() %>%
  setNames(c("Estimate", "Q2.5", "Q97.5", "Est.Error")) %>%
  map_df(unlist) %>%
  mutate(
    study = estimated_tbl$study,
    source = factor("meta-analysis", levels = c("original", "meta-analysis"))
  ) %>%
  left_join(y = studies)
```

```{r origin-shrunk-plot, include=TRUE, fig.cap = "Estimated voicing effect from the original source and from the meta-analysis.", out.extra = "width=\\textwidth"}
bind_rows(estimated_tbl, studies_shrunk) %>%
  mutate(source = factor(source, levels = c("meta-analysis", "original"))) %>%
  ggplot(aes(reorder(study_ref, Estimate), Estimate, colour = source, linetype = syl_pos)) +
  geom_hline(aes(yintercept = 0), colour = "grey") +
  scale_x_discrete() +
  annotate("rect", xmin = 5.5, xmax = Inf, ymin = meta_bm_q2.5, ymax = meta_bm_q97.5, alpha = 0.5, fill = "#a6cee3") +
  annotate("rect", xmin = -Inf, xmax = 5.5, ymin = meta_bm_syl_q2.5, ymax = meta_bm_syl_q97.5, alpha = 0.5, fill = "#1f78b4") +
  geom_point(size = 2, position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = Q2.5, ymax = Q97.5), width = 0, position = position_dodge(width = 0.8)) +
  scale_color_brewer(type = "qual", palette = "Dark2", breaks = c("original", "meta-analysis")) +
  scale_y_continuous(breaks = c(-100, -50, 0, 50, 100, 150, 200)) +
  scale_linetype_discrete(labels = c("final", "non-final")) +
  labs(
    caption = "The shaded areas indicate the 95% CI of the meta-analytical posterior\nof the voicing effect in final (light blue) and penultimate (dark blue) position.",
    y = "Difference in vowel duration (ms)",
    x = "Study",
    linetype = "Syllable position",
    colour = "Source"
  ) +
  coord_flip() +
  theme(panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank())
```

```{r origin-plot, include=TRUE, fig.cap = "Estimated voicing effect of the individual studies.", out.extra = "width=\\textwidth"}
estimated_tbl %>%
  ggplot(aes(reorder(study_ref, Estimate), Estimate, linetype = syl_pos)) +
  geom_hline(aes(yintercept = 0), colour = "grey") +
  scale_x_discrete() +
  annotate("rect", xmin = 5.5, xmax = Inf, ymin = meta_bm_q2.5, ymax = meta_bm_q97.5, alpha = 0.5, fill = "#a6cee3") +
  annotate("rect", xmin = -Inf, xmax = 5.5, ymin = meta_bm_syl_q2.5, ymax = meta_bm_syl_q97.5, alpha = 0.5, fill = "#1f78b4") +
  geom_point(size = 2, position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = Q2.5, ymax = Q97.5), width = 0, position = position_dodge(width = 0.8)) +
  scale_y_continuous(breaks = c(-100, -50, 0, 50, 100, 150, 200)) +
  scale_linetype_discrete(labels = c("final", "non-final")) +
  labs(
    caption = "The shaded areas indicate the 95% CI of the meta-analytical posterior\nof the voicing effect in final (light blue) and penultimate (dark blue) position.",
    y = "Difference in vowel duration (ms)",
    x = "Study",
    linetype = "Syllable position",
    colour = "Source"
  ) +
  coord_flip() +
  theme(panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank())
```

```{r funnel-plot, include=TRUE, fig.cap = "By-study funnel plot showing the estimate against the precision. The vertical thick and dashed lines are the meta-analytical means of the effect in final and penultimate position."}
estimated_tbl %>%
  mutate(precision = 1/Est.Error) %>%
  ggplot(aes(Estimate, precision, label = study)) +
  geom_vline(aes(xintercept = 0), colour = "grey") +
    geom_vline(aes(xintercept = meta_bm_est)) +
  geom_vline(aes(xintercept = meta_bm_syl_q50), linetype = "dashed") +
  annotate("rect", ymin = -Inf, ymax = Inf, xmin = meta_bm_q2.5, xmax = meta_bm_q97.5, alpha = 0.5, fill = "#a6cee3") +
  annotate("rect", ymin = -Inf, ymax = Inf, xmin = meta_bm_syl_q2.5, xmax = meta_bm_syl_q97.5, alpha = 0.5, fill = "#1f78b4") +
  geom_point(aes(shape = syl_pos), size = 3) +
  # geom_text_repel(force = 20, seed = 1234) +
  scale_shape_discrete(labels = c("final", "non-final")) +
  scale_x_continuous(breaks = seq(-25, 150, 25)) +
  labs(
    x = "Difference in vowel duration (ms)",
    shape = "Syllable position"
  )
```

```{r funnel-plot-2, include=TRUE, fig.cap = "By-study funnel plot showing the estimate against the precision. The vertical thick and dashed lines are the meta-analytical means of the effect in final and penultimate position."}
e.min <- by(estimated_tbl$Est.Error, estimated_tbl$syl_pos, range)[[1]][1]
e.max <- by(estimated_tbl$Est.Error, estimated_tbl$syl_pos, range)[[1]][2]
se_range <- seq(e.min, e.max, by = 0.1)
ci <- tibble(
  y_seq = 1/(seq(e.min, e.max, by = 0.1)^2),
  ci_lo = meta_bm_est - 1.96 * se_range,
  ci_up = meta_bm_est + 1.96 * se_range
)

# plot(seq(0, 30, by = 1) * 1.96, 1/seq(0, 30, by = 1))

estimated_tbl %>%
  mutate(precision = 1/(Est.Error^2)) %>%
  filter(syl_pos == "final") %>%
  ggplot(aes(Estimate, precision)) +
  geom_vline(aes(xintercept = 0), colour = "grey") +
  geom_vline(aes(xintercept = meta_bm_est)) +
  # geom_vline(aes(xintercept = meta_bm_syl_q50), linetype = "dashed") +
  annotate("rect", ymin = -Inf, ymax = Inf, xmin = meta_bm_q2.5, xmax = meta_bm_q97.5, alpha = 0.5, fill = "#a6cee3") +
  geom_point(size = 3) +
  scale_x_continuous(breaks = seq(-25, 150, 25)) +
  labs(
    x = "Difference in vowel duration (ms)",
    shape = "Syllable position"
  ) +
  geom_line(aes(y = y_seq, x = ci_up), data = ci) +
  geom_line(aes(y = y_seq, x = ci_lo), data = ci)
```

```{r funnel-plot-3, include=TRUE, fig.cap = "By-study funnel plot showing the estimate against the estimated error. The vertical thick and dashed lines are the meta-analytical means of the effect in final and penultimate position."}
e.max <- by(estimated_tbl$Est.Error, estimated_tbl$syl_pos, range)[[1]][2]
se_range <- seq(0, e.max, by = 0.1)
ci <- tibble(
  x_seq = se_range,
  ci_lo = meta_bm_est - 1.96 * se_range,
  ci_up = meta_bm_est + 1.96 * se_range
)

estimated_tbl %>%
  filter(syl_pos == "final") %>%
  ggplot(aes(Estimate, Est.Error)) +
  geom_line(aes(y = x_seq, x = ci_up), data = ci) +
  geom_line(aes(y = x_seq, x = ci_lo), data = ci) +
  geom_vline(aes(xintercept = 0), colour = "grey") +
  geom_vline(aes(xintercept = meta_bm_est)) +
  # geom_vline(aes(xintercept = meta_bm_syl_q50), linetype = "dashed") +
  annotate("rect", ymin = -Inf, ymax = Inf, xmin = meta_bm_q2.5, xmax = meta_bm_q97.5, alpha = 0.5, fill = "#a6cee3") +
  geom_point(size = 3) +
  # annotate("polygon", x = c(meta_bm_est - 1.96 * 50, meta_bm_est + 1.96 * 50, meta_bm_est + 1.96 * 0, meta_bm_est - 1.96 * 0), y = c(50, 50, 0, 0), alpha = 0.2, fill = "orange") +
  scale_x_continuous(breaks = seq(-25, 150, 25)) +
  labs(
    x = "Difference in vowel duration (ms)",
    shape = "Syllable position"
  ) +
  scale_y_reverse()
```

```{r fixed}
meta_bm_4_fixed <- tidy(meta_bm_4, effects = "fixed", conf.level = 0.95, fix.intercept = FALSE) %>%
  mutate(
    ci_width = abs(conf.low - conf.high),
    is_rope = ifelse(ci_width <= 20, "*", "")
  )
meta_bm_4_fixed
```

```{r sensitivity}
meta_bm_4_fixed %>%
  mutate(
    theta = c(0, 0),
    sigma_prior = c(100, 50),
    z = abs((estimate - theta) / std.error), # it's called here std.error but is the standard deviation
    s = 1 - (std.error^2 / sigma_prior^2)
  ) %>%
  ggplot(aes(s, z, label = term)) +
  geom_point() +
  geom_text() +
  xlim(0, 1) +
  ylim(0, 10)
```

## Alternative model

```{r est}
est <- estimated_v_tbl %>%
  mutate(voicing = "voiceless") %>%
  bind_rows(estimated_tbl %>% mutate(voicing = "voiced", Estimate = Estimate + estimated_v_tbl$Estimate)) %>%
  mutate(voicing = factor(voicing, levels = c("voiceless", "voiced")))
```

```{r ver}
priors <- c(
  prior(normal(0, 200), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicingvoiced),
  prior(normal(0, 50), class = b, coef = syl_posnonMfinal),
  prior(normal(0, 50), class = b, coef = `voicingvoiced:syl_posnonMfinal`),
  prior(cauchy(0, 25), class = sd)
)

ver_bm <- brm(
  Estimate | se(`Est.Error`) ~ voicing * syl_pos + (1 + voicing| study),
  data = est,
  prior = priors,
  control = list(adapt_delta = 0.999),
  seed = 9899,
  file = "./english-ve-meta/data/cache/ver_bm"
)

summary(ver_bm)
```

# Meta-analysis of unstressed vowels

## Reduced vowels

WARNING: The models with measurement error should have standard error, not standard deviation. Need to refit.

```{r unstr-priors}
get_prior(
  v_duration | se(sd) ~ voice + place + (1| speaker),
  data = unstressed_red,
  family = gaussian()
)
```

```{r unstr-bm}
priors <- c(
  set_prior("normal(50, 25)", class = "Intercept"),
  set_prior("normal(0, 20)", class = "b", coef = "voicevoiced"),
  set_prior("normal(0, 20)", class = "b", coef = "placealveolar"),
  set_prior("normal(0, 20)", class = "b", coef = "placevelar"),
  set_prior("normal(0, 25)", class = "sd")
)

unstr_bm <- brm(
  v_duration | se(sd) ~ voice + place + (1| speaker),
  data = unstressed_red,
  family = gaussian(),
  prior = priors,
  cores = 4,
  seed = 1989,
  control = list(adapt_delta = 0.99),
  file = "./english-ve-meta/data/cache/unstr_bm"
)
```

```{r unstr-bm-summary}
summary(unstr_bm, prob = 0.9)
```

```{r unstr-bm-pp}
brms::pp_check(unstr_bm, nsamples = 100)
```

```{r unstr-bm-intervals}
mcmc_intervals(as.array(unstr_bm), regex_pars = "b_")
```

```{r unstr-bm-intervals-2}
mcmc_intervals(as.array(unstr_bm), pars = c("b_voicevoiced", "b_placealveolar", "b_placevelar"))
```

```{r unstr-bm-areas}
mcmc_areas(as.array(unstr_bm), pars = c("b_voicevoiced", "b_placealveolar", "b_placevelar"))
```

## Unreduced vowels

```{r unred-priors}
get_prior(
  v_duration | se(sd) ~ voice + place + (1| speaker),
  data = unstressed_unr,
  family = gaussian()
)
```

```{r unred-bm}
priors_unr <- c(
  set_prior("normal(70, 25)", class = "Intercept"),
  set_prior("normal(0, 20)", class = "b", coef = "voicevoiced"),
  set_prior("normal(0, 20)", class = "b", coef = "placealveolar"),
  set_prior("normal(0, 20)", class = "b", coef = "placevelar"),
  set_prior("normal(0, 25)", class = "sd")
)

unred_bm <- brm(
  v_duration | se(sd) ~ voice + place + (1| speaker),
  data = unstressed_unr,
  family = gaussian(),
  prior = priors_unr,
  cores = 4,
  seed = 9891,
  control = list(adapt_delta = 0.9999),
  file = "./english-ve-meta/data/cache/unred_bm"
)
```

```{r unred-bm-summary}
summary(unred_bm, prob = 0.9)
```

```{r unred-bm-areas}
mcmc_areas(as.array(unred_bm), pars = c("b_voicevoiced", "b_placealveolar", "b_placevelar"))
```

# Voicing Effect Ratio

```{r heffner1937}
h37 <- filter(stressed, study == "heffner1937")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(cauchy(0, 3), class = sigma)
)

h37_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = h37,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/h37_l_bm"
)
```

```{r housefairbanks1953}
hf53 <- filter(stressed, study == "housefairbanks1953")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(cauchy(0, 3), class = sigma)
)

hf53_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = hf53,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/hf53_l_bm"
)
```

```{r zimmerman1958}
z58 <- filter(stressed, study == "zimmerman1958")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(cauchy(0, 3), class = sigma)
)

z58_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = z58,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/z58_l_bm"
)
```

```{r petersonlehiste1960}
pl60 <- filter(stressed, study == "petersonlehiste1960")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(cauchy(0, 3), class = sigma)
)

pl60_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = pl60,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/pl60_l_bm"
)
```

```{r sharf1962}
s62_di <- filter(stressed, study == "sharf1962_di")
s62_mono <- filter(stressed, study == "sharf1962_mono")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(cauchy(0, 3), class = sigma)
)

s62_di_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = s62_di,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/s62_di_l_bm"
)

s62_mono_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = s62_mono,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/s62_mono_l_bm"
)
```

```{r chen1970}
c70 <- filter(stressed, study == "chen1970")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(cauchy(0, 3), class = sigma)
)

c70_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = c70,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/c70_l_bm"
)
```

```{r klatt1973}
k73_di <- filter(stressed, study == "klatt1973_di")
k73_mono <- filter(stressed, study == "klatt1973_mono")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(cauchy(0, 3), class = sigma)
)

k73_di_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = k73_di,
  prior = priors,
  seed = 9899,
  iter = 4000,
  file = "./english-ve-meta/data/cache/k73_di_l_bm",
  control = list(adapt_delta = 0.999)
)

k73_mono_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = k73_mono,
  prior = priors,
  seed = 9899,
  iter = 4000,
  file = "./english-ve-meta/data/cache/k73_mono_l_bm",
  control = list(adapt_delta = 0.999)
)
```

```{r port1981}
p81_di <- filter(stressed, study == "port1981_di")
p81_mono <- filter(stressed, study == "port1981_mono")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b)
)

p81_di_l_bm <- brm(
  log(v_duration) | se(log(sd)) ~
    voice,
  data = p81_di,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/p81_di_l_bm"
)

p81_mono_l_bm <- brm(
  log(v_duration) | se(log(sd)) ~
    voice,
  data = p81_mono,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/p81_mono_l_bm"
)
```

```{r mack1982}
m82 <- filter(stressed, study == "mack1982")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(cauchy(0, 3), class = sigma)
)

m82_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = m82,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/m82_l_bm"
)
```

```{r luce1985}
l85_medial <- filter(stressed, study == "luce1985_medial")
l85_final <- filter(stressed, study == "luce1985_final")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b)
)

l85_medial_l_bm <- brm(
  log(v_duration) | se(log(sd)) ~
    voice,
  data = l85_medial,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/l85_medial_l_bm"
)

l85_final_l_bm <- brm(
  log(v_duration) | se(log(sd)) ~
    voice,
  data = l85_final,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/l85_final_l_bm"
)
```

```{r davis1989}
d89 <- filter(stressed, study == "davis1989")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b)
)

d89_l_bm <- brm(
  log(v_duration) | se(log(sd)) ~
    voice,
  data = d89,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/d89_l_bm"
)
```

```{r laeufer1992}
l92 <- filter(stressed, study == "laeufer1992")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(cauchy(0, 3), class = sigma)
)

l92_l_bm <- brm(
  log(v_duration) ~
    voice,
  data = l92,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/l92_l_bm"
)
```

```{r ko2018}
k18 <- filter(stressed, study == "ko2018")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b)
)

k18_l_bm <- brm(
  log(v_duration) | se(log(sd)) ~
    voice,
  data = k18,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/k18_l_bm"
)
```

```{r coretta2019}
eng_durations_di <- filter(eng_durations, num_syl == "di")
eng_durations_mono <- filter(eng_durations, num_syl == "mono")

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  set_prior("cauchy(0, 3)", class = "sd"),
  set_prior("lkj(2)", class = "cor"),
  set_prior("cauchy(0, 3)", class = "sigma")
)

c19_di_l_bm <- brm(
  log(v1_duration) ~
    voicing +
    speech_rate_c +
    (1 + voicing | speaker) +
    (1 | word),
  family = gaussian(),
  data = eng_durations_di,
  prior = priors,
  file = "./english-ve-meta/data/cache/c19_di_l_bm"
)

priors <- c(
  prior(normal(0, 2.5), class = Intercept),
  prior(normal(0, 0.5), class = b),
  set_prior("cauchy(0, 3)", class = "sd"),
  set_prior("lkj(2)", class = "cor"),
  set_prior("cauchy(0, 3)", class = "sigma")
)

c19_mono_l_bm <- brm(
  log(v1_duration) ~
    voicing +
    speech_rate_c +
    (1 + voicing | speaker) +
    (1 | word),
  family = gaussian(),
  data = eng_durations_mono,
  prior = priors,
  file = "./english-ve-meta/data/cache/c19_mono_l_bm"
)
```

```{r estimated-l}
estimated_l <- list()

# These are in allpahbetical order so that joining below does not complain
# about different levels
estimated_l[["chen1970"]] <- fixef(c70_l_bm)["voicevoiced",]
estimated_l[["coretta2019_di"]] <- fixef(c19_di_l_bm)["voicingvoiced",]
estimated_l[["coretta2019_mono"]] <- fixef(c19_mono_l_bm)["voicingvoiced",]
estimated_l[["davis1989"]] <- fixef(d89_l_bm)["voicevoiced",]
estimated_l[["heffner1937"]] <- fixef(h37_l_bm)["voicevoiced",]
estimated_l[["housefairbanks1953"]] <- fixef(hf53_l_bm)["voicevoiced",]
estimated_l[["klatt1973_di"]] <- fixef(k73_di_l_bm)["voicevoiced",]
estimated_l[["klatt1973_mono"]] <- fixef(k73_mono_l_bm)["voicevoiced",]
estimated_l[["ko2018"]] <- fixef(k18_l_bm)["voicevoiced",]
estimated_l[["laeufer1992"]] <- fixef(l92_l_bm)["voicevoiced",]
estimated_l[["luce1985_final"]] <- fixef(l85_final_l_bm)["voicevoiced",]
estimated_l[["luce1985_medial"]] <- fixef(l85_medial_l_bm)["voicevoiced",]
estimated_l[["mack1982"]] <- fixef(m82_l_bm)["voicevoiced",]
estimated_l[["petersonlehiste1960"]] <- fixef(pl60_l_bm)["voicevoiced",]
estimated_l[["port1981_di"]] <- fixef(p81_di_l_bm)["voicevoiced",]
estimated_l[["port1981_mono"]] <- fixef(p81_mono_l_bm)["voicevoiced",]
estimated_l[["sharf1962_di"]] <- fixef(s62_di_l_bm)["voicevoiced",]
estimated_l[["sharf1962_mono"]] <- fixef(s62_mono_l_bm)["voicevoiced",]
estimated_l[["zimmerman1958"]] <- fixef(z58_l_bm)["voicevoiced",]

estimated_l_tbl <- plyr::ldply(estimated_l, .id = "study") %>%
  mutate(
    source = factor("original", levels = c("original", "meta-analysis")),
    study = factor(study)
  ) %>%
  left_join(y = studies)
```

```{r estimated_v}
estimated_v_l <- list()

estimated_v_l[["chen1970"]] <- fixef(c70_l_bm)["Intercept",]
estimated_v_l[["coretta2019_di"]] <- fixef(c19_di_l_bm)["Intercept",]
estimated_v_l[["coretta2019_mono"]] <- fixef(c19_mono_l_bm)["Intercept",]
estimated_v_l[["davis1989"]] <- fixef(d89_l_bm)["Intercept",]
estimated_v_l[["heffner1937"]] <- fixef(h37_l_bm)["Intercept",]
estimated_v_l[["housefairbanks1953"]] <- fixef(hf53_l_bm)["Intercept",]
estimated_v_l[["klatt1973_di"]] <- fixef(k73_di_l_bm)["Intercept",]
estimated_v_l[["klatt1973_mono"]] <- fixef(k73_mono_l_bm)["Intercept",]
estimated_v_l[["ko2018"]] <- fixef(k18_l_bm)["Intercept",]
estimated_v_l[["laeufer1992"]] <- fixef(l92_l_bm)["Intercept",]
estimated_v_l[["luce1985_final"]] <- fixef(l85_final_l_bm)["Intercept",]
estimated_v_l[["luce1985_medial"]] <- fixef(l85_medial_l_bm)["Intercept",]
estimated_v_l[["mack1982"]] <- fixef(m82_l_bm)["Intercept",]
estimated_v_l[["petersonlehiste1960"]] <- fixef(pl60_l_bm)["Intercept",]
estimated_v_l[["port1981_di"]] <- fixef(p81_di_l_bm)["Intercept",]
estimated_v_l[["port1981_mono"]] <- fixef(p81_mono_l_bm)["Intercept",]
estimated_v_l[["sharf1962_di"]] <- fixef(s62_di_l_bm)["Intercept",]
estimated_v_l[["sharf1962_mono"]] <- fixef(s62_mono_l_bm)["Intercept",]
estimated_v_l[["zimmerman1958"]] <- fixef(z58_l_bm)["Intercept",]

estimated_v_l_tbl <- plyr::ldply(estimated_v_l, .id = "study") %>%
  mutate(
    source = factor("original", levels = c("original", "meta-analysis")),
    study = factor(study)
  ) %>%
  left_join(y = studies)
```

```{r meta-l-bm}
priors <- c(
  prior(normal(0, 0.5), class = Intercept),
  prior(normal(0, 0.5), class = b, coef = syl_posnonMfinal),
  prior(cauchy(0, 3), class = sd)
)

meta_l_bm <- brm(
  Estimate | se(`Est.Error`) ~ syl_pos + (1 | study),
  data = estimated_l_tbl,
  prior = priors,
  control = list(adapt_delta = 0.999),
  seed = 9899,
  file = "./english-ve-meta/data/cache/meta_l_bm"
)

summary(meta_l_bm)

```

```{r post-l}
post_l <- (c(posterior_samples(meta_l_bm, pars = "b_Intercept")) +
  posterior_samples(meta_l_bm, pars = "b_syl_posnonMfinal")) %>%
  bind_cols(posterior_samples(meta_l_bm, pars = "b_Intercept")) %>%
  gather("coef", "posterior")
```

```{r l-plot}
post_l %>%
  mutate(posterior = exp(posterior)) %>%
  ggplot(aes(posterior, fill = coef)) +
  geom_vline(aes(xintercept = 1)) +
  geom_density(colour = NA, alpha = 0.8) +
  scale_fill_brewer(
    type = "qual", palette = "Paired",
    labels = c("final", "non-final")
  ) +
  labs(
    title = "Meta-analytical posterior distributions of the voicing effect",
    x = "Difference in vowel duration (ms)",
    fill = "Syllable position",
    y = element_blank()
  ) +
  theme(legend.position = "top")
```

```{r l-shrunk}
# Code adapted from Nicenboim et al. 2018

# We need this since the model includes `num_syl`
post_l <- posterior_samples(meta_l_bm, pars = "b_syl_posnonMfinal")

l_shrunk <- (c(posterior_samples(meta_l_bm, pars = "b_Intercept")) +
  posterior_samples(meta_l_bm, pars = "r_study")) %>%
  bind_cols(post_l) %>%
  # The following mutate sums the random coefficients of the studies with
  # `num_syl` == "non-final" to the posterior samples of the non_syl term
  mutate(
    `r_study[davis1989,Intercept]` = `r_study[davis1989,Intercept]` + b_syl_posnonMfinal,
    `r_study[sharf1962_di,Intercept]` = `r_study[sharf1962_di,Intercept]` + b_syl_posnonMfinal,
    `r_study[klatt1973_di,Intercept]` = `r_study[klatt1973_di,Intercept]` + b_syl_posnonMfinal,
    `r_study[coretta2019_di,Intercept]` = `r_study[coretta2019_di,Intercept]` + b_syl_posnonMfinal,
    `r_study[port1981_di,Intercept]` = `r_study[port1981_di,Intercept]` + b_syl_posnonMfinal,
  ) %>%
  select(-b_syl_posnonMfinal) %>%
  summarise_all(list(~list(c(
    mean(.),
    quantile(., probs = c(.025, 0.975)),
    sd(.)
  )))) %>%
  unnest() %>%
  transpose() %>%
  setNames(c("Estimate", "Q2.5", "Q97.5", "Est.Error")) %>%
  map_df(unlist) %>%
  mutate(
    study = estimated_l_tbl$study,
    source = factor("meta-analysis", levels = c("original", "meta-analysis"))
  ) %>%
  left_join(y = studies)
```

```{r origin-shrunk-l-plot, include=TRUE, fig.cap = "Estimated voicing effect from the original source and from the meta-analysis.", out.extra = "width=\\textwidth"}
bind_rows(estimated_l_tbl, l_shrunk) %>%
  mutate(Estimate = exp(Estimate), Q2.5 = exp(Q2.5), Q97.5 = exp(Q97.5)) %>%
  mutate(source = factor(source, levels = c("meta-analysis", "original"))) %>%
  ggplot(aes(reorder(study_ref, Estimate), Estimate, colour = source, linetype = syl_pos)) +
  geom_hline(aes(yintercept = 1), colour = "grey") +
  scale_x_discrete() +
  # annotate("rect", xmin = 5.5, xmax = Inf, ymin = meta_bm_q2.5, ymax = meta_bm_q97.5, alpha = 0.5, fill = "#a6cee3") +
  # annotate("rect", xmin = -Inf, xmax = 5.5, ymin = meta_bm_syl_q2.5, ymax = meta_bm_syl_q97.5, alpha = 0.5, fill = "#1f78b4") +
  geom_point(size = 2, position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = Q2.5, ymax = Q97.5), width = 0, position = position_dodge(width = 0.8)) +
  scale_color_brewer(type = "qual", palette = "Dark2", breaks = c("original", "meta-analysis")) +
  # scale_y_continuous(breaks = c(-100, -50, 0, 50, 100, 150, 200)) +
  scale_linetype_discrete(labels = c("final", "penultimate")) +
  labs(
    caption = "The shaded areas indicate the 95% CI of the meta-analytical posterior\nof the voicing effect in final (light blue) and penultimate (dark blue) position.",
    y = "Vocing effect ratio",
    x = "Study",
    linetype = "Syllable position",
    colour = "Source"
  ) +
  coord_flip() +
  theme(panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank())
```

## Exclude studies with estimation issues

The following studies are not included here due to issues with estimation of the effect: Davis 1989, Klatt 1973, Ko 2018, Luce 1985, Port 1981.

```{r estimated-l-2}
estimated_l_2 <- list()

# These are in allpahbetical order so that joining below does not complain
# about different levels
estimated_l_2[["chen1970"]] <- fixef(c70_l_bm)["voicevoiced",]
estimated_l_2[["coretta2019_di"]] <- fixef(c19_di_l_bm)["voicingvoiced",]
estimated_l_2[["coretta2019_mono"]] <- fixef(c19_mono_l_bm)["voicingvoiced",]
# estimated_l_2[["davis1989"]] <- fixef(d89_l_bm)["voicevoiced",]
estimated_l_2[["heffner1937"]] <- fixef(h37_l_bm)["voicevoiced",]
estimated_l_2[["housefairbanks1953"]] <- fixef(hf53_l_bm)["voicevoiced",]
# estimated_l_2[["klatt1973_di"]] <- fixef(k73_di_l_bm)["voicevoiced",]
# estimated_l_2[["klatt1973_mono"]] <- fixef(k73_mono_l_bm)["voicevoiced",]
# estimated_l_2[["ko2018"]] <- fixef(k18_l_bm)["voicevoiced",]
estimated_l_2[["laeufer1992"]] <- fixef(l92_l_bm)["voicevoiced",]
# estimated_l_2[["luce1985_final"]] <- fixef(l85_final_l_bm)["voicevoiced",]
# estimated_l_2[["luce1985_medial"]] <- fixef(l85_medial_l_bm)["voicevoiced",]
estimated_l_2[["mack1982"]] <- fixef(m82_l_bm)["voicevoiced",]
estimated_l_2[["petersonlehiste1960"]] <- fixef(pl60_l_bm)["voicevoiced",]
# estimated_l_2[["port1981_di"]] <- fixef(p81_di_l_bm)["voicevoiced",]
# estimated_l_2[["port1981_mono"]] <- fixef(p81_mono_l_bm)["voicevoiced",]
estimated_l_2[["sharf1962_di"]] <- fixef(s62_di_l_bm)["voicevoiced",]
estimated_l_2[["sharf1962_mono"]] <- fixef(s62_mono_l_bm)["voicevoiced",]
estimated_l_2[["zimmerman1958"]] <- fixef(z58_l_bm)["voicevoiced",]

estimated_l_2_tbl <- plyr::ldply(estimated_l_2, .id = "study") %>%
  mutate(
    source = factor("original", levels = c("original", "meta-analysis")),
    study = factor(study)
  ) %>%
  left_join(y = studies)
```

```{r meta-l-bm-2}
priors <- c(
  prior(normal(0, 0.5), class = Intercept),
  prior(normal(0, 0.5), class = b, coef = syl_posnonMfinal),
  prior(cauchy(0, 3), class = sd)
)

meta_l_bm_2 <- brm(
  Estimate | se(`Est.Error`) ~ syl_pos + (1 | study),
  data = estimated_l_2_tbl,
  prior = priors,
  control = list(adapt_delta = 0.999),
  seed = 9899,
  file = "./english-ve-meta/data/cache/meta_l_bm_2"
)

summary(meta_l_bm_2)

meta_bm_2_est <- fixef(meta_l_bm_2)["Intercept","Estimate"]
meta_bm_2_q2.5 <- fixef(meta_l_bm_2)["Intercept","Q2.5"]
meta_bm_2_q97.5 <- fixef(meta_l_bm_2)["Intercept","Q97.5"]

post_nonfi_2 <- (c(posterior_samples(meta_l_bm_2, pars = "b_Intercept")) +
  posterior_samples(meta_l_bm_2, pars = "b_syl_posnonMfinal"))

meta_bm_2_syl_q2.5 <- quantile(post_nonfi_2$b_syl_posnonMfinal, c(0.025))
meta_bm_2_syl_q97.5 <- quantile(post_nonfi_2$b_syl_posnonMfinal, c(0.975))
meta_bm_2_syl_q50 <- (meta_bm_2_syl_q2.5 + meta_bm_2_syl_q97.5) / 2
```

```{r l-shrunk-2}
# Code adapted from Nicenboim et al. 2018

# We need this since the model includes `num_syl`
post_l_2 <- posterior_samples(meta_l_bm_2, pars = "b_syl_posnonMfinal")

l_shrunk_2 <- (c(posterior_samples(meta_l_bm_2, pars = "b_Intercept")) +
  posterior_samples(meta_l_bm_2, pars = "r_study")) %>%
  bind_cols(post_l_2) %>%
  # The following mutate sums the random coefficients of the studies with
  # `num_syl` == "non-final" to the posterior samples of the non_syl term
  mutate(
    `r_study[sharf1962_di,Intercept]` = `r_study[sharf1962_di,Intercept]` + b_syl_posnonMfinal,
    `r_study[coretta2019_di,Intercept]` = `r_study[coretta2019_di,Intercept]` + b_syl_posnonMfinal,
  ) %>%
  select(-b_syl_posnonMfinal) %>%
  summarise_all(list(~list(c(
    mean(.),
    quantile(., probs = c(.025, 0.975)),
    sd(.)
  )))) %>%
  unnest() %>%
  transpose() %>%
  setNames(c("Estimate", "Q2.5", "Q97.5", "Est.Error")) %>%
  map_df(unlist) %>%
  mutate(
    study = c("chen1970", "coretta2019_di", "coretta2019_mono", "heffner1937", "housefairbanks1953", "laeufer1992", "mack1982", "petersonlehiste1960", "sharf1962_di", "sharf1962_mono", "zimmerman1958"),
    source = factor("meta-analysis", levels = c("original", "meta-analysis"))
  ) %>%
  left_join(y = studies)
```

```{r origin-shrunk-l-plot-2, include=TRUE, fig.cap = "Estimated voicing effect ratio from the original source and from the meta-analysis.", out.extra = "width=\\textwidth"}
bind_rows(estimated_l_2_tbl, l_shrunk_2) %>%
  mutate(Estimate = exp(Estimate), Q2.5 = exp(Q2.5), Q97.5 = exp(Q97.5)) %>%
  mutate(source = factor(source, levels = c("meta-analysis", "original"))) %>%
  ggplot(aes(reorder(study_ref, Estimate), Estimate, colour = source, linetype = syl_pos)) +
  geom_hline(aes(yintercept = 1), colour = "grey") +
  scale_x_discrete() +
  annotate("rect", xmin = 2.5, xmax = Inf, ymin = exp(meta_bm_2_q2.5), ymax = exp(meta_bm_2_q97.5), alpha = 0.5, fill = "#a6cee3") +
  annotate("rect", xmin = -Inf, xmax = 2.5, ymin = exp(meta_bm_2_syl_q2.5), ymax = exp(meta_bm_2_syl_q97.5), alpha = 0.5, fill = "#1f78b4") +
  geom_point(size = 2, position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = Q2.5, ymax = Q97.5), width = 0, position = position_dodge(width = 0.8)) +
  scale_color_brewer(type = "qual", palette = "Dark2", breaks = c("original", "meta-analysis")) +
  scale_y_continuous(breaks = seq(-0.5, 2.5, 0.25)) +
  scale_linetype_discrete(labels = c("final", "penultimate")) +
  labs(
    caption = "The shaded areas indicate the 95% CI of the meta-analytical posterior\nof the voicing effect ratio in final (light blue) and penultimate (dark blue) position.",
    y = "Vocing effect ratio",
    x = "Study",
    linetype = "Syllable position",
    colour = "Source"
  ) +
  coord_flip() +
  theme(panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank())
```
