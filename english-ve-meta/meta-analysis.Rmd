---
title: "Meta-analysis of the voicing effect in English"
author: "Stefano Coretta"
date: "07/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../"))
library(tidyverse)
theme_set(theme_minimal())
library(brms)
library(bayesplot)
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
options(mc.cores = parallel::detectCores())
```

```{r data, message=FALSE}
stressed <- read_csv("./english-ve-meta/stressed.csv") %>%
  mutate_if(is.character, as.factor) %>%
  mutate(
    voice = factor(voice, levels = c("voiceless", "voiced")),
    n_syl = factor(n_syl, levels = c("mono", "di"))
  )

unstressed <- read_csv("./english-ve-meta/unstressed.csv") %>%
  gather("voice_stat", "value", voiced_mean:voiceless_sd) %>%
  separate(voice_stat, c("voice", "stat")) %>%
  spread(stat, value) %>%
  rename(v_duration =  "mean") %>%
  mutate(
    voice = factor(voice, levels = c("voiceless", "voiced")),
    speaker = as.factor(speaker),
    place = factor(place, levels = c("labial", "alveolar", "velar"))
  )

unstressed_red <- filter(unstressed, v_context == "reduced")
unstressed_unr <- filter(unstressed, v_context == "unreduced")
```

# Obtain estimates from previous studies

```{r heffner1937}
h37 <- filter(stressed, study == "heffner1937")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

h37_bm <- brm(
  v_duration ~
    voice,
  data = h37,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/h37_bm"
)
```

```{r housefairbanks1953}
hf53 <- filter(stressed, study == "housefairbanks1953")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

hf53_bm <- brm(
  v_duration ~
    voice,
  data = hf53,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/hf53_bm"
)
```

```{r petersonlehiste1960}
pl60 <- filter(stressed, study == "petersonlehiste1960")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

pl60_bm <- brm(
  v_duration ~
    voice,
  data = pl60,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/pl60_bm"
)
```

```{r sharf1962}
s62 <- filter(stressed, study == "sharf1962")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

s62_bm <- brm(
  v_duration ~
    voice,
  data = s62,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/s62_bm"
)
```

```{r chen1970}
c70 <- filter(stressed, study == "chen1970")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

c70_bm <- brm(
  v_duration ~
    voice,
  data = c70,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/c70_bm"
)
```

```{r klatt1973}
k73 <- filter(stressed, study == "klatt1973")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

k73_bm <- brm(
  v_duration ~
    voice,
  data = k73,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/k73_bm"
)
```

```{r davis1989}
d89 <- filter(stressed, study == "davis1989")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced)
)

d89_bm <- brm(
  v_duration | se(sd) ~
    voice,
  data = d89,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/d89_bm"
)
```

```{r laeufer1992}
l92 <- filter(stressed, study == "laeufer1992")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced),
  prior(cauchy(0, 25), class = sigma)
)

l92_bm <- brm(
  v_duration ~
    voice,
  data = l92,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/l92_bm"
)
```

```{r ko2018}
k18 <- filter(stressed, study == "ko2018")

priors <- c(
  prior(normal(0, 300), class = Intercept),
  prior(normal(0, 100), class = b, coef = voicevoiced)
)

k18_bm <- brm(
  v_duration | se(sd) ~
    voice,
  data = k18,
  prior = priors,
  seed = 9899,
  file = "./english-ve-meta/data/cache/k18_bm"
)
```

```{r estimated}
estimated <- list()

estimated[["h37"]] <- fixef(h37_bm)["voicevoiced",]
estimated[["hf53"]] <- fixef(hf53_bm)["voicevoiced",]
estimated[["pl60"]] <- fixef(pl60_bm)["voicevoiced",]
estimated[["s62"]] <- fixef(s62_bm)["voicevoiced",]
estimated[["c70"]] <- fixef(c70_bm)["voicevoiced",]
estimated[["k73"]] <- fixef(k73_bm)["voicevoiced",]
estimated[["d89"]] <- fixef(d89_bm)["voicevoiced",]
estimated[["l92"]] <- fixef(l92_bm)["voicevoiced",]
estimated[["k18"]] <- fixef(k18_bm)["voicevoiced",]

estimated_tbl <- plyr::ldply(estimated, .id = "study")
```

```{r estimated_v}
estimated_v <- list()

estimated_v[["h37"]] <- fixef(h37_bm)["Intercept",]
estimated_v[["hf53"]] <- fixef(hf53_bm)["Intercept",]
estimated_v[["pl60"]] <- fixef(pl60_bm)["Intercept",]
estimated_v[["s62"]] <- fixef(s62_bm)["Intercept",]
estimated_v[["c70"]] <- fixef(c70_bm)["Intercept",]
estimated_v[["k73"]] <- fixef(k73_bm)["Intercept",]
estimated_v[["d89"]] <- fixef(d89_bm)["Intercept",]
estimated_v[["l92"]] <- fixef(l92_bm)["Intercept",]
estimated_v[["k18"]] <- fixef(k18_bm)["Intercept",]

estimated_v_tbl <- plyr::ldply(estimated_v, .id = "study")
```

# Meta-analysis

```{r meta-bm}
priors <- c(
  prior(normal(0, 100), class = Intercept),
  prior(cauchy(0, 25), class = sd)
)

meta_bm <- brm(
  Estimate | se(`Est.Error`) ~ (1 | study),
  data = estimated_tbl,
  prior = priors,
  control = list(adapt_delta = 0.999),
  seed = 9899,
  file = "./english-ve-meta/data/cache/meta_bm"
)

summary(meta_bm)
```

```{r meta-bm-2}
priors <- c(
  prior(normal(0, 100), class = Intercept),
  prior(cauchy(0, 25), class = sd)
)

meta_bm_2 <- brm(
  Estimate | se(`Est.Error`) ~ (1 | study),
  data = filter(estimated_tbl, study != "c70"),
  prior = priors,
  control = list(adapt_delta = 0.999),
  seed = 9899,
  file = "./english-ve-meta/data/cache/meta_bm_2"
)
```

```{r}
get_prior(v_duration ~ voice * n_syl + word_pos + (1|study), data = stressed)
```

```{r}
priors <- c(
  set_prior("normal(200, 100)", class = "Intercept"),
  set_prior("normal(0, 50)", class = "b", coef = "n_syldi"),
  set_prior("normal(100, 50)", class = "b", coef = "voicevoiced"),
  set_prior("normal(0, 50)", class = "b", coef = "voicevoiced:n_syldi"),
  set_prior("normal(0, 100)", class = "b", coef = "word_posisolation"),
  set_prior("normal(0, 100)", class = "b", coef = "word_posmean"),
  set_prior("normal(0, 100)", class = "b", coef = "word_posmedial"),
  set_prior("normal(0, 50)", class = "sd"),
  set_prior("cauchy(0, 50)", class = "sigma")
)

ve_brm <- brm(
  v_duration ~
    voice *
    n_syl +
    word_pos +
    (1|study),
  data = stressed,
  prior = priors,
  cores = 4,
  seed = 9899
)
```

```{r}
summary(ve_brm)
```

```{r}
brms::pp_check(ve_brm, nsamples = 100)
```

```{r}
mcmc_trace(as.array(ve_brm), pars = "b_voicevoiced")
```

```{r}
mcmc_intervals(as.array(ve_brm), regex_pars = "b_")
```

```{r}
mcmc_areas(as.array(ve_brm), regex_pars = "b_")
```

# Estimate of voicing effect in unstressed vowels

```{r unstr-priors}
get_prior(
  v_duration | se(sd) ~ voice + place + (1| speaker),
  data = unstressed_red,
  family = gaussian()
)
```

```{r unstr-bm}
priors <- c(
  set_prior("normal(50, 25)", class = "Intercept"),
  set_prior("normal(0, 20)", class = "b", coef = "voicevoiced"),
  set_prior("normal(0, 20)", class = "b", coef = "placealveolar"),
  set_prior("normal(0, 20)", class = "b", coef = "placevelar"),
  set_prior("normal(0, 25)", class = "sd")
)

unstr_bm <- brm(
  v_duration | se(sd, sigma = TRUE) ~ voice + place + (1| speaker),
  data = unstressed_red,
  family = gaussian(),
  prior = priors,
  cores = 4,
  seed = 1989,
  control = list(adapt_delta = 0.99)
)
```

```{r unstr-bm-summary}
summary(unstr_bm, prob = 0.9)
```

```{r unstr-bm-pp}
brms::pp_check(unstr_bm, nsamples = 100)
```

```{r unstr-bm-intervals}
mcmc_intervals(as.array(unstr_bm), regex_pars = "b_")
```

```{r unstr-bm-intervals-2}
mcmc_intervals(as.array(unstr_bm), pars = c("b_voicevoiced", "b_placealveolar", "b_placevelar"))
```

```{r unstr-bm-areas}
mcmc_areas(as.array(unstr_bm), pars = c("b_voicevoiced", "b_placealveolar", "b_placevelar"))
```

```{r unred-priors}
get_prior(
  v_duration | se(sd) ~ voice + place + (1| speaker),
  data = unstressed_unr,
  family = gaussian()
)
```

```{r unred-bm}
priors_unr <- c(
  set_prior("normal(70, 25)", class = "Intercept"),
  set_prior("normal(0, 20)", class = "b", coef = "voicevoiced"),
  set_prior("normal(0, 20)", class = "b", coef = "placealveolar"),
  set_prior("normal(0, 20)", class = "b", coef = "placevelar"),
  set_prior("normal(0, 25)", class = "sd")
)

unred_bm <- brm(
  v_duration | se(sd, sigma = TRUE) ~ voice + place + (1| speaker),
  data = unstressed_unr,
  family = gaussian(),
  prior = priors_unr,
  cores = 4,
  seed = 9891,
  control = list(adapt_delta = 0.9999)
)
```

```{r unred-bm-summary}
summary(unred_bm, prob = 0.9)
```

```{r unred-bm-areas}
mcmc_areas(as.array(unred_bm), pars = c("b_voicevoiced", "b_placealveolar", "b_placevelar"))
```
