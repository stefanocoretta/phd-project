---
title: "3D tongue"
author: "Stefano Coretta"
date: "12/10/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../"))
library(tidyverse)
library(mgcv)
library(akima)
```

```{r data, message=FALSE}
read_tongue <- function(file) {
  tibble <- read_csv(file, col_names = c("X", "Y", "Z")) %>%
    mutate(file = substr(file, 26, 42))
  
  tibble <- mutate(tibble, index = seq(1, nrow(tibble)))
  
  return(tibble)
}

stimuli <- read_csv("italian-sz/data/stimuli.csv")

tongue <- list.files(
  path = "italian-sz/data/datasets",
  pattern = "*.csv",
  full.names = TRUE
) %>%
  map_df(~read_tongue(.)) %>%
  left_join(y = stimuli) %>%
  mutate(phone = ordered(phone, levels = c("s", "z"))) %>%
  mutate_if(is.character, as.factor)

contrasts(tongue$phone) <- "contr.treatment"
```

```{r gam}
tongue_gam <- bam(
  Z ~
    s(X, Y),
  data = tongue
)
```

```{r gam-plot, warning=FALSE}
vis.gam(tongue_gam, theta = -35, phi = 40, scale = FALSE, xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), color = "terrain")
```

```{r gam_2}
tongue_gam_2 <- bam(
  Z ~
    s(X, Y, by = phone),
  data = tongue
)
```

```{r gam-2-plot, warning=FALSE}
vis.gam(tongue_gam_2, theta = -35, phi = 40, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain")
vis.gam(tongue_gam_2, theta = -35, phi = 40, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain")
```

```{r gam-2-plot, warning=FALSE}
vis.gam(tongue_gam_2, theta = -35, phi = 40, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", se = 1.96)
vis.gam(tongue_gam_2, theta = -35, phi = 40, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", se = 1.96)
```

```{r gam_3}
tongue_gam_3 <- bam(
  Z ~
    phone +
    s(X, Y) +
    s(X, Y, by = phone),
  data = tongue
)
```

```{r gam-3-plot, warning=FALSE}
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", too.far = .01)
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", too.far = .01)
```

```{r gam-3-plot, warning=FALSE}
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", se = 1.96, too.far = .01)
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", se = 1.96, too.far = .01)
```

```{r gam-3-plot-2, warning=FALSE}
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -90, phi = 0, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", too.far = .01)
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -90, phi = 0, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", too.far = .01)
```

```{r gam-3-plot-2, warning=FALSE}
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = 90, phi = 0, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", too.far = .01)
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = 90, phi = 0, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", too.far = .01)
```

```{r}
x_min <- 1.8
x_max <- 11.8
y_min <- 3.6
y_max <- 9.9

grid <- expand.grid(X = seq(x_min, x_max, length = 100), Y = seq(y_min, y_max, length = 100), phone = c("s", "z"), file = levels(tongue$file))

predicted <- predict(tongue_gam_3, newdata = grid)
predicted_df <- cbind(grid, predicted) %>%
  dplyr::select(-file) %>%
  unique() %>%
  spread(phone, predicted) %>%
  mutate(
    difference = s - z
  )

sum_diff <- sum(predicted_df$difference)
volume_diff <- sum_diff * (x_max - x_min)/100 * (y_max - y_min)/100
cat("The volume increase for [z] over [s] is", round(volume_diff, 2), "cm^3 (= ml)")
```

```{r}
interp_data <- interp(tongue$X, tongue$Y, tongue$Z, xo = seq(x_min, x_max, length = 100), yo = seq(y_min, y_max, length = 100), duplicate = "mean")

interp_m <- interp_data$z
interp_m <- ifelse(!is.na(interp_m), 1, 0)

predicted_df_2 <- predicted_df
predicted_df_2$mask <- as.vector(t(interp_m))

predicted_df_2 <- predicted_df_2 %>%
  mutate(diff_2 = difference * mask)

sum_diff_2 <- sum(predicted_df_2$diff_2)
volume_diff_2 <- sum_diff_2 * (x_max - x_min)/100 * (y_max - y_min)/100
cat("The volume increase for [z] over [s] is", round(volume_diff_2, 2), "cm^3 (= ml)")
```

