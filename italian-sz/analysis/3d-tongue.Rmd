---
title: "3D tongue"
author: "Stefano Coretta"
date: "12/10/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../"))
library(tidyverse)
theme_set(theme_minimal())
library(mgcv)
library(itsadug)
library(tidymv)
library(akima)
library(TTR)
library(plotly)
```

# Read data

```{r data, message=FALSE}
read_tongue <- function(file) {
  tibble <- read_csv(file, col_names = c("X", "Y", "Z")) %>%
    mutate(file = substr(file, 26, 42))
  
  tibble <- mutate(tibble, index = seq(1, nrow(tibble)))
  
  return(tibble)
}

stimuli <- read_csv("italian-sz/data/stimuli.csv")

tongue <- list.files(
  path = "italian-sz/data/datasets",
  pattern = "*.csv",
  full.names = TRUE
) %>%
  map_df(~read_tongue(.)) %>%
  left_join(y = stimuli) %>%
  mutate(phone = ordered(phone, levels = c("s", "z"))) %>%
  mutate_if(is.character, as.factor) %>%
  create_event_start("file")

contrasts(tongue$phone) <- "contr.treatment"
```

# 3D tongue modelling with GAMs

## Tongue GAM

```{r tongue-gam, eval=FALSE}
tongue_gam <- bam(
  Z ~
    s(X, Y),
  data = tongue
)
```

```{r tongue-gam-plot, warning=FALSE, eval=FALSE}
vis.gam(tongue_gam, theta = -35, phi = 40, scale = FALSE, xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), color = "terrain")
```

## Tongue GAM 2

```{r tongue-gam_2, eval=FALSE}
tongue_gam_2 <- bam(
  Z ~
    s(X, Y, by = phone),
  data = tongue
)
```

```{r tongue-gam-2-plot, warning=FALSE, eval=FALSE}
vis.gam(tongue_gam_2, theta = -35, phi = 40, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain")
vis.gam(tongue_gam_2, theta = -35, phi = 40, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain")
```

```{r tongue-gam-2-plot-2, warning=FALSE, eval=FALSE}
vis.gam(tongue_gam_2, theta = -35, phi = 40, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", se = 1.96)
vis.gam(tongue_gam_2, theta = -35, phi = 40, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", se = 1.96)
```

## Tongue GAM 3

```{r tongue-gam_3}
tongue_gam_3 <- bam(
  Z ~
    phone +
    s(X, Y) +
    s(X, Y, by = phone),
  data = tongue
)
```

```{r tongue-gam-3-plot, warning=FALSE, eval=FALSE}
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", too.far = .01)
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", too.far = .01)
```

```{r tongue-gam-3-plot-2, warning=FALSE, eval=FALSE}
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", se = 1.96, too.far = .01)
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", se = 1.96, too.far = .01)
```

```{r tongue-gam-3-plot-3, warning=FALSE, eval=FALSE}
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -90, phi = 0, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", too.far = .01)
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = -90, phi = 0, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", too.far = .01)
```

```{r tongue-gam-3-plot-4, warning=FALSE, eval=FALSE}
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = 90, phi = 0, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", too.far = .01)
vis.gam(tongue_gam_3, view = c("X", "Y"), theta = 90, phi = 0, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", too.far = .01)
```

## Tongue GAM with AR1

```{r gam-ar}
rho <- start_value_rho(tongue_gam_3)

gam_ar <- bam(
  Z ~
    phone +
    s(X, Y) +
    s(X, Y, by = phone),
  data = tongue,
  AR.start = tongue$start.event,
  rho = rho
)
```

```{r gam-ar-acf-plot}
acf_resid(gam_ar, split_pred = "AR.start")
```

```{r gam-ar-plot, warning=FALSE}
vis.gam(gam_ar, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", too.far = .05)
vis.gam(gam_ar, view = c("X", "Y"), theta = -35, phi = 50, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", too.far = .05)
```

```{r gam-ar-plot-2, warning=FALSE}
vis.gam(gam_ar, view = c("X", "Y"), theta = 0, phi = 50, scale = FALSE, cond = list(phone = "s"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[s]", color = "terrain", too.far = .05)
vis.gam(gam_ar, view = c("X", "Y"), theta = 0, phi = 50, scale = FALSE, cond = list(phone = "z"), ticktype = "detailed", xlim = c(1, 13), ylim = c(3, 10), zlim = c(3, 8), main = "[z]", color = "terrain", too.far = .05)
```

# Volume increase

```{r volume-increase}
x_min <- 1.8
x_max <- 11.8
y_min <- 3.6
y_max <- 9.9

grid <- expand.grid(X = seq(x_min, x_max, length = 100), Y = seq(y_min, y_max, length = 100), file = levels(tongue$file))
grid <- cbind(grid, phone = rep(rep(c("s", "z"), each = 10000), 5))

predicted <- predict(gam_ar, newdata = grid)
predicted_df <- cbind(grid, predicted) %>%
  dplyr::select(-file) %>%
  unique() %>%
  spread(phone, predicted) %>%
  mutate(
    difference = s - z
  )

sum_diff <- sum(predicted_df$difference)
volume_diff <- sum_diff * (x_max - x_min)/100 * (y_max - y_min)/100
cat("The volume increase for [z] over [s] is", round(volume_diff, 2), "cm^3 (= ml)")
```

```{r masked-volume-increase}
interp_data <- interp(tongue$X, tongue$Y, tongue$Z, xo = seq(x_min, x_max, length = 100), yo = seq(y_min, y_max, length = 100), duplicate = "mean")

interp_m <- interp_data$z
interp_m <- ifelse(!is.na(interp_m), 1, 0)

predicted_df_2 <- predicted_df
predicted_df_2$mask <- as.vector(t(interp_m))

predicted_df_2 <- predicted_df_2 %>%
  mutate(diff_2 = difference * mask)

sum_diff_2 <- sum(predicted_df_2$diff_2)
volume_diff_2 <- sum_diff_2 * (x_max - x_min)/100 * (y_max - y_min)/100
cat("The volume increase for [z] over [s] is", round(volume_diff_2, 2), "cm^3 (= ml)")
```

# Token variation

```{r prep-token-variation}
files_interp <- NULL

for (file in 1:length(levels(tongue$file))) {
  file_data <- tongue[tongue$file == levels(tongue$file)[file],]
  
  file_interp_data <- interp(file_data$X, file_data$Y, file_data$Z, xo = seq(x_min, x_max, length = 100), yo = seq(y_min, y_max, length = 100))
  
  files_interp <- c(files_interp, as.vector(t(file_interp_data$z)))
}

tongue_interp <- cbind(grid, interp = files_interp) %>%
  group_by(phone, X, Y) %>%
  summarise(min = min(interp, na.rm = TRUE), max = max(interp, na.rm = TRUE)) %>%
  mutate(
    min = ifelse(min == Inf, NA, min),
    max = ifelse(max == -Inf, NA, max)
  )

s_interp <- filter(tongue_interp, phone == "s")
s_min_m <- matrix(s_interp$min, 100, 100)

z_interp <- filter(tongue_interp, phone == "s")
z_max_m <- matrix(z_interp$max, 100, 100)

color <- rep(0, length(s_min_m))
dim(color) <- dim(s_min_m)

color2 <- rep(1, length(z_max_m))
dim(color2) <- dim(z_max_m)
```

```{r plot-min-max}
plot_ly(colors = c("black", "orange")) %>%
  add_surface(
    z = ~s_min_m,
    surfacecolor = color,
    cauto = F,
    cmax = 1,
    cmin = 0,
    opacity = 0.8
  ) %>%
  add_surface(
    z = ~z_max_m,
    surfacecolor = color2,
    cauto = F,
    cmax = 1,
    cmin = 0,
    opacity = 0.8
  ) %>%
  layout(scene = list(aspectmode = "manual", aspectratio = list(x = 0.6, y = 1, z = 0.5)))
```

# Midsagittal

```{r prep-midsaggital}
midsagittal <- cbind(grid, interp = files_interp) %>%
  filter(X > 6.8 & X < 6.9) %>%
  na.omit() %>%
  group_by(file) %>%
  mutate(smoothed = WMA(interp)) # smoothed with a weighted moving
```


```{r contours, warning=FALSE}
ggplot(midsagittal, aes(Y, interp, colour = phone, group = file)) +
  geom_path()
```

```{r smoothed-contours, warning=FALSE}
ggplot(midsagittal, aes(Y, smoothed, colour = phone, group = file)) +
  geom_path()
```

```{r contour-smooths, warning=FALSE}
ggplot(midsagittal, aes(Y, interp, colour = phone)) +
  geom_smooth(method = "loess")
```
