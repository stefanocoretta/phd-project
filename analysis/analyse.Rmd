---
title: "Tidying data for spline plotting and SSANOVA"
author: "Stefano Coretta"
date: "27/12/2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir=normalizePath("../"))
library(tidyr)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(gss)
```

Before importing the data, we need to specify the column names for the data set header, since the raw data does not have a header. The number of splines is always 42 (saved as `num.splines`). `first.columns` is a factor containing the names of columns that are not the splines coordinates columns. Finally, we can concatenate `first.columns` with the names of the splines coordinates which is generated by the `paste0` function in the format `X_1, Y_1, X_2, Y_2, X_n, ...` (the underscore `_` will be useful for separating the axis from the fan number).

```{r}
num.splines = 42
first.columns <- c(
    "subject",
    "seconds",
    "rec.date",
    "prompt",
    "label",
    "TD.displacement",
    "TT.displacement",
    "TD.displacement.sm",
    "TD.velocity",
    "TD.velocity.abs",
    "TT.displacement.sm",
    "TT.velocity",
    "TT.velocity.abs"
    )
columns <- c(first.columns,
             paste0(rep(c("X", "Y"), num.splines), "_", rep(1:num.splines, each = 2))
             )
```

We can now read in the file.

```{r}
raw.data <- read.delim("pilot/results/SC01_export.txt", header = FALSE,
                    na.string = '*', col.names = columns
                    )

raw.data <- unique(raw.data)
```

The following code applies tidy formatting to the data frame. It uses functions from the `tidyr` library.

```{r}
splines <- raw.data %>%
    gather(spline, coordinate, X_1:Y_42) %>%
    separate(spline, c("axis", "fan"), convert = TRUE) %>%
    spread(axis, coordinate)
```

This is a plotting example.

```{r, eval=FALSE, include=FALSE}
ggplot(splines, aes(x = X, y = Y, group=prompt)) + stat_smooth(size=1) +
    geom_smooth(se=FALSE) + coord_fixed(ratio = 1)
```

```{r}
gestures <- raw.data %>%
    select(subject:label) %>%
    separate(label, c("gesture", "tongue")) %>%
    spread(gesture, seconds) %>%
    select(subject:tongue, target, max, release)
```

```{r}
degg <- read.csv("pilot/results/SC01_degg_tracing.csv", na.strings="--undefined--")

degg <- left_join(degg, nonce)

ggplot(degg, aes(x = time, group = c2phonation, colour = c2phonation)) + 
    geom_smooth(aes(y = maximum)) +
    geom_smooth(aes(y = minimum)) +
    ylab("period") + xlim(-0.1,0) + ylim(0, 1)

ggplot(degg, aes(x = time, group = c2phonation, colour = c2phonation)) + 
    geom_point(aes(y = maximum), alpha = 0.5) +
    geom_point(aes(y = minimum), alpha = 0.5) +
    ylab("period") + xlim(-0.1,0) + ylim(0, 1)

degg.a <- filter(degg, vowel == "a")

maximum.model <- ssanova(maximum ~ c2phonation + time + c2phonation:time, 
                         data = degg.a)
minimum.model <- ssanova(minimum ~ c2phonation + time + c2phonation:time, 
                         data = degg.a)

grid <- select(degg.a, time, c2phonation)

grid$maximum.fit <- predict(maximum.model, grid, se = T)$fit
grid$maximum.SE <- predict(maximum.model, grid, se = T)$se.fit
grid$minimum.fit <- predict(minimum.model, grid, se = T)$fit
grid$minimum.SE <- predict(minimum.model, grid, se = T)$se.fit


ggplot(grid, aes(x = time, colour = c2phonation, group = c2phonation)) +
    geom_line(aes(y = maximum.fit), alpha = 1, colour = "grey20") +
    geom_line(aes(y = minimum.fit), alpha = 1, colour = "grey20") +
    geom_ribbon(aes(ymin = maximum.fit-(1.96*maximum.SE), ymax = maximum.fit+(1.96*maximum.SE),fill = c2phonation ),alpha = 0.5,colour = "NA") +
    geom_ribbon(aes(ymin = minimum.fit-(1.96*minimum.SE), ymax = minimum.fit+(1.96*minimum.SE),fill = c2phonation ),alpha = 0.5,colour = "NA") +
    xlim(-0.1,0)

eff <- ggplot(grid, aes(x = time))
eff <- eff + geom_line(aes(y = maximum.fit))
eff <- eff + geom_ribbon(aes(ymax = maximum.fit+(1.96*maximum.SE),ymin = maximum.fit-(1.96*maximum.SE)),alpha = 0.5)
eff <- eff + facet_wrap(~ c2phonation)
eff <- eff + geom_hline(yintercept = 0, lty = 2)
eff <- eff + ylab("Difference in Hz")
print(eff)
```
