---
title: "Spline plotting and SSANOVA"
author: "Stefano Coretta"
date: "27/12/2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir=normalizePath("../"))
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(gss)
library(stringr)
```

# Data import

Before importing the data, we need to specify the column names for the data set header, since the raw data does not have a header. The number of splines is always 42 (saved as `num.splines`). `first.columns` is a factor containing the names of columns that are not the splines coordinates columns. Finally, we can concatenate `first.columns` with the names of the splines coordinates which is generated by the `paste0` function in the format `X_1, Y_1, X_2, Y_2, X_n, ...` (the underscore `_` will be useful for separating the axis from the fan number).

```{r col-names}
num.splines <- 42
first.columns <- c(
    "speaker",
    "seconds",
    "rec.date",
    "prompt",
    "label",
    "TT.displacement.sm",
    "TT.velocity",
    "TT.velocity.abs",
    "TD.displacement.sm",
    "TD.velocity",
    "TD.velocity.abs"
    )
columns <- c(first.columns,
             paste0(rep(c("X", "Y"), num.splines),
                    "_",
                    rep(1:num.splines, each = 2)
                    )
             )
```

We can now read in the file.

```{r read}
splines.raw <- list.files(path = "pilot/results",
                   pattern = "*-aaa.txt",
                   full.names = TRUE) %>%
    map_df(~read_tsv(., col_names = columns, na = "*"))

rm(num.splines, first.columns, columns)

languages <- read_csv("./pilot/stimuli/languages.csv")
words <- read_csv("./pilot/stimuli/nonce.csv")
```

The following code applies tidy formatting to the data frame. It uses functions from the `tidyr` library.

```{r tidy}
splines <- splines.raw %>%
    gather(spline, coordinate, matches("[XY]_")) %>%
    separate(spline, c("axis", "fan"), convert = TRUE) %>%
    spread(axis, coordinate) %>%
    mutate(word = word(prompt, 2)) %>%
    left_join(y = languages) %>%
    left_join(y = words) %>%
    mutate_if(is.character, as.factor)

splines.it <- filter(splines, language == "italian")
splines.pl <- filter(splines, language == "polish")
```

# Some plotting

We can finally plot splines.

```{r velar, eval=FALSE}
filter(splines, label == "max_TD") %>%
ggplot(aes(x = X, y = Y, colour = c2phonation)) +
    geom_smooth(method = "loess") +
    coord_fixed(ratio = 1)
```

```{r coronal, eval=FALSE}
filter(splines, label == "max_TT") %>%
ggplot(aes(x = X, y = Y, colour = c2phonation)) +
    geom_smooth(method = "loess") +
    coord_fixed(ratio = 1)
```

# SSANOVA
```{r ssanova}
splines.cor <- filter(splines.it, label == "max_TT")
splines.cor.model <- ssanova(Y ~ c2phonation + X + c2phonation:X,
                             data = splines.cor)

splines.vel <- filter(splines.it, label == "max_TD")
splines.vel.model <- ssanova(Y ~ c2phonation + X + c2phonation:X,
                             data = splines.vel)

predicted.cor <- expand.grid(X = seq(min(splines.cor$X, na.rm = TRUE), max(splines.cor$X,
                                                                           na.rm = TRUE),
                                     length = 100),
                             Y = seq(min(splines.cor$Y, na.rm = TRUE), max(splines.cor$Y,
                                                                           na.rm = TRUE),
                                     length = 100),
                             c2phonation = c("voiced", "voiceless")
                            )
predicted.vel <- expand.grid(X = seq(min(splines.vel$X, na.rm = TRUE), max(splines.vel$X,
                                                                           na.rm = TRUE),
                                     length = 100),
                             Y = seq(min(splines.vel$Y, na.rm = TRUE), max(splines.vel$Y,
                                                                           na.rm = TRUE),
                                     length = 100),
                             c2phonation = c("voiced", "voiceless")
                            )

predicted.cor$splines.fit <- predict(splines.cor.model, predicted.cor,
                                     se = T)$fit
predicted.cor$splines.SE <- predict(splines.cor.model, predicted.cor,
                                    se = T)$se.fit

predicted.vel$splines.fit <- predict(splines.vel.model, predicted.vel,
                                     se = T)$fit
predicted.vel$splines.SE <- predict(splines.vel.model, predicted.vel,
                                    se = T)$se.fit
```

```{r ssanova-cor-plot}
ggplot(predicted.cor, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )
```

```{r ssanova-vel-plot}
ggplot(predicted.vel, aes(x = X, colour = c2phonation)) +
geom_line(aes(y = splines.fit)) +
geom_ribbon(aes(ymin = splines.fit - (1.96 * splines.SE),
                ymax = splines.fit + (1.96 * splines.SE),
                fill = c2phonation
                ),
            alpha = 0.5,
            color = "NA"
            )
```

# Consonantal gestures: target, maximum, release

Now we can create a separate data frame where the observasional unit is each word and the variables are the consonantal getures (target, maximum closure, release).

```{r gestures}
cons.gestures <- raw.data %>%
    select(subject:label) %>%
    separate(label, c("gesture", "tongue.area")) %>%
    spread(gesture, seconds) %>%
    select(subject:tongue.area, GONS, NONS, max, NOFF, GOFF) %>%
    mutate(word = as.factor(word(prompt, 2))) %>%
    left_join(y = stimuli)
```

Let's plot closure duration as a function of place of articulation and voicing of C2 (our target consonant in C1VC2V words).

```{r closure-duration, eval = FALSE}
ggplot(cons.gestures, aes(c2phonation, closure)) +
    facet_grid(.~c2place) +
    geom_violin() +
    geom_boxplot(width=0.1) +
    ylim(15, 60) +
    theme(strip.background = element_rect(fill = "black"),
          strip.text = element_text(color = "white", face = "bold")
          )
```









