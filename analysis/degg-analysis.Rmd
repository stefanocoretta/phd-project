---
title: "dEGG tracing and SSANOVA"
author: "Stefano Coretta"
date: "11/01/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir=normalizePath("../"))
library(tidyr)
library(tidyverse)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(gss)
library(stringr)
```

## Data import

Import all `degg-tracing` files in the `results` folder in the `degg` data frame, and reads `nonce.csv` as `stimuli` which contains phonological details about the stimuli. Then join `degg` with `stimuli`. Finally, filter data points which `position == "before"` (dEGG points before consonant closure). For now, I am filtering to get data from `SC01` only because there are problems with consonantal gestures detection for `SDC02` and this screws everything up.

```{r import}
degg <- list.files(path = "pilot/results",
                   pattern = "*-degg-tracing.csv",
                   full.names = TRUE) %>%
    map_df(~read_csv(.))

languages <- read_csv("./pilot/stimuli/languages.csv")
words <- read_csv("./pilot/stimuli/nonce.csv")

degg <- left_join(degg, languages) %>%
    left_join(y = words) %>%
    mutate_if(is.character, as.factor)

degg.it <- filter(degg, language == "italian")
degg.pl <- filter(degg, language == "polish")
```

Let's first have a look at the tracegrams.

```{r tracegram}
ggplot(degg, aes(x = time, colour = c2phonation)) +
    facet_grid(. ~ language) +
    geom_smooth(aes(y = maximum), size = 0.5, alpha = 0.2) +
    geom_smooth(aes(y = minimum), size = 0.5, alpha = 0.2) +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period")
```

# SSANOVA for Italian

We can now calculate the SSANOVA model for dEGG maxima and minima.

```{r ssanova}
maximum.model <- ssanova(maximum ~ c2phonation + time + c2phonation:time,
data = degg.it)

minimum.model <- ssanova(minimum ~ c2phonation + time + c2phonation:time,
data = degg.it)
```

And calculate the predicted splines based on the SSANOVA models.

```{r predict}
predicted.degg <- expand.grid(time = seq(min(degg.it$time), max(degg.it$time), length = 100),
                    c2phonation = c("voiced", "voiceless"))

predicted.degg$maximum.fit <- predict(maximum.model, predicted.degg, se = TRUE)$fit
predicted.degg$maximum.SE <- predict(maximum.model, predicted.degg, se = TRUE)$se.fit
predicted.degg$minimum.fit <- predict(minimum.model, predicted.degg, se = TRUE)$fit
predicted.degg$minimum.SE <- predict(minimum.model, predicted.degg, se = TRUE)$se.fit
```

Finally, we can plot the predicted splines for Italian with 95% confidence levels for significance evaluation.

```{r ssanova-plot}
ggplot(predicted.degg, aes(x = time, colour = c2phonation, group = c2phonation)) +
    geom_line(aes(y = maximum.fit), alpha = 1, colour = "grey20") +
    geom_ribbon(aes(ymin = maximum.fit-(1.96*maximum.SE),
                ymax = maximum.fit+(1.96*maximum.SE),
                fill = c2phonation ),alpha = 0.5,colour = "NA") +
    geom_line(aes(y = minimum.fit), alpha = 1, colour = "grey20") +
    geom_ribbon(aes(ymin = minimum.fit-(1.96*minimum.SE),
                    ymax = minimum.fit+(1.96*minimum.SE),
                    fill = c2phonation ),alpha = 0.5,colour = "NA") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period")
```

# SSANOVA for Polish

```{r ssanova}
maximum.model <- ssanova(maximum ~ c2phonation + time + c2phonation:time,
data = degg.pl)

minimum.model <- ssanova(minimum ~ c2phonation + time + c2phonation:time,
data = degg.pl)
```

And calculate the predicted splines based on the SSANOVA models.

```{r predict}
predicted.degg <- expand.grid(time = seq(min(degg.pl$time), max(degg.pl$time), length = 100),
                    c2phonation = c("voiced", "voiceless"))

predicted.degg$maximum.fit <- predict(maximum.model, predicted.degg, se = TRUE)$fit
predicted.degg$maximum.SE <- predict(maximum.model, predicted.degg, se = TRUE)$se.fit
predicted.degg$minimum.fit <- predict(minimum.model, predicted.degg, se = TRUE)$fit
predicted.degg$minimum.SE <- predict(minimum.model, predicted.degg, se = TRUE)$se.fit
```

Finally, we can plot the predicted splines for Polish with 95% confidence levels for significance evaluation.

```{r ssanova-plot}
ggplot(predicted.degg, aes(x = time, colour = c2phonation, group = c2phonation)) +
    geom_line(aes(y = maximum.fit), alpha = 1, colour = "grey20") +
    geom_ribbon(aes(ymin = maximum.fit-(1.96*maximum.SE),
                ymax = maximum.fit+(1.96*maximum.SE),
                fill = c2phonation ),alpha = 0.5,colour = "NA") +
    geom_line(aes(y = minimum.fit), alpha = 1, colour = "grey20") +
    geom_ribbon(aes(ymin = minimum.fit-(1.96*minimum.SE),
                    ymax = minimum.fit+(1.96*minimum.SE),
                    fill = c2phonation ),alpha = 0.5,colour = "NA") +
    xlab("relative time (proportion of vowel duration)") +
    ylab("proportion of glottal period")
```
