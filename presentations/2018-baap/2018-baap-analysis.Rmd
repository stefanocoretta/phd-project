---
title: "2018 BAAP analysis"
author: "Stefano Coretta"
date: "05/03/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../"))
library(tidyverse)
theme_set(theme_minimal())
library(mgcv)
library(tidymv)
library(rticulate)
options(contrasts = rep("contr.sum", 2))
```

# Data import

```{r read-data}
columns <- c(
  "speaker",
  "seconds",
  "rec_date",
  "prompt",
  "label",
  "TT_displacement_sm",
  "TT_velocity",
  "TT_velocity_abs",
  "TD_displacement_sm",
  "TD_velocity",
  "TD_velocity_abs"
)

speakers <- read_csv("./voicing-effect/data/datasets/speakers.csv")
stimuli <- read_csv("./voicing-effect/data/datasets/stimuli.csv")

splines <- list.files(
  path = "./presentations/2018-baap/datasets/ultrasound",
  pattern = "*-tongue-cart.tsv",
  full.names = TRUE
) %>%
  map_df(~read_aaa(., columns)) %>%
  mutate(word = word(prompt, 2)) %>%
  left_join(y = speakers) %>%
  left_join(y = stimuli) %>%
  mutate(
    c2phonation = ordered(c2phonation, levels = c("voiceless", "voiced")),
    vowel = ordered(vowel, levels = c("a", "o", "u")),
    c2place = ordered(c2place, levels = c("coronal", "velar")),
    vow_phon = as.ordered(interaction(vowel, c2phonation)),
    c2place_phon = as.ordered(interaction(c2place, c2phonation))
  ) %>%
  mutate_if(is.character, as.factor)

vowels <- list.files(
  path = "./presentations/2018-baap/datasets/acoustics/",
  pattern = "*-durations.csv",
  full.names = TRUE
) %>%
  map_df(~read_csv(., na = "--undefined--")) %>%
  left_join(y = speakers) %>%
  left_join(y = stimuli) %>%
  mutate(c2phonation = factor(c2phonation, levels = c("voiceless", "voiced"))) %>%
  mutate_if(is.character, as.factor)
```

# Exploratory

## Ultrasound

```{r it-coronal-tongue}
splines %>%
  filter(
    language == "italian",
    label == "max_TT"
  ) %>%
  ggplot(aes(X, Y, colour = c2phonation)) +
  geom_point(size = 0.5) +
  facet_grid(vowel ~ speaker) +
  coord_fixed(ratio = 1) +
  theme(legend.position = "top")
```

```{r it-velar-tongue}
splines %>%
  filter(
    language == "italian",
    label == "max_TD"
  ) %>%
  ggplot(aes(X, Y, colour = c2phonation)) +
  geom_point(size = 0.5) +
  facet_grid(vowel ~ speaker) +
  coord_fixed(ratio = 1) +
  theme(legend.position = "top")
```

```{r pl-coronal-tongue}
splines %>%
  filter(
    language == "polish",
    label == "max_TT"
  ) %>%
  ggplot(aes(X, Y, colour = c2phonation)) +
  geom_point(size = 0.5) +
  facet_grid(vowel ~ speaker) +
  coord_fixed(ratio = 1) +
  theme(legend.position = "top")
```

```{r pl-velar-tongue}
splines %>%
  filter(
    language == "polish",
    label == "max_TD"
  ) %>%
  ggplot(aes(X, Y, colour = c2phonation)) +
  geom_point(size = 0.5) +
  facet_grid(vowel ~ speaker) +
  coord_fixed(ratio = 1) +
  theme(legend.position = "top")
```

## Vowel duration

```{r vowdur-dens}
vowels %>%
  ggplot(aes(vowel.duration, fill = c2phonation, colour = c2phonation)) +
  geom_density(alpha = 0.2) +
  facet_grid(~ language)
```

```{r vowdur-dens}
vowels %>%
  group_by(speaker) %>%
  mutate(vowel_duration = scale(vowel.duration)) %>%
  ggplot(aes(vowel_duration, fill = c2phonation, colour = c2phonation)) +
  geom_density(alpha = 0.2) +
  facet_grid(~ language)
```

```{r vowdur-box}
vowels %>%
  ggplot(aes(c2phonation, vowel.duration)) +
  geom_boxplot() +
  facet_grid(~ language)
```

```{r vowdur-norm}
vowels %>%
  group_by(speaker) %>%
  mutate(vowel_duration = scale(vowel.duration)) %>%
  ggplot(aes(c2phonation, vowel_duration)) +
  geom_boxplot() +
  facet_grid(~ language)
```

```{r vowdur-norm-vowels}
vowels %>%
  group_by(speaker) %>%
  mutate(vowel_duration = scale(vowel.duration)) %>%
  ggplot(aes(vowel, vowel_duration, fill = c2phonation)) +
  geom_boxplot() +
  facet_grid(~ language)
```

```{r it-vowdur-norm-vowels}
vowels %>%
  filter(language == "italian") %>%
  group_by(speaker) %>%
  mutate(vowel_duration = scale(vowel.duration)) %>%
  ggplot(aes(vowel, vowel_duration, fill = c2phonation)) +
  geom_boxplot() +
  facet_wrap(~ speaker, ncol = 2)
```

```{r pl-vowdur-norm-vowels}
vowels %>%
  filter(language == "polish") %>%
  group_by(speaker) %>%
  mutate(vowel_duration = scale(vowel.duration)) %>%
  ggplot(aes(vowel, vowel_duration, fill = c2phonation)) +
  geom_boxplot() +
  facet_wrap(~ speaker, ncol = 2)
```

# Polar GAMs

## Italian

```{r it01}
it01 <- filter(splines, speaker == "it01", label %in% c("max_TT", "max_TD"))
```

```{r it01-polar-gam}
it01_polar_gam <- polar_gam(
  Y ~
    c2phonation +
    vowel +
    c2place +
    vow_phon +
    c2place_phon +
    s(X, by = c2phonation, bs = "cr") +
    s(X, by = vowel, bs = "cr") +
    s(X, by = c2place, bs = "cr") +
    s(X, by = vow_phon, bs = "cr") +
    s(X, by = c2place_phon, bs = "cr") +
    s(X, rec_date, bs = "fs", xt = "cr", m = 1),
  data = it01
)
summary(it01_polar_gam)
```

```{r}
plot_polar_smooths(
  it01_polar_gam,
  X,
  c2phonation,
  facet_terms = c2place + vowel
)
```

